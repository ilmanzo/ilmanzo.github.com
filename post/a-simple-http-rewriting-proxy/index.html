<!doctype html><html lang=en><head><title>a simple HTTP rewriting proxy &ndash; ilManzo's blog</title><meta name=description content="A minimalist, pragmatic website and personal blog"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://ilmanzo.github.io/css/colour/gruvbox-dark.css><link rel=stylesheet href=https://ilmanzo.github.io/css/colour/dark-mode.css><link rel=stylesheet href=https://ilmanzo.github.io/css/risotto.css><link rel=stylesheet href=https://ilmanzo.github.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://ilmanzo.github.io/ class=page__logo-inner>ilManzo's blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=/curriculum title>Curriculum</a></li><li class=main-nav__item><a class=nav-main-item href=/categories title>Categories</a></li><li class=main-nav__item><a class=nav-main-item href=/tags title>Tags</a></li><li class=main-nav__item><a class="nav-main-item active" href=/post/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>a simple HTTP rewriting proxy</h1></header><div class=content__body><p>This is an example of using <a href=https://github.com/elazarl/goproxy>goproxy</a>, a fast and robust multithread proxy engine to develop an HTTP proxy that rewrites content on the fly, with multiple search and substitutions. It can be useful for debugging and other less noble (but useful) purposes &mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// rewriting_proxy project main.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/elazarl/goproxy&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>replacements</span> = []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>from</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>to</span>   []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}{
</span></span><span style=display:flex><span>	{[]byte(<span style=color:#e6db74>&#34;#e8ecec&#34;</span>), []byte(<span style=color:#e6db74>&#34;Red&#34;</span>)},                       <span style=color:#75715e>// ugly colors!!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	{[]byte(<span style=color:#e6db74>&#34;Comic Sans MS&#34;</span>), []byte(<span style=color:#e6db74>&#34;Lucida Sans Unicode&#34;</span>)}, <span style=color:#75715e>// for eyes sanity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	{[]byte(<span style=color:#e6db74>&#34;Java &#34;</span>), []byte(<span style=color:#e6db74>&#34;Golang &#34;</span>)},                     <span style=color:#75715e>// just joking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>myHandler</span>(<span style=color:#a6e22e>resp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Response</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>goproxy</span>.<span style=color:#a6e22e>ProxyCtx</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Response</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>readBody</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>//TODO handle read error gracefully
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resp</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>replacements</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>readBody</span> = <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>readBody</span>, <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>from</span>, <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>to</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>NopCloser</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>readBody</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resp</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>verbose</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;v&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;should every proxy request be logged to stdout&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>goproxy</span>.<span style=color:#a6e22e>NewProxyHttpServer</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span>.<span style=color:#a6e22e>Verbose</span> = <span style=color:#f92672>*</span><span style=color:#a6e22e>verbose</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span>.<span style=color:#a6e22e>OnResponse</span>().<span style=color:#a6e22e>DoFunc</span>(<span style=color:#a6e22e>myHandler</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8081&#34;</span>, <span style=color:#a6e22e>proxy</span>))
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://ilmanzo.github.io/images/rice.svg alt=Logo><h1 class=about__title>Andrea Manzini</h1><p class=about__description>A minimalist, pragmatic website and personal blog</p></div><ul class=aside__social-links><li><a href=https://github.com/ilmanzo rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:ilmanzo@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://www.linkedin.com/in/andreamanzini rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://twitter.com/ilmanzo rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>By Andrea Manzini,
2016-08-12</p></div></section><footer class=page__footer><p class=copyright>© 2022 Andrea Manzini</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL",{anonymize_ip:!1})}</script></footer></div></body></html>