<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>a simple HTTP rewriting proxy | ilManzo's blog</title>
<meta name=keywords content="go,golang,programming,proxy,http,hacking"><meta name=description content="This is an example of using goproxy, a fast and robust multithread proxy engine to develop an HTTP proxy that rewrites content on the fly, with multiple search and substitutions. It can be useful for debugging and other less noble (but useful) purposes &mldr;
// rewriting_proxy project main.go package main import ( &#34;bytes&#34; &#34;flag&#34; &#34;io/ioutil&#34; &#34;log&#34; &#34;net/http&#34; &#34;github.com/elazarl/goproxy&#34; ) var replacements = []struct { from []byte to []byte }{ {[]byte(&#34;#e8ecec&#34;), []byte(&#34;Red&#34;)}, // ugly colors!"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/a-simple-http-rewriting-proxy/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL",{anonymize_ip:!1})}</script><meta property="og:title" content="a simple HTTP rewriting proxy"><meta property="og:description" content="This is an example of using goproxy, a fast and robust multithread proxy engine to develop an HTTP proxy that rewrites content on the fly, with multiple search and substitutions. It can be useful for debugging and other less noble (but useful) purposes &mldr;
// rewriting_proxy project main.go package main import ( &#34;bytes&#34; &#34;flag&#34; &#34;io/ioutil&#34; &#34;log&#34; &#34;net/http&#34; &#34;github.com/elazarl/goproxy&#34; ) var replacements = []struct { from []byte to []byte }{ {[]byte(&#34;#e8ecec&#34;), []byte(&#34;Red&#34;)}, // ugly colors!"><meta property="og:type" content="article"><meta property="og:url" content="https://ilmanzo.github.io/post/a-simple-http-rewriting-proxy/"><meta property="article:section" content="post"><meta property="article:published_time" content="2016-08-12T00:00:00+00:00"><meta property="article:modified_time" content="2016-08-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="a simple HTTP rewriting proxy"><meta name=twitter:description content="This is an example of using goproxy, a fast and robust multithread proxy engine to develop an HTTP proxy that rewrites content on the fly, with multiple search and substitutions. It can be useful for debugging and other less noble (but useful) purposes &mldr;
// rewriting_proxy project main.go package main import ( &#34;bytes&#34; &#34;flag&#34; &#34;io/ioutil&#34; &#34;log&#34; &#34;net/http&#34; &#34;github.com/elazarl/goproxy&#34; ) var replacements = []struct { from []byte to []byte }{ {[]byte(&#34;#e8ecec&#34;), []byte(&#34;Red&#34;)}, // ugly colors!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"a simple HTTP rewriting proxy","item":"https://ilmanzo.github.io/post/a-simple-http-rewriting-proxy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"a simple HTTP rewriting proxy","name":"a simple HTTP rewriting proxy","description":"This is an example of using goproxy, a fast and robust multithread proxy engine to develop an HTTP proxy that rewrites content on the fly, with multiple search and substitutions. It can be useful for debugging and other less noble (but useful) purposes \u0026hellip;\n// rewriting_proxy project main.go package main import ( \u0026#34;bytes\u0026#34; \u0026#34;flag\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;github.com/elazarl/goproxy\u0026#34; ) var replacements = []struct { from []byte to []byte }{ {[]byte(\u0026#34;#e8ecec\u0026#34;), []byte(\u0026#34;Red\u0026#34;)}, // ugly colors!","keywords":["go","golang","programming","proxy","http","hacking"],"articleBody":"This is an example of using goproxy, a fast and robust multithread proxy engine to develop an HTTP proxy that rewrites content on the fly, with multiple search and substitutions. It can be useful for debugging and other less noble (but useful) purposes …\n// rewriting_proxy project main.go package main import ( \"bytes\" \"flag\" \"io/ioutil\" \"log\" \"net/http\" \"github.com/elazarl/goproxy\" ) var replacements = []struct { from []byte to []byte }{ {[]byte(\"#e8ecec\"), []byte(\"Red\")}, // ugly colors!! {[]byte(\"Comic Sans MS\"), []byte(\"Lucida Sans Unicode\")}, // for eyes sanity {[]byte(\"Java \"), []byte(\"Golang \")}, // just joking } func myHandler(resp *http.Response, ctx *goproxy.ProxyCtx) *http.Response { readBody, err := ioutil.ReadAll(resp.Body) if err != nil { //TODO handle read error gracefully return resp } resp.Body.Close() for _, elem := range replacements { readBody = bytes.Replace(readBody, elem.from, elem.to, -1) } resp.Body = ioutil.NopCloser(bytes.NewReader(readBody)) return resp } func main() { verbose := flag.Bool(\"v\", true, \"should every proxy request be logged to stdout\") proxy := goproxy.NewProxyHttpServer() proxy.Verbose = *verbose proxy.OnResponse().DoFunc(myHandler) log.Fatal(http.ListenAndServe(\":8081\", proxy)) } ","wordCount":"162","inLanguage":"en","datePublished":"2016-08-12T00:00:00Z","dateModified":"2016-08-12T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/a-simple-http-rewriting-proxy/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">a simple HTTP rewriting proxy</h1><div class=post-meta><span title='2016-08-12 00:00:00 +0000 UTC'>August 12, 2016</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><p>This is an example of using <a href=https://github.com/elazarl/goproxy>goproxy</a>, a fast and robust multithread proxy engine to develop an HTTP proxy that rewrites content on the fly, with multiple search and substitutions. It can be useful for debugging and other less noble (but useful) purposes &mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// rewriting_proxy project main.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/elazarl/goproxy&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>replacements</span> = []<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>from</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>to</span>   []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}{
</span></span><span style=display:flex><span>	{[]byte(<span style=color:#e6db74>&#34;#e8ecec&#34;</span>), []byte(<span style=color:#e6db74>&#34;Red&#34;</span>)},                       <span style=color:#75715e>// ugly colors!!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	{[]byte(<span style=color:#e6db74>&#34;Comic Sans MS&#34;</span>), []byte(<span style=color:#e6db74>&#34;Lucida Sans Unicode&#34;</span>)}, <span style=color:#75715e>// for eyes sanity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	{[]byte(<span style=color:#e6db74>&#34;Java &#34;</span>), []byte(<span style=color:#e6db74>&#34;Golang &#34;</span>)},                     <span style=color:#75715e>// just joking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>myHandler</span>(<span style=color:#a6e22e>resp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Response</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>goproxy</span>.<span style=color:#a6e22e>ProxyCtx</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Response</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>readBody</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>//TODO handle read error gracefully
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resp</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>replacements</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>readBody</span> = <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>readBody</span>, <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>from</span>, <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>to</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span> = <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>NopCloser</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>readBody</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resp</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>verbose</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;v&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;should every proxy request be logged to stdout&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>goproxy</span>.<span style=color:#a6e22e>NewProxyHttpServer</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span>.<span style=color:#a6e22e>Verbose</span> = <span style=color:#f92672>*</span><span style=color:#a6e22e>verbose</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span>.<span style=color:#a6e22e>OnResponse</span>().<span style=color:#a6e22e>DoFunc</span>(<span style=color:#a6e22e>myHandler</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8081&#34;</span>, <span style=color:#a6e22e>proxy</span>))
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/go/>go</a></li><li><a href=https://ilmanzo.github.io/tags/golang/>golang</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>programming</a></li><li><a href=https://ilmanzo.github.io/tags/proxy/>proxy</a></li><li><a href=https://ilmanzo.github.io/tags/http/>http</a></li><li><a href=https://ilmanzo.github.io/tags/hacking/>hacking</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/playing-with-crystal-programming-language/><span class=title>« Prev</span><br><span>playing with Crystal Programming Language</span>
</a><a class=next href=https://ilmanzo.github.io/post/wrapping-c-plus-plus-classes-in-python/><span class=title>Next »</span><br><span>wrapping c plus plus classes in Python</span></a></nav></footer></article></main><footer class=footer><span>© 2012-2023 Andrea Manzini</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>