<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Expect the unexpected | ilManzo's blog</title><meta name=keywords content="linux,sysadmin,programming,testing,device,storage"><meta name=description content="How to improve your software by simulating a faulty block device"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/faulty_disk_simulation/><link crossorigin=anonymous href=/assets/css/stylesheet.a090830a421002426baafbd314e38f149d77b4c48a12ee9312700d770b27fb26.css integrity="sha256-oJCDCkIQAkJrqvvTFOOPFJ13tMSKEu6TEnANdwsn+yY=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/faulty_disk_simulation/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL")}</script><meta property="og:url" content="https://ilmanzo.github.io/post/faulty_disk_simulation/"><meta property="og:site_name" content="ilManzo's blog"><meta property="og:title" content="Expect the unexpected"><meta property="og:description" content="How to improve your software by simulating a faulty block device"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-11-19T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-19T00:00:00+00:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Sysadmin"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Testing"><meta property="article:tag" content="Device"><meta property="article:tag" content="Storage"><meta name=twitter:card content="summary"><meta name=twitter:title content="Expect the unexpected"><meta name=twitter:description content="How to improve your software by simulating a faulty block device"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"Expect the unexpected","item":"https://ilmanzo.github.io/post/faulty_disk_simulation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Expect the unexpected","name":"Expect the unexpected","description":"How to improve your software by simulating a faulty block device","keywords":["linux","sysadmin","programming","testing","device","storage"],"articleBody":"‚ÄúYou sound like a broken record‚Äù Is something we complain when someone repeats again and again the same concepts. But even broken disks can sometime be useful\nDISCLAIMER: No filesystem or device were harmed in the making of this experiment üòâ\nImage credits: Mick Haupt\nIn this article I would like to explore the powerful tools we have in Linux to simulate dealing with broken disks, that is, drives that more or less randomly report errors. Why is this important ? Because by simulating errors that will also happen sooner or later in the real world, we are able to create software that is more robust and can withstand any problems on the infrastructure.\nSetup In order not to have troubles in our development system, and to make the process as portable as possible, we start by creating a dummy 1GB disk based on the loop device.\n# dd if=/dev/zero of=/myfakedisk.bin bs=1M count=1024 1024+0 records in 1024+0 records out 1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.446898 s, 2.4 GB/s # losetup /dev/loop0 /myfakedisk.bin Now we can use the loop device just like any other block device: we can create a filesystem and mount it\n# mkfs.ext4 /dev/loop0 mke2fs 1.46.4 (18-Aug-2021) Discarding device blocks: done Creating filesystem with 262144 4k blocks and 65536 inodes Filesystem UUID: bcba505c-54fa-49e5-852c-b5ea3faa53d0 Superblock backups stored on blocks: 32768, 98304, 163840, 229376 Allocating group tables: done Writing inode tables: done Creating journal (8192 blocks): done Writing superblocks and filesystem accounting information: done # mkdir /mnt/good \u0026\u0026 mount /dev/loop0 /mnt/good \u0026\u0026 echo \"test\" \u003e /mnt/good/test.txt \u0026\u0026 umount /mnt/good our working ‚Äúvirtual disk‚Äù is ready, now we can create a faulty one using linux‚Äôs device mapper features.\nWhat‚Äôs device mapper ? Image credits: Monstera Production\nThe Linux Device Mapper is a kernel-level framework that enables the creation of virtual block devices by mapping physical storage devices or logical volumes to these virtual devices. It operates within the Linux kernel, providing a layer for creating, managing, and manipulating storage devices through various mapping techniques such as mirroring, striping, encryption, and snapshots. This framework allows for the implementation of advanced storage features like volume management, RAID, and thin provisioning, offering greater flexibility, scalability, and reliability in managing storage resources within the Linux operating system.\nBasically we are going to create a ‚Äúmap‚Äù between our working device and a ‚Äúnew‚Äù one, with this rough schema:\nfrom sector 0 to 2047, get the data from the underlying device (because we don‚Äôt want to mess with partition table and metadata) from sector 2048 to half disk size, return an error, or the original data, with 20% odds of failure from half size to the end, return again the data from the underlying device Disk size can be found with a simple check:\n# cat /sys/block/loop0/size 2097152 This kind of mapping is expressed in the dmsetup create command:\n# dmsetup create bad_disk \u003c\u003c EOF 0 2048 linear /dev/loop0 0 2048 1047552 flakey /dev/loop0 2048 4 1 1049600 1047552 linear /dev/loop0 1049600 EOF # ls -l /dev/mapper/bad_disk lrwxrwxrwx 1 root root 7 Nov 19 17:51 /dev/mapper/bad_disk -\u003e ../dm-0 For each table entry, we need to specify:\nstart sector/offset of mapping size of the mapping which mapper is being used options of the mapper (for details refer to the documentation) In this setup we are using the linear mapper and the flakey one. Another useful one can be delay to simulate very slow disks or dust that emulates the behavior of bad sectors at arbitrary locations, and the ability to enable the emulation of the failures at an arbitrary time.\nLet‚Äôs try it out Our backing disk is already formatted, so it‚Äôs time to try out the bad one, by mounting and writing some stuff:\n# mkdir /mnt/bad \u0026\u0026 mount /dev/mapper/bad_disk /mnt/bad \u0026\u0026 cd /mnt/bad # df -h | grep -E '(^Filesystem|bad)' Filesystem Size Used Avail Use% Mounted on /dev/mapper/bad_disk 974M 28K 907M 1% /mnt/bad # while sleep 1 ; do dd if=/dev/zero of=trytowrite.bin bs=1M count=500 ; done 500+0 records in 500+0 records out 524288000 bytes (524 MB, 500 MiB) copied, 0.595353 s, 881 MB/s 500+0 records in 500+0 records out 524288000 bytes (524 MB, 500 MiB) copied, 0.637194 s, 823 MB/s Message from syslogd@localhost at Nov 19 18:09:15 ... kernel:[ 8017.117593][T23594] EXT4-fs (dm-0): failed to convert unwritten extents to written extents -- potential data loss! (inode 13, error -30) Message from syslogd@localhost at Nov 19 18:09:15 ... kernel:[ 8017.118445][T23976] EXT4-fs (dm-0): failed to convert unwritten extents to written extents -- potential data loss! (inode 13, error -30) dd: error writing 'trytowrite.bin': Read-only file system 481+0 records in 480+0 records out 503865344 bytes (504 MB, 481 MiB) copied, 0.549939 s, 916 MB/s dd: failed to open 'trytowrite.bin': Read-only file system dd: failed to open 'trytowrite.bin': Read-only file system dd: failed to open 'trytowrite.bin': Read-only file system dd: failed to open 'trytowrite.bin': Read-only file system dd: failed to open 'trytowrite.bin': Read-only file system Disk failure is a success! As we can see, at first some I/O operations succeeds, then the disk fails and in dmesg log we can find more details:\n[ 7962.645178] EXT4-fs (dm-0): error loading journal [ 7979.334186] EXT4-fs (dm-0): mounted filesystem with ordered data mode. Opts: (null). Quota mode: none. [ 8016.759602] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 129024) [ 8016.759641] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 129280) [ 8016.759685] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 129536) [ 8016.759802] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 129870) [ 8016.760119] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 130625) [ 8016.760122] Buffer I/O error on device dm-0, logical block 130625 [ 8016.760129] Buffer I/O error on device dm-0, logical block 130626 [ 8016.760131] Buffer I/O error on device dm-0, logical block 130627 [ 8016.760132] Buffer I/O error on device dm-0, logical block 130628 [ 8016.760133] Buffer I/O error on device dm-0, logical block 130629 [ 8016.760134] Buffer I/O error on device dm-0, logical block 130630 [ 8016.760135] Buffer I/O error on device dm-0, logical block 130631 [ 8016.760136] Buffer I/O error on device dm-0, logical block 130632 [ 8016.760137] Buffer I/O error on device dm-0, logical block 130633 [ 8016.760138] Buffer I/O error on device dm-0, logical block 130634 [ 8016.923667] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 54272) [ 8016.923731] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 54783) [ 8016.924020] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 55296) [ 8016.924335] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 60416) [ 8016.924394] EXT4-fs warning (device dm-0): ext4_end_bio:347: I/O error 10 writing to inode 13 starting block 61803) [ 8016.961108] Buffer I/O error on dev dm-0, logical block 131103, lost sync page write [ 8016.961125] Aborting journal on device dm-0-8. [ 8016.961127] Buffer I/O error on dev dm-0, logical block 131072, lost sync page write [ 8016.961128] JBD2: Error -5 detected when updating journal superblock for dm-0-8. [ 8016.961142] EXT4-fs error (device dm-0): ext4_journal_check_start:83: comm kworker/u2:3: Detected aborted journal [ 8016.966200] EXT4-fs error (device dm-0): ext4_journal_check_start:83: comm dd: Detected aborted journal In a more general sense, these concepts fall under the principle of ‚Äúchaos engineering‚Äù. This can be also a good practice for junior sysadmins that wants to learn how to cope with a damaged filesystem and try to recover data.\nCleanup To remove the tracks of our experiments, it‚Äôs sufficient to unmount the ‚Äúbad‚Äù disk, remove the mapping and unassociate the loop device with the backing file.\n# umount /mnt/bad \u0026\u0026 rmdir /mnt/bad # dmsetup remove bad_disk # losetup -d /dev/loop0 ","wordCount":"1300","inLanguage":"en","datePublished":"2023-11-19T00:00:00Z","dateModified":"2023-11-19T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/faulty_disk_simulation/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Expect the unexpected</h1><div class=post-description>How to improve your software by simulating a faulty block device</div><div class=post-meta><span title='2023-11-19 00:00:00 +0000 UTC'>November 19, 2023</span>&nbsp;¬∑&nbsp;<span>Andrea Manzini</span></div></header><div class=post-content><h2 id=heading><em>&ldquo;You sound like a broken record&rdquo;</em><a hidden class=anchor aria-hidden=true href=#heading>#</a></h2><p>Is something we complain when someone repeats again and again the same concepts. But even broken disks can sometime be useful</p><p>DISCLAIMER: No filesystem or device were harmed in the making of this experiment üòâ</p><p><img alt=broken-record loading=lazy src=/img/pexels-mick-haupt-7663550.jpg>
Image credits: <a href=https://www.pexels.com/@mickhaupt/>Mick Haupt</a></p><p>In this article I would like to explore the powerful tools we have in Linux to simulate dealing with broken disks, that is, drives that more or less randomly report errors.
Why is this important ? Because by simulating errors that will also happen sooner or later in the real world, we are able to create software that is more robust and can withstand any problems on the infrastructure.</p><h2 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><p>In order not to have troubles in our development system, and to make the process as portable as possible, we start by creating a dummy 1GB disk based on the <a href=https://en.wikipedia.org/wiki/Loop_device>loop device</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># dd if=/dev/zero of=/myfakedisk.bin bs=1M count=1024</span>
</span></span><span style=display:flex><span>1024+0 records in
</span></span><span style=display:flex><span>1024+0 records out
</span></span><span style=display:flex><span><span style=color:#ae81ff>1073741824</span> bytes <span style=color:#f92672>(</span>1.1 GB, 1.0 GiB<span style=color:#f92672>)</span> copied, 0.446898 s, 2.4 GB/s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># losetup /dev/loop0 /myfakedisk.bin</span>
</span></span></code></pre></div><p>Now we can use the loop device just like any other block device: we can create a filesystem and mount it</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkfs.ext4 /dev/loop0</span>
</span></span><span style=display:flex><span>mke2fs 1.46.4 <span style=color:#f92672>(</span>18-Aug-2021<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Discarding device blocks: <span style=color:#66d9ef>done</span>                            
</span></span><span style=display:flex><span>Creating filesystem with <span style=color:#ae81ff>262144</span> 4k blocks and <span style=color:#ae81ff>65536</span> inodes
</span></span><span style=display:flex><span>Filesystem UUID: bcba505c-54fa-49e5-852c-b5ea3faa53d0
</span></span><span style=display:flex><span>Superblock backups stored on blocks: 
</span></span><span style=display:flex><span>	32768, 98304, 163840, <span style=color:#ae81ff>229376</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Allocating group tables: <span style=color:#66d9ef>done</span>                            
</span></span><span style=display:flex><span>Writing inode tables: <span style=color:#66d9ef>done</span>                            
</span></span><span style=display:flex><span>Creating journal <span style=color:#f92672>(</span><span style=color:#ae81ff>8192</span> blocks<span style=color:#f92672>)</span>: <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>Writing superblocks and filesystem accounting information: <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># mkdir /mnt/good &amp;&amp; mount /dev/loop0 /mnt/good &amp;&amp; echo &#34;test&#34; &gt; /mnt/good/test.txt &amp;&amp; umount /mnt/good</span>
</span></span></code></pre></div><p>our working &ldquo;virtual disk&rdquo; is ready, now we can create a faulty one using linux&rsquo;s <a href=https://docs.kernel.org/admin-guide/device-mapper/index.html>device mapper</a> features.</p><h2 id=whats-device-mapper->What&rsquo;s device mapper ?<a hidden class=anchor aria-hidden=true href=#whats-device-mapper->#</a></h2><p><img alt=map loading=lazy src=/img/pexels-monstera-production-7412095.jpg>
Image credits: <a href=https://www.pexels.com/@gabby-k/>Monstera Production</a></p><p>The Linux Device Mapper is a kernel-level framework that enables the creation of virtual block devices by mapping physical storage devices or logical volumes to these virtual devices. It operates within the Linux kernel, providing a layer for creating, managing, and manipulating storage devices through various mapping techniques such as mirroring, striping, encryption, and snapshots. This framework allows for the implementation of advanced storage features like volume management, RAID, and thin provisioning, offering greater flexibility, scalability, and reliability in managing storage resources within the Linux operating system.</p><p>Basically we are going to create a &ldquo;map&rdquo; between our working device and a &ldquo;new&rdquo; one, with this rough schema:</p><ul><li>from sector 0 to 2047, get the data from the underlying device (because we don&rsquo;t want to mess with partition table and metadata)</li><li>from sector 2048 to half disk size, return an error, or the original data, with 20% odds of failure</li><li>from half size to the end, return again the data from the underlying device</li></ul><p>Disk size can be found with a simple check:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cat /sys/block/loop0/size </span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2097152</span>
</span></span></code></pre></div><p>This kind of mapping is expressed in the <code>dmsetup create</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># dmsetup create bad_disk &lt;&lt; EOF</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>2048</span>    linear /dev/loop0 <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2048</span>    <span style=color:#ae81ff>1047552</span> flakey /dev/loop0 <span style=color:#ae81ff>2048</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span><span style=color:#ae81ff>1049600</span> <span style=color:#ae81ff>1047552</span> linear /dev/loop0 <span style=color:#ae81ff>1049600</span>
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ls -l /dev/mapper/bad_disk</span>
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>7</span> Nov <span style=color:#ae81ff>19</span> 17:51 /dev/mapper/bad_disk -&gt; ../dm-0
</span></span></code></pre></div><p>For each table entry, we need to specify:</p><ul><li>start sector/offset of mapping</li><li>size of the mapping</li><li>which mapper is being used</li><li>options of the mapper (for details refer to the <a href=https://docs.kernel.org/admin-guide/device-mapper/index.html>documentation</a>)</li></ul><p>In this setup we are using the <a href=https://docs.kernel.org/admin-guide/device-mapper/linear.html>linear</a> mapper and the <a href=https://docs.kernel.org/admin-guide/device-mapper/dm-flakey.html>flakey</a> one. Another useful one can be <a href=https://docs.kernel.org/admin-guide/device-mapper/delay.html>delay</a> to simulate very slow disks or <a href=https://docs.kernel.org/admin-guide/device-mapper/dm-dust.html>dust</a> that emulates the behavior of bad sectors at arbitrary locations, and the ability to enable the emulation of the failures at an arbitrary time.</p><h2 id=lets-try-it-out>Let&rsquo;s try it out<a hidden class=anchor aria-hidden=true href=#lets-try-it-out>#</a></h2><p>Our backing disk is already formatted, so it&rsquo;s time to try out the bad one, by mounting and writing some stuff:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mkdir /mnt/bad &amp;&amp; mount /dev/mapper/bad_disk /mnt/bad &amp;&amp; cd /mnt/bad</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># df -h | grep -E &#39;(^Filesystem|bad)&#39;</span>
</span></span><span style=display:flex><span>Filesystem            Size  Used Avail Use% Mounted on
</span></span><span style=display:flex><span>/dev/mapper/bad_disk  974M   28K  907M   1% /mnt/bad
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e># while sleep 1 ; do dd if=/dev/zero of=trytowrite.bin bs=1M count=500 ; done </span>
</span></span><span style=display:flex><span>500+0 records in
</span></span><span style=display:flex><span>500+0 records out
</span></span><span style=display:flex><span><span style=color:#ae81ff>524288000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>524</span> MB, <span style=color:#ae81ff>500</span> MiB<span style=color:#f92672>)</span> copied, 0.595353 s, <span style=color:#ae81ff>881</span> MB/s
</span></span><span style=display:flex><span>500+0 records in
</span></span><span style=display:flex><span>500+0 records out
</span></span><span style=display:flex><span><span style=color:#ae81ff>524288000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>524</span> MB, <span style=color:#ae81ff>500</span> MiB<span style=color:#f92672>)</span> copied, 0.637194 s, <span style=color:#ae81ff>823</span> MB/s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Message from syslogd@localhost at Nov <span style=color:#ae81ff>19</span> 18:09:15 ...
</span></span><span style=display:flex><span> kernel:<span style=color:#f92672>[</span> 8017.117593<span style=color:#f92672>][</span>T23594<span style=color:#f92672>]</span> EXT4-fs <span style=color:#f92672>(</span>dm-0<span style=color:#f92672>)</span>: failed to convert unwritten extents to written extents -- potential data loss!  <span style=color:#f92672>(</span>inode 13, error -30<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Message from syslogd@localhost at Nov <span style=color:#ae81ff>19</span> 18:09:15 ...
</span></span><span style=display:flex><span> kernel:<span style=color:#f92672>[</span> 8017.118445<span style=color:#f92672>][</span>T23976<span style=color:#f92672>]</span> EXT4-fs <span style=color:#f92672>(</span>dm-0<span style=color:#f92672>)</span>: failed to convert unwritten extents to written extents -- potential data loss!  <span style=color:#f92672>(</span>inode 13, error -30<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>dd: error writing <span style=color:#e6db74>&#39;trytowrite.bin&#39;</span>: Read-only file system
</span></span><span style=display:flex><span>481+0 records in
</span></span><span style=display:flex><span>480+0 records out
</span></span><span style=display:flex><span><span style=color:#ae81ff>503865344</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>504</span> MB, <span style=color:#ae81ff>481</span> MiB<span style=color:#f92672>)</span> copied, 0.549939 s, <span style=color:#ae81ff>916</span> MB/s
</span></span><span style=display:flex><span>dd: failed to open <span style=color:#e6db74>&#39;trytowrite.bin&#39;</span>: Read-only file system
</span></span><span style=display:flex><span>dd: failed to open <span style=color:#e6db74>&#39;trytowrite.bin&#39;</span>: Read-only file system
</span></span><span style=display:flex><span>dd: failed to open <span style=color:#e6db74>&#39;trytowrite.bin&#39;</span>: Read-only file system
</span></span><span style=display:flex><span>dd: failed to open <span style=color:#e6db74>&#39;trytowrite.bin&#39;</span>: Read-only file system
</span></span><span style=display:flex><span>dd: failed to open <span style=color:#e6db74>&#39;trytowrite.bin&#39;</span>: Read-only file system
</span></span></code></pre></div><h2 id=disk-failure-is-a-success>Disk failure is a success!<a hidden class=anchor aria-hidden=true href=#disk-failure-is-a-success>#</a></h2><p>As we can see, at first some I/O operations succeeds, then the disk fails and in <code>dmesg</code> log we can find more details:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>[ <span style=color:#ae81ff>7962.645178</span>] EXT4<span style=color:#f92672>-</span>fs (dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): error loading journal
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>7979.334186</span>] EXT4<span style=color:#f92672>-</span>fs (dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): mounted filesystem with ordered data mode<span style=color:#f92672>.</span> Opts: (null)<span style=color:#f92672>.</span> Quota mode: none<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.759602</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>129024</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.759641</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>129280</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.759685</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>129536</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.759802</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>129870</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760119</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>130625</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760122</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130625</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760129</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130626</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760131</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130627</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760132</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130628</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760133</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130629</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760134</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130630</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760135</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130631</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760136</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130632</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760137</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130633</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.760138</span>] Buffer I<span style=color:#f92672>/</span>O error on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>130634</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.923667</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>54272</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.923731</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>54783</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.924020</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>55296</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.924335</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>60416</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.924394</span>] EXT4<span style=color:#f92672>-</span>fs warning (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_end_bio:<span style=color:#ae81ff>347</span>: I<span style=color:#f92672>/</span>O error <span style=color:#ae81ff>10</span> writing to inode <span style=color:#ae81ff>13</span> starting block <span style=color:#ae81ff>61803</span>)
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.961108</span>] Buffer I<span style=color:#f92672>/</span>O error on dev dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>131103</span>, lost sync page write
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.961125</span>] Aborting journal on device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8.</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.961127</span>] Buffer I<span style=color:#f92672>/</span>O error on dev dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>, logical block <span style=color:#ae81ff>131072</span>, lost sync page write
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.961128</span>] JBD2: Error <span style=color:#f92672>-</span><span style=color:#ae81ff>5</span> detected when updating journal superblock <span style=color:#66d9ef>for</span> dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8.</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.961142</span>] EXT4<span style=color:#f92672>-</span>fs error (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_journal_check_start:<span style=color:#ae81ff>83</span>: comm kworker<span style=color:#f92672>/</span>u2:<span style=color:#ae81ff>3</span>: Detected aborted journal
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>8016.966200</span>] EXT4<span style=color:#f92672>-</span>fs error (device dm<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>): ext4_journal_check_start:<span style=color:#ae81ff>83</span>: comm dd: Detected aborted journal
</span></span></code></pre></div><p>In a more general sense, these concepts fall under the principle of <a href=https://en.wikipedia.org/wiki/Chaos_engineering>&ldquo;chaos engineering&rdquo;</a>.
This can be also a good practice for junior sysadmins that wants to learn how to cope with a damaged filesystem and try to recover data.</p><h2 id=cleanup>Cleanup<a hidden class=anchor aria-hidden=true href=#cleanup>#</a></h2><p>To remove the tracks of our experiments, it&rsquo;s sufficient to unmount the &ldquo;bad&rdquo; disk, remove the mapping and unassociate the loop device with the backing file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># umount /mnt/bad &amp;&amp; rmdir /mnt/bad
</span></span><span style=display:flex><span># dmsetup remove bad_disk
</span></span><span style=display:flex><span># losetup -d /dev/loop0
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/linux/>Linux</a></li><li><a href=https://ilmanzo.github.io/tags/sysadmin/>Sysadmin</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>Programming</a></li><li><a href=https://ilmanzo.github.io/tags/testing/>Testing</a></li><li><a href=https://ilmanzo.github.io/tags/device/>Device</a></li><li><a href=https://ilmanzo.github.io/tags/storage/>Storage</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/faulty_network_simulation/><span class=title>¬´ Prev</span><br><span>Fault Injection in Network Namespace and Veth Environments</span>
</a><a class=next href=https://ilmanzo.github.io/post/a_trip_on_the_rusty_dbus/><span class=title>Next ¬ª</span><br><span>A trip on the rusty D-Bus</span></a></nav></footer></article></main><footer class=footer><span>¬© 2012-2025 Andrea Manzini</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>