<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>First steps with Linux Test Project | ilManzo's blog</title>
<meta name=keywords content="linux,sysadmin,opensuse,test,kernel,syscalls"><meta name=description content="How the Linux Kernel is tested, one syscall at a time"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/first_steps_of_ltp_linux_test_project/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/first_steps_of_ltp_linux_test_project/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL")}</script><meta property="og:url" content="https://ilmanzo.github.io/post/first_steps_of_ltp_linux_test_project/"><meta property="og:site_name" content="ilManzo's blog"><meta property="og:title" content="First steps with Linux Test Project"><meta property="og:description" content="How the Linux Kernel is tested, one syscall at a time"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-02-10T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-10T00:00:00+00:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Sysadmin"><meta property="article:tag" content="Opensuse"><meta property="article:tag" content="Test"><meta property="article:tag" content="Kernel"><meta property="article:tag" content="Syscalls"><meta name=twitter:card content="summary"><meta name=twitter:title content="First steps with Linux Test Project"><meta name=twitter:description content="How the Linux Kernel is tested, one syscall at a time"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"First steps with Linux Test Project","item":"https://ilmanzo.github.io/post/first_steps_of_ltp_linux_test_project/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"First steps with Linux Test Project","name":"First steps with Linux Test Project","description":"How the Linux Kernel is tested, one syscall at a time","keywords":["linux","sysadmin","opensuse","test","kernel","syscalls"],"articleBody":"üïµÔ∏è Intro The Linux Test Project is a joint project started years ago by SGI, OSDL and Bull developed and now maintained by IBM, Cisco, Fujitsu, SUSE, Red Hat, Oracle and many others. The project goal is to deliver tests to the open source community that validate the reliability, robustness, and stability of Linux.\nIn these days I‚Äôm having a journey on the project so with this article I want to show step by step how to setup the project, how tests are actually written and give you a quick and dirty guide to write your first one.\nüß∞ Let‚Äôs start NOTE: Since some tests manipulate operating system settings, if you plan to run the entire testsuite it is advisable to keep your workstation clean and setup a separate environment, like a spare pc or a development virtual machine.\nFirst thing is to install development tools and clone the repository:\n# zypper in -t pattern devel_basis or # zypper install gcc git make pkg-config autoconf automake bison flex m4 linux-glibc-devel glibc-devel $ git clone https://github.com/linux-test-project/ltp.git \u0026\u0026 cd ltp $ make autotools $ ./configure [...omitted output...] Now you can continue either with compiling and running a single test or with compiling and installing the whole testsuite. Lets‚Äô do one baby step:\n‚öóÔ∏è One sample test If you want to just execute a single test you actually do not need to compile the whole LTP project, so we pick up an example test for the open() syscall . To find this specific test,\n$ cd testcases/kernel/syscalls/open $ cat open03.c What‚Äôs inside ‚ÅâÔ∏è 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // SPDX-License-Identifier: GPL-2.0-or-later /* * Copyright (c) Linux Test Project, 2001-2024 * Copyright (c) 2000 Silicon Graphics, Inc. All Rights Reserved. */ /*\\ * [Description] * * Testcase to check open() with O_RDWR | O_CREAT. */ #include \"tst_test.h\" #define TEST_FILE \"testfile\" static void verify_open(void) { TST_EXP_FD(open(TEST_FILE, O_RDWR | O_CREAT, 0700)); SAFE_CLOSE(TST_RET); SAFE_UNLINK(TEST_FILE); } static struct tst_test test = { .needs_tmpdir = 1, .test_all = verify_open, }; This test is pretty simple, as actual code is less than 10 lines. A brief line-by-line overview:\n1-12: standard comments, license and doc header. This project has more than 20 years of history! 13: include the mandatory LTP library header 15: a sample filename we‚Äôll try to create calling the open() syscall 17-19: the real test function: using the macros provided by the framework, send to the kernel an open() syscall and ensure the operation succeeds ; if by any means the syscall should return an error, the error gets automatically reported and the test result marked as failed. In any case, the value returned is stored in the variable TST_RET 20-22: SAFE_* macros let us to close and delete the file just opened in a clean way 24-27: definition for the test metadata: which options does it need to run and which is the function that the framework will execute for us. LTP framework will look for this structure and use the informations inside. If you are curious about all the available options, you can find a good description here, but since it‚Äôs a big topic, it deserves a future dedicated post The Linux Test Project, like the Linux Kernel itself, makes heavy use of C macros, in order to keep the tests clean, mainteinable and readable. Of course all the macros and library functions are documented and explained in the project documentation.\nFor a reference of the syscalls, just consult your system‚Äôs man pages. As a tip, it‚Äôs recommended to clone the upstream man repository because sometimes the man pages packaged by distributions can be sometimes lacking behind.\nüëü How to run the test Thanks to the build system setup, we can just make our single testcase and run the standalone executable. LTP will add lots of useful information to our little program:\n$ make open03 [... compiler messages omitted...] $ ./open03 tst_test.c:1741: TINFO: LTP version: 20240129 tst_test.c:1625: TINFO: Timeout per run is 0h 00m 30s open03.c:19: TPASS: open(TEST_FILE, O_RDWR | O_CREAT, 0700) returned fd 3 Summary: passed 1 failed 0 broken 0 skipped 0 warnings 0 The compiled executable is also accepting some options, again courtesy of the LTP framework:\n$ ./open03 -h Environment Variables --------------------- KCONFIG_PATH Specify kernel config file KCONFIG_SKIP_CHECK Skip kernel config check if variable set (not set by default) LTPROOT Prefix for installed LTP (default: /opt/ltp) LTP_COLORIZE_OUTPUT Force colorized output behaviour (y/1 always, n/0: never) LTP_DEV Path to the block device to be used (for .needs_device) LTP_DEV_FS_TYPE Filesystem used for testing (default: ext2) LTP_SINGLE_FS_TYPE Testing only - specifies filesystem instead all supported (for .all_filesystems) LTP_TIMEOUT_MUL Timeout multiplier (must be a number \u003e=1) LTP_RUNTIME_MUL Runtime multiplier (must be a number \u003e=1) LTP_VIRT_OVERRIDE Overrides virtual machine detection (values: \"\"|kvm|microsoft|xen|zvm) TMPDIR Base directory for template directory (for .needs_tmpdir, default: /tmp) Timeout and runtime ------------------- Test timeout (not including runtime) 0h 0m 30s Options ------- -h Prints this help -i n Execute test n times -I x Execute test for n seconds -D Prints debug information -V Prints LTP version -C ARG Run child process with ARG arguments (used internally) you can also check your source code against project best practices:\n$ make check-open03 You will receive hints and errors about code quality, formatting and possible deviations from the projects‚Äô coding standards.\nüóø Hello, new test So if you want to write a new LTP test, you can just choose a testcases/kernel/ subfolder and create a new .c file using a template like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 #include static void setup(void) { // your setup code goes here tst_res(TINFO, \"example setup\"); } static void cleanup(void) { // your cleanup code goes here tst_res(TINFO, \"example cleanup\"); } static void run(void) { // your test code goes here tst_res(TPASS, \"Doing hardly anything is easy\"); } static struct tst_test test = { .test_all = run, .setup = setup, .cleanup = cleanup, }; In this example it‚Äôs important to notice that the functions setup() and cleanup() are meant to create/dispose test resources (like buffers, files, sockets, child processes and so on) and they get executed only once, while the run() is the real test code and can be repeated many times.\nAfter saving your source code with a name like mynewtest01.c, you just need to run\n$ make mynewtest01 CC testcases/kernel/syscalls/open/mynewtest01 $ ls -l mynewtest* -rwxr-xr-x 1 andrea andrea 738064 Feb 10 11:46 mynewtest01 -rw-r--r-- 1 andrea andrea 475 Feb 10 11:46 mynewtest01.c $ ./mynewtest01 tst_test.c:1741: TINFO: LTP version: 20240129 tst_test.c:1625: TINFO: Timeout per run is 0h 00m 30s mynewtest01.c:5: TINFO: example setup mynewtest01.c:15: TPASS: Doing hardly anything is easy mynewtest01.c:10: TINFO: example cleanup Summary: passed 1 failed 0 broken 0 skipped 0 warnings 0 It doesn‚Äôt do anything yet but seems working, now you need only to actually implement your test logic.\nOnce finished and debugged, if you want the new test executed as part of the testsuite, you need to add it in one of the runtest subfolders, where each text file defines a group of tests AKA test suite.\n‚úÖ Conclusion If you are interested in the project, check out the project‚Äôs Wiki for other documentation and Writing Guidelines; you can also subscribe to the LTP Mailing List. Enjoy!\n","wordCount":"1234","inLanguage":"en","datePublished":"2024-02-10T00:00:00Z","dateModified":"2024-02-10T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/first_steps_of_ltp_linux_test_project/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">First steps with Linux Test Project</h1><div class=post-description>How the Linux Kernel is tested, one syscall at a time</div><div class=post-meta><span title='2024-02-10 00:00:00 +0000 UTC'>February 10, 2024</span>&nbsp;¬∑&nbsp;Andrea Manzini</div></header><div class=post-content><h2 id=-intro>üïµÔ∏è Intro<a hidden class=anchor aria-hidden=true href=#-intro>#</a></h2><p>The <a href=https://github.com/linux-test-project/ltp>Linux Test Project</a> is a joint project started years ago by SGI, OSDL and Bull developed and now maintained by IBM, Cisco, Fujitsu, SUSE, Red Hat, Oracle and many others. The project goal is to deliver tests to the open source community that validate the reliability, robustness, and stability of Linux.</p><p>In these days I&rsquo;m having a journey on the project so with this article I want to show step by step how to setup the project, how tests are actually written and give you a <em>quick and dirty</em> guide to write your first one.</p><h2 id=-lets-start>üß∞ Let&rsquo;s start<a hidden class=anchor aria-hidden=true href=#-lets-start>#</a></h2><p>NOTE: Since some tests manipulate operating system settings, if you plan to run the entire testsuite it is advisable to keep your workstation clean and setup a separate environment, like a spare pc or a development virtual machine.</p><p>First thing is to install development tools and clone the repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># zypper in -t pattern devel_basis </span>
</span></span><span style=display:flex><span>or 
</span></span><span style=display:flex><span><span style=color:#75715e># zypper install gcc git make pkg-config autoconf automake bison flex m4 linux-glibc-devel glibc-devel</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ git clone https://github.com/linux-test-project/ltp.git <span style=color:#f92672>&amp;&amp;</span> cd ltp
</span></span><span style=display:flex><span>$ make autotools 
</span></span><span style=display:flex><span>$ ./configure
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...omitted output...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Now you can continue either with compiling and running a single test or with compiling and installing the whole testsuite. Lets&rsquo; do one baby step:</p><h2 id=-one-sample-test>‚öóÔ∏è One sample test<a hidden class=anchor aria-hidden=true href=#-one-sample-test>#</a></h2><p>If you want to just execute a single test you actually do not need to compile the whole LTP project, so we pick up an example test for the <a href=https://man7.org/linux/man-pages/man2/open.2.html><code>open()</code> syscall</a> . To find this specific test,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd testcases/kernel/syscalls/open
</span></span><span style=display:flex><span>$ cat open03.c
</span></span></code></pre></div><h3 id=whats-inside->What&rsquo;s inside ‚ÅâÔ∏è<a hidden class=anchor aria-hidden=true href=#whats-inside->#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>// SPDX-License-Identifier: GPL-2.0-or-later
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Copyright (c) Linux Test Project, 2001-2024
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Copyright (c) 2000 Silicon Graphics, Inc.  All Rights Reserved.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*\
</span></span></span><span style=display:flex><span><span style=color:#75715e> * [Description]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Testcase to check open() with O_RDWR | O_CREAT.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;tst_test.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define TEST_FILE &#34;testfile&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>verify_open</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TST_EXP_FD</span>(<span style=color:#a6e22e>open</span>(TEST_FILE, O_RDWR <span style=color:#f92672>|</span> O_CREAT, <span style=color:#ae81ff>0700</span>));
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SAFE_CLOSE</span>(TST_RET);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SAFE_UNLINK</span>(TEST_FILE);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> tst_test test <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .needs_tmpdir <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        .test_all <span style=color:#f92672>=</span> verify_open,
</span></span><span style=display:flex><span>};</span></span></code></pre></td></tr></table></div></div><p>This test is pretty simple, as actual code is less than 10 lines. A brief line-by-line overview:</p><ul><li>1-12: standard comments, license and doc header. This project has more than 20 years of history!</li><li>13: include the mandatory LTP library header</li><li>15: a sample filename we&rsquo;ll try to create calling the <code>open()</code> syscall</li><li>17-19: the real test function: using the macros provided by the framework, send to the kernel an <code>open()</code> syscall and ensure the operation succeeds ; if by any means the syscall should return an error, the error gets automatically reported and the test result marked as <em>failed</em>. In any case, the value returned is stored in the variable <code>TST_RET</code></li><li>20-22: <code>SAFE_*</code> macros let us to close and delete the file just opened in a clean way</li><li>24-27: definition for the test metadata: which options does it need to run and which is the function that the framework will execute for us. LTP framework will look for this structure and use the informations inside. If you are curious about all the available options, you can find a good <a href=https://ltp-core.readthedocs.io/en/latest/#customize-test-options>description here</a>, but since it&rsquo;s a big topic, it deserves a future dedicated post</li></ul><p>The <a href=https://github.com/linux-test-project/ltp>Linux Test Project</a>, like the Linux Kernel itself, makes heavy use of C macros, in order to keep the tests clean, mainteinable and readable. Of course all the macros and library functions are documented and explained in the project documentation.</p><p>For a reference of the syscalls, just consult your system&rsquo;s <strong>man pages</strong>. As a tip, it&rsquo;s recommended to clone the <a href=git://git.kernel.org/pub/scm/docs/man-pages/man-pages.git>upstream man repository</a> because sometimes the man pages packaged by distributions can be sometimes lacking behind.</p><h2 id=-how-to-run-the-test>üëü How to run the test<a hidden class=anchor aria-hidden=true href=#-how-to-run-the-test>#</a></h2><p>Thanks to the build system setup, we can just <code>make</code> our single testcase and run the standalone executable. LTP will add lots of useful information to our little program:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ make open03
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>... compiler messages omitted...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>$ ./open03
</span></span><span style=display:flex><span>tst_test.c:1741: TINFO: LTP version: <span style=color:#ae81ff>20240129</span>
</span></span><span style=display:flex><span>tst_test.c:1625: TINFO: Timeout per run is 0h 00m 30s
</span></span><span style=display:flex><span>open03.c:19: TPASS: open<span style=color:#f92672>(</span>TEST_FILE, O_RDWR | O_CREAT, 0700<span style=color:#f92672>)</span> returned fd <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Summary:
</span></span><span style=display:flex><span>passed   <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>failed   <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>broken   <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>skipped  <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>warnings <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>The compiled executable is also accepting some options, again courtesy of the LTP framework:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./open03 -h
</span></span><span style=display:flex><span>Environment Variables
</span></span><span style=display:flex><span>---------------------
</span></span><span style=display:flex><span>KCONFIG_PATH         Specify kernel config file
</span></span><span style=display:flex><span>KCONFIG_SKIP_CHECK   Skip kernel config check <span style=color:#66d9ef>if</span> variable set <span style=color:#f92672>(</span>not set by default<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LTPROOT              Prefix <span style=color:#66d9ef>for</span> installed LTP <span style=color:#f92672>(</span>default: /opt/ltp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LTP_COLORIZE_OUTPUT  Force colorized output behaviour <span style=color:#f92672>(</span>y/1 always, n/0: never<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LTP_DEV              Path to the block device to be used <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> .needs_device<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LTP_DEV_FS_TYPE      Filesystem used <span style=color:#66d9ef>for</span> testing <span style=color:#f92672>(</span>default: ext2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LTP_SINGLE_FS_TYPE   Testing only - specifies filesystem instead all supported <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> .all_filesystems<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LTP_TIMEOUT_MUL      Timeout multiplier <span style=color:#f92672>(</span>must be a number &gt;<span style=color:#f92672>=</span>1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LTP_RUNTIME_MUL      Runtime multiplier <span style=color:#f92672>(</span>must be a number &gt;<span style=color:#f92672>=</span>1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LTP_VIRT_OVERRIDE    Overrides virtual machine detection <span style=color:#f92672>(</span>values: <span style=color:#e6db74>&#34;&#34;</span>|kvm|microsoft|xen|zvm<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>TMPDIR               Base directory <span style=color:#66d9ef>for</span> template directory <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> .needs_tmpdir, default: /tmp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Timeout and runtime
</span></span><span style=display:flex><span>-------------------
</span></span><span style=display:flex><span>Test timeout <span style=color:#f92672>(</span>not including runtime<span style=color:#f92672>)</span> 0h 0m 30s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options
</span></span><span style=display:flex><span>-------
</span></span><span style=display:flex><span>-h       Prints this help
</span></span><span style=display:flex><span>-i n     Execute test n times
</span></span><span style=display:flex><span>-I x     Execute test <span style=color:#66d9ef>for</span> n seconds
</span></span><span style=display:flex><span>-D       Prints debug information
</span></span><span style=display:flex><span>-V       Prints LTP version
</span></span><span style=display:flex><span>-C ARG   Run child process with ARG arguments <span style=color:#f92672>(</span>used internally<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>you can also check your source code against project best practices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ make check-open03
</span></span></code></pre></div><p>You will receive hints and errors about code quality, formatting and possible deviations from the projects&rsquo; coding standards.</p><h2 id=-hello-new-test>üóø Hello, new test<a hidden class=anchor aria-hidden=true href=#-hello-new-test>#</a></h2><p>So if you want to write a new LTP test, you can just choose a <code>testcases/kernel/</code> subfolder and create a new <code>.c</code> file using a template like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;tst_test.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// your setup code goes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>tst_res</span>(TINFO, <span style=color:#e6db74>&#34;example setup&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cleanup</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// your cleanup code goes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>tst_res</span>(TINFO, <span style=color:#e6db74>&#34;example cleanup&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// your test code goes here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>tst_res</span>(TPASS, <span style=color:#e6db74>&#34;Doing hardly anything is easy&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> tst_test test <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .test_all <span style=color:#f92672>=</span> run,
</span></span><span style=display:flex><span>        .setup <span style=color:#f92672>=</span> setup,
</span></span><span style=display:flex><span>        .cleanup <span style=color:#f92672>=</span> cleanup,
</span></span><span style=display:flex><span>};</span></span></code></pre></td></tr></table></div></div><p>In this example it&rsquo;s important to notice that the functions <code>setup()</code> and <code>cleanup()</code> are meant to create/dispose test resources (like buffers, files, sockets, child processes and so on) and they get executed only once, while the <code>run()</code> is the real test code and can be repeated many times.</p><p>After saving your source code with a name like <code>mynewtest01.c</code>, you just need to run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ make mynewtest01
</span></span><span style=display:flex><span>CC testcases/kernel/syscalls/open/mynewtest01
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ls -l mynewtest*
</span></span><span style=display:flex><span>-rwxr-xr-x <span style=color:#ae81ff>1</span> andrea andrea <span style=color:#ae81ff>738064</span> Feb <span style=color:#ae81ff>10</span> 11:46 mynewtest01
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> andrea andrea    <span style=color:#ae81ff>475</span> Feb <span style=color:#ae81ff>10</span> 11:46 mynewtest01.c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ./mynewtest01
</span></span><span style=display:flex><span>tst_test.c:1741: TINFO: LTP version: <span style=color:#ae81ff>20240129</span>
</span></span><span style=display:flex><span>tst_test.c:1625: TINFO: Timeout per run is 0h 00m 30s
</span></span><span style=display:flex><span>mynewtest01.c:5: TINFO: example setup
</span></span><span style=display:flex><span>mynewtest01.c:15: TPASS: Doing hardly anything is easy
</span></span><span style=display:flex><span>mynewtest01.c:10: TINFO: example cleanup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Summary:
</span></span><span style=display:flex><span>passed   <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>failed   <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>broken   <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>skipped  <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>warnings <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>It doesn&rsquo;t do anything yet but seems working, now you need only to actually implement your test logic.</p><p>Once finished and debugged, if you want the new test executed as part of the testsuite, you need to add it in one of the <code>runtest</code> subfolders, where each text file defines a group of tests AKA test suite.</p><h2 id=-conclusion>‚úÖ Conclusion<a hidden class=anchor aria-hidden=true href=#-conclusion>#</a></h2><p>If you are interested in the project, check out <a href=https://github.com/linux-test-project/ltp/wiki>the project&rsquo;s Wiki</a> for other documentation and Writing Guidelines; you can also subscribe to <a href=https://lists.linux.it/listinfo/ltp>the LTP Mailing List</a>. Enjoy!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/linux/>Linux</a></li><li><a href=https://ilmanzo.github.io/tags/sysadmin/>Sysadmin</a></li><li><a href=https://ilmanzo.github.io/tags/opensuse/>Opensuse</a></li><li><a href=https://ilmanzo.github.io/tags/test/>Test</a></li><li><a href=https://ilmanzo.github.io/tags/kernel/>Kernel</a></li><li><a href=https://ilmanzo.github.io/tags/syscalls/>Syscalls</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/experiments_with_rust_on_arm_architecture/><span class=title>¬´ Prev</span><br><span>Playing with Rust on ARM architecture</span>
</a><a class=next href=https://ilmanzo.github.io/post/introduction_to_packaging_rust_applications/><span class=title>Next ¬ª</span><br><span>Introduction to packaging Rust application</span></a></nav></footer></article></main><footer class=footer><span>¬© 2012-2024 Andrea Manzini</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>