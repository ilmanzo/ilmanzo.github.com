<!doctype html><html lang=en><head><title>il linguaggio Lua: quinta parte &ndash; ilManzo's blog</title><meta name=description content="A minimalist and pragmatic website and personal blog"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://ilmanzo.github.io/css/colour/gruvbox-dark.css><link rel=stylesheet href=https://ilmanzo.github.io/css/colour/dark-mode.css><link rel=stylesheet href=https://ilmanzo.github.io/css/risotto.css><link rel=stylesheet href=https://ilmanzo.github.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://ilmanzo.github.io/ class=page__logo-inner>ilManzo's blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=/curriculum title>Curriculum</a></li><li class=main-nav__item><a class=nav-main-item href=/categories title>Categories</a></li><li class=main-nav__item><a class=nav-main-item href=/tags title>Tags</a></li><li class=main-nav__item><a class="nav-main-item active" href=/post/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>il linguaggio Lua: quinta parte</h1></header><div class=content__body><p>segue dalla <a href=https://ilmanzo.github.io/post/il-linguaggio-lua-04/>quarta parte</a></p><h1 id=sonata-al-chiaro-di-luna--un-plugin-per-vlc>“Sonata al chiaro di luna” : un plugin per vlc</h1><p>Come dicevamo all&rsquo;inizio, Lua è usato da numerose applicazioni come linguaggio di estensione; per scopi didattici ho scelto di scrivere un semplice plugin per un programma diffuso, il media player universale VLC. Con questo plugin risolveremo per sempre l&rsquo;annoso problema di decidere cosa sarebbe meglio sgranocchiare durante la visione!
L&rsquo;integrazione con lo scripting Lua è <a href=https://www.videolan.org/developers/vlc/share/lua/README.txt>documentata</a> in una serie di file <code>README.TXT</code> sparsi nella directory <code>$SRC/share/lua/</code> (dove <code>$SRC</code> è la directory dove abbiamo decompresso l&rsquo;archivio del sorgente di vlc). Grazie ad essi apprendiamo che VLC supporta diversi tipi di &ldquo;agganci&rdquo; (hooks) con Lua: per la generazione di playlist (ad esempio trasformare una playlist Youtube in una VLC), per le interfacce di controllo (a titolo di esempio, si può comandare VLC via telnet), per il recupero di meta-informazioni sullo stream (tipicamente scaricare e visualizzare la copertina dell&rsquo;album o la locandina del film in riproduzione) e, finalmente, quella che useremo noi, cioè una generica funzionalità aggiuntiva attivabile e disattivabile da menù.
Il file README specifica che questo tipo di estensione deve contenere due funzioni Lua di nome activate() e deactivate() che verranno chiamte in concomitanza con questi due eventi. Lo script deve avere anche una funzione descriptor() che VLC chiamerà allo startup ed avrà il compito di esporre una tabella con delle informazioni sul plugin come titolo, autore, versione. Ultimo vincolo, lo script deve risiedere in uno specifico path, ovvero $LIB/vlc/lua, dove $LIB è il percorso di libvlc (il “motore” del programma) a livello di sistema oppure $HOME/.local/share/vlc/lua, soluzione che permette ad ogni utente di usare i propri plugin; io ho pertanto copiato lo script seguente <code>[vlc_cibo.lua]</code> in <code>~/.local/share/vlc/lua/extensions/cibo.lua</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- da salvare in $HOME/.local/share/vlc/lua/extensions</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ritorna una tabella con una serie di dati sul plugin</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ad esempio il titolo da mostrare nel menu</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>descriptor</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { 
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.1&#34;</span>;
</span></span><span style=display:flex><span>      capabilities <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>      title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cibarie giuste&#34;</span>; 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- funzione chiamata quando l&#39;utente seleziona il plugin dal menu</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>activate</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> durata<span style=color:#f92672>=</span>vlc.input.item():duration()
</span></span><span style=display:flex><span>    durata<span style=color:#f92672>=</span>math.floor(durata<span style=color:#f92672>/</span><span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> msg<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;per soli &#34;</span><span style=color:#f92672>..</span>tostring(durata)<span style=color:#f92672>..</span><span style=color:#e6db74>&#34; minuti ci accontentiamo del popcorn&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> durata<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>60</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      msg<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;il film sembra lungo, meglio ordinare una &lt;b&gt;pizza&lt;/b&gt;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    dlg<span style=color:#f92672>=</span>vlc.dialog(<span style=color:#e6db74>&#34;cibarie giuste&#34;</span>)
</span></span><span style=display:flex><span>    dlg:add_label(msg)
</span></span><span style=display:flex><span>    dlg:add_button(<span style=color:#e6db74>&#34;Chiudi&#34;</span>,clicked) <span style=color:#75715e>-- associa al click del pulsante la funzione clicked</span>
</span></span><span style=display:flex><span>    vlc.playlist.pause() <span style=color:#75715e>-- ferma la riproduzione</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- chiamata quando l&#39;utente clicca sul pulsante Chiudi della message box</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>clicked</span>()
</span></span><span style=display:flex><span>    vlc.deactivate()
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- chiamata da VLC quando l&#39;utente disattiva il plugin</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>deactivate</span>()
</span></span><span style=display:flex><span>    vlc.playlist.play() <span style=color:#75715e>-- fa ripartire il filmato</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>close</span>()
</span></span><span style=display:flex><span>    vlc.deactivate()
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></code></pre></div><p>Analizziamo rapidamente il sorgente; dopo i commenti iniziali troviamo la funzione descriptor, che nel nostro caso inizializza e ritorna al chiamante una tabella con un solo campo, cioè il titolo del plugin; è l&rsquo;unico indispensabile e come si vede in figura è ciò che troveremo come voce di menu in VLC.</p><p><img src=/img/lua_fig007_vlc_luaplugin_menu.png alt=figura7_lua_vlc title="vlc menu with added plugin"></p><p>La seconda funzione è cruciale: viene chiamata quando l&rsquo;utente seleziona il plugin. Come prima cosa si fa dare la durata in secondi dell&rsquo;attuale media in riproduzione. VLC infatti espone verso Lua un “oggetto” vlc (vedremo nel prossimo articolo come implementare questa tecnica) tramite il quale ciascun plugin può interagire col media player. Grazie alla documentazione apprendiamo che la funzione input.item() dell&rsquo;oggetto vlc ritorna un riferimento al film che stiamo guardando. A sua volta questo oggetto ha una serie di metodi, tra i quali duration() che fornisce la lunghezza in secondi. In questo esempio la durata viene convertita in minuti (divisione per 60) ed utilizzata come parametro per stabilire quale messaggio visualizzare.
Usando ancora l&rsquo;oggetto vlc, chiediamo al programma di creare per noi una dialog box nella quale inseriamo la nostra scritta ed un pulsante, il cui evento click viene associato ad una nostra funzione. Come ultima operazione, decidiamo di attirare l&rsquo;attenzione chiedendo al media player di mettere in pausa la riproduzione, così l&rsquo;utente potrà leggere l&rsquo;avviso e prepararsi le giuste cibarie!</p><p><img src=/img/lua_fig008_vlc_luaplugin_attivo.png alt=figura8_lua_vlc title="vlc with plugin active"></p><p>La terza funzione dello script è quella che viene chiamata da VLC quando l&rsquo;utente ha cliccato sul pulsante della dialog box; in questo esempio abbiamo scelto di disattivare il plugin (provocando quindi l&rsquo;esecuzione della prossima funzione), ma nessuno ci vieta di scrivere del codice per ordinare effettivamente la pizza tramite un web service&mldr;
Ci resta solo la deactivate(): qui andrebbero eseguite tutte le operazioni di pulizia del plugin, nel nostro caso ci limitiamo a far ripartire il filmato.</p><p>A parte la dubbia utilità di questo plugin didattico, possiamo notare alcune cose interessanti: anzitutto la robustezza, nel senso che qualunque errore o problema in uno script Lua non metterà minimamente in crisi il programma principale; apprezziamo inoltre la chiarezza e la semplicità di avere interfacce ben definite, nel senso che il team VLC ha deciso per noi cosa esporre del programma e come farlo, nascondendoci la complessità dell&rsquo;implementazione, ma allo stesso tempo consentendoci di aggiungere nostre funzionalità. Infine non trascuriamo la portabilità, ovvero che questo plugin funzionerà allo stesso modo e senza modifiche anche in ambiente Windows o Mac.</p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://ilmanzo.github.io/images/rice.svg alt=Logo><h1 class=about__title>Andrea Manzini</h1><p class=about__description>A minimalist and pragmatic website and personal blog</p></div><ul class=aside__social-links><li><a href=https://github.com/ilmanzo rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:ilmanzo@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://www.linkedin.com/in/andreamanzini rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://twitter.com/ilmanzo rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>introduzione al linguaggio Lua</p><p>By Andrea Manzini,
2017-10-16</p></div></section><footer class=page__footer><p class=copyright>© 2022 Andrea Manzini</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>