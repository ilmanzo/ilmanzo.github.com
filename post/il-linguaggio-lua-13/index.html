<!doctype html><html lang=en><head><title>il linguaggio Lua: parte 13 &ndash; ilManzo's blog</title><meta name=description content="A minimalist, pragmatic website and personal blog"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://ilmanzo.github.io/css/palettes/base16-dark.css><link rel=stylesheet href=https://ilmanzo.github.io/css/risotto.css><link rel=stylesheet href=https://ilmanzo.github.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://ilmanzo.github.io/ class=page__logo-inner>ilManzo's blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/curriculum title>Curriculum</a></li><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/categories title>Categories</a></li><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/tags title>Tags</a></li><li class=main-nav__item><a class="nav-main-item active" href=https://ilmanzo.github.io/post/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>il linguaggio Lua: parte 13</h1></header><div class=content__body><p>segue dalla <a href=https://ilmanzo.github.io/post/il-linguaggio-lua-12/>parte 12</a></p><h1 id=upvalue-e-closure>Upvalue e Closure</h1><p>Per chi non ha familiarità con i concetti di programmazione funzionale questi termini possono sembrare un po’ oscuri; vediamo di chiarirli con un semplice esempio:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- definisco una funzione che parte da un numero N e conta alla rovescia</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>CreaContatore</span>(N)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> v<span style=color:#f92672>=</span>N
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>conta</span>(x)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> v<span style=color:#f92672>&gt;=</span>x <span style=color:#66d9ef>then</span> v<span style=color:#f92672>=</span>v<span style=color:#f92672>-</span>x <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>return</span> v
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> conta
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- creo qualche istanza:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>contaDaDieci<span style=color:#f92672>=</span>CreaContatore(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>contaDaCento<span style=color:#f92672>=</span>CreaContatore(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(contaDaDieci(<span style=color:#ae81ff>1</span>)) 
</span></span><span style=display:flex><span><span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>print(contaDaCento(<span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>99</span>
</span></span><span style=display:flex><span>print(contaDaCento(<span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>98</span>
</span></span><span style=display:flex><span>print(contaDaDieci(<span style=color:#ae81ff>1</span>)) 
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>print(contaDaDieci(<span style=color:#ae81ff>2</span>)) 
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>print(contaDaCento(<span style=color:#ae81ff>10</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>88</span></span></span></code></pre></div><p>osserviamo le variabili N,v che usate dalla funzione interna: non sono locali, ma nemmeno globali&mldr; Sono <strong>upvalue</strong>, ovvero riferimenti che provengono da uno stackframe esterno. Quando una funzione usa variabili definite in uno scope lessicale a livello superiore, Lua provvede a memorizzare lo stato, tecnicamente spostando la gestione degli upvalue dallo stack in una zona di memoria dedicata, perché altrimenti al ritorno della funzione lo stack verrebbe perso. Ogni funzione che usa uno o più upvalue è chiamata <strong>closure</strong>. Si tratta di una caratteristica molto potente perché ci permette ad esempio di implementare callback e sandbox. Un esempio a puro scopo didattico:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> oldExecute<span style=color:#f92672>=</span>os.execute  <span style=color:#75715e>-- salva vecchia funzione</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>newExec</span>(command)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> a,b<span style=color:#f92672>=</span>command:find(<span style=color:#e6db74>&#34;rm&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> a <span style=color:#66d9ef>then</span> 
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#34;NON eseguo: &#34;</span><span style=color:#f92672>..</span>command)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#34;eseguo: &#34;</span><span style=color:#f92672>..</span>command)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> oldExecute(command)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  os.execute<span style=color:#f92672>=</span>newExec
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os.execute(<span style=color:#e6db74>&#34;/bin/ls&#34;</span>)
</span></span><span style=display:flex><span>os.execute(<span style=color:#e6db74>&#34;/bin/rm prova.txt&#34;</span>)</span></span></code></pre></div><p>dopo questa ridefinizione, abbiamo creato una versione ‘sicura’ di os.execute: decidiamo noi quali comandi può lanciare l’utente&mldr; Nell’esempio, scartiamo qualsiasi cosa contenga “rm”. Proviamo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ lua sandbox.lua
</span></span><span style=display:flex><span>eseguo: /bin/ls
</span></span><span style=display:flex><span>coroutine.lua  sandbox.lua  
</span></span><span style=display:flex><span>NON eseguo: /bin/rm prova.txt</span></span></code></pre></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://ilmanzo.github.io/images/rice.svg alt=Logo><h1 class=about__title>Andrea Manzini</h1><p class=about__description>A minimalist, pragmatic website and personal blog</p></div><ul class=aside__social-links><li><a href=https://github.com/ilmanzo rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:ilmanzo@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://www.linkedin.com/in/andreamanzini rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://twitter.com/ilmanzo rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://ilmanzo.github.io/index.xml rel=me aria-label="RSS Feed" title="RSS Feed"><i class="fas fa-rss-square" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>introduzione al linguaggio Lua</p><p>By Andrea Manzini,
2019-01-19</p></div></section><footer class=page__footer><p></p><br><br><p class=copyright>© 2022 Andrea Manzini</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>