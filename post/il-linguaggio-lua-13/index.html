<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>il linguaggio Lua: parte 13 | ilManzo's blog</title>
<meta name=keywords content="lua,programming,tutorial,linux,italian"><meta name=description content="introduzione al linguaggio Lua"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/il-linguaggio-lua-13/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL",{anonymize_ip:!1})}</script><meta property="og:title" content="il linguaggio Lua: parte 13"><meta property="og:description" content="introduzione al linguaggio Lua"><meta property="og:type" content="article"><meta property="og:url" content="https://ilmanzo.github.io/post/il-linguaggio-lua-13/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-01-19T00:00:00+00:00"><meta property="article:modified_time" content="2019-01-19T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="il linguaggio Lua: parte 13"><meta name=twitter:description content="introduzione al linguaggio Lua"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"il linguaggio Lua: parte 13","item":"https://ilmanzo.github.io/post/il-linguaggio-lua-13/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"il linguaggio Lua: parte 13","name":"il linguaggio Lua: parte 13","description":"introduzione al linguaggio Lua","keywords":["lua","programming","tutorial","linux","italian"],"articleBody":"segue dalla parte 12\nUpvalue e Closure Per chi non ha familiarità con i concetti di programmazione funzionale questi termini possono sembrare un po’ oscuri; vediamo di chiarirli con un semplice esempio:\n-- definisco una funzione che parte da un numero N e conta alla rovescia function CreaContatore(N) local v=N local function conta(x) if v\u003e=x then v=v-x end return v end return conta end -- creo qualche istanza: contaDaDieci=CreaContatore(10) contaDaCento=CreaContatore(100) print(contaDaDieci(1)) 9 print(contaDaCento(1)) 99 print(contaDaCento(1)) 98 print(contaDaDieci(1)) 8 print(contaDaDieci(2)) 6 print(contaDaCento(10)) 88 osserviamo le variabili N,v che usate dalla funzione interna: non sono locali, ma nemmeno globali… Sono upvalue, ovvero riferimenti che provengono da uno stackframe esterno. Quando una funzione usa variabili definite in uno scope lessicale a livello superiore, Lua provvede a memorizzare lo stato, tecnicamente spostando la gestione degli upvalue dallo stack in una zona di memoria dedicata, perché altrimenti al ritorno della funzione lo stack verrebbe perso. Ogni funzione che usa uno o più upvalue è chiamata closure. Si tratta di una caratteristica molto potente perché ci permette ad esempio di implementare callback e sandbox. Un esempio a puro scopo didattico:\ndo local oldExecute=os.execute -- salva vecchia funzione local function newExec(command) local a,b=command:find(\"rm\") if a then print(\"NON eseguo: \"..command) else print(\"eseguo: \"..command) return oldExecute(command) end end os.execute=newExec end os.execute(\"/bin/ls\") os.execute(\"/bin/rm prova.txt\") dopo questa ridefinizione, abbiamo creato una versione ‘sicura’ di os.execute: decidiamo noi quali comandi può lanciare l’utente… Nell’esempio, scartiamo qualsiasi cosa contenga “rm”. Proviamo:\n$ lua sandbox.lua eseguo: /bin/ls coroutine.lua sandbox.lua NON eseguo: /bin/rm prova.txt ","wordCount":"249","inLanguage":"en","datePublished":"2019-01-19T00:00:00Z","dateModified":"2019-01-19T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/il-linguaggio-lua-13/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>il linguaggio Lua: parte 13</h1><div class=post-description>introduzione al linguaggio Lua</div><div class=post-meta><span title='2019-01-19 00:00:00 +0000 UTC'>January 19, 2019</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><p>segue dalla <a href=https://ilmanzo.github.io/post/il-linguaggio-lua-12/>parte 12</a></p><h1 id=upvalue-e-closure>Upvalue e Closure<a hidden class=anchor aria-hidden=true href=#upvalue-e-closure>#</a></h1><p>Per chi non ha familiarità con i concetti di programmazione funzionale questi termini possono sembrare un po’ oscuri; vediamo di chiarirli con un semplice esempio:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- definisco una funzione che parte da un numero N e conta alla rovescia</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>CreaContatore</span>(N)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> v<span style=color:#f92672>=</span>N
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>conta</span>(x)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> v<span style=color:#f92672>&gt;=</span>x <span style=color:#66d9ef>then</span> v<span style=color:#f92672>=</span>v<span style=color:#f92672>-</span>x <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>return</span> v
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> conta
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- creo qualche istanza:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>contaDaDieci<span style=color:#f92672>=</span>CreaContatore(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>contaDaCento<span style=color:#f92672>=</span>CreaContatore(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(contaDaDieci(<span style=color:#ae81ff>1</span>)) 
</span></span><span style=display:flex><span><span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>print(contaDaCento(<span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>99</span>
</span></span><span style=display:flex><span>print(contaDaCento(<span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>98</span>
</span></span><span style=display:flex><span>print(contaDaDieci(<span style=color:#ae81ff>1</span>)) 
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>print(contaDaDieci(<span style=color:#ae81ff>2</span>)) 
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>print(contaDaCento(<span style=color:#ae81ff>10</span>))
</span></span><span style=display:flex><span><span style=color:#ae81ff>88</span></span></span></code></pre></div><p>osserviamo le variabili N,v che usate dalla funzione interna: non sono locali, ma nemmeno globali&mldr; Sono <strong>upvalue</strong>, ovvero riferimenti che provengono da uno stackframe esterno. Quando una funzione usa variabili definite in uno scope lessicale a livello superiore, Lua provvede a memorizzare lo stato, tecnicamente spostando la gestione degli upvalue dallo stack in una zona di memoria dedicata, perché altrimenti al ritorno della funzione lo stack verrebbe perso. Ogni funzione che usa uno o più upvalue è chiamata <strong>closure</strong>. Si tratta di una caratteristica molto potente perché ci permette ad esempio di implementare callback e sandbox. Un esempio a puro scopo didattico:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> oldExecute<span style=color:#f92672>=</span>os.execute  <span style=color:#75715e>-- salva vecchia funzione</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>newExec</span>(command)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> a,b<span style=color:#f92672>=</span>command:find(<span style=color:#e6db74>&#34;rm&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> a <span style=color:#66d9ef>then</span> 
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#34;NON eseguo: &#34;</span><span style=color:#f92672>..</span>command)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#34;eseguo: &#34;</span><span style=color:#f92672>..</span>command)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> oldExecute(command)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  os.execute<span style=color:#f92672>=</span>newExec
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os.execute(<span style=color:#e6db74>&#34;/bin/ls&#34;</span>)
</span></span><span style=display:flex><span>os.execute(<span style=color:#e6db74>&#34;/bin/rm prova.txt&#34;</span>)</span></span></code></pre></div><p>dopo questa ridefinizione, abbiamo creato una versione ‘sicura’ di os.execute: decidiamo noi quali comandi può lanciare l’utente&mldr; Nell’esempio, scartiamo qualsiasi cosa contenga “rm”. Proviamo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ lua sandbox.lua
</span></span><span style=display:flex><span>eseguo: /bin/ls
</span></span><span style=display:flex><span>coroutine.lua  sandbox.lua  
</span></span><span style=display:flex><span>NON eseguo: /bin/rm prova.txt</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/lua/>lua</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>programming</a></li><li><a href=https://ilmanzo.github.io/tags/tutorial/>tutorial</a></li><li><a href=https://ilmanzo.github.io/tags/linux/>linux</a></li><li><a href=https://ilmanzo.github.io/tags/italian/>italian</a></li></ul></footer></article></main><footer class=footer><span>© 2012-2023 Andrea Manzini</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>