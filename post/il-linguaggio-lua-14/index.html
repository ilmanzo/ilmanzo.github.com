<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>il linguaggio Lua: parte 14 | ilManzo's blog</title>
<meta name=keywords content="lua,programming,tutorial,linux,italian"><meta name=description content="introduzione al linguaggio Lua"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/il-linguaggio-lua-14/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/il-linguaggio-lua-14/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL")}</script><meta property="og:url" content="https://ilmanzo.github.io/post/il-linguaggio-lua-14/"><meta property="og:site_name" content="ilManzo's blog"><meta property="og:title" content="il linguaggio Lua: parte 14"><meta property="og:description" content="introduzione al linguaggio Lua"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2019-02-15T00:00:00+00:00"><meta property="article:tag" content="Lua"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Tutorial"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Italian"><meta name=twitter:card content="summary"><meta name=twitter:title content="il linguaggio Lua: parte 14"><meta name=twitter:description content="introduzione al linguaggio Lua"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"il linguaggio Lua: parte 14","item":"https://ilmanzo.github.io/post/il-linguaggio-lua-14/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"il linguaggio Lua: parte 14","name":"il linguaggio Lua: parte 14","description":"introduzione al linguaggio Lua","keywords":["lua","programming","tutorial","linux","italian"],"articleBody":"segue dalla parte 13\nCoroutine Come approccio alla programmazione concorrente, il linguaggio Lua non ha meccanismi interni per gestire nativamente i thread, ma si può appoggiare a ciò che offre il sistema operativo sottostante. Lua invece internamente offre il supporto alle coroutine: un programma Lua può avere diversi percorsi di esecuzione ‘parallela’ ognuno col proprio stack e variabili locali ma che condividono risorse e variabili globali con le altre coroutine.\nLa prima differenza sostanziale col modello classico dei thread è che in un determinato istante ‘gira’ una e una sola coroutine, mentre in un sistema multiprocessore ci possono essere più thread in esecuzione in contemporanea.\nLa seconda grande differenza è che nei thread c’è una entità esterna (di solito lo scheduler del il sistema operativo) che sovrintende all’ordine e assegna la ‘fetta’ di processore a disposizione di ciascun thread, mentre in Lua ciascuna coroutine decide quando è il momento di “sospendersi” per lasciare la CPU alle altre.\nIn questo caso, si parla infatti di cooperative multitasking. Le ragioni di questa scelta degli autori sono molteplici: anzitutto la semplicità di implementazione, poi ricordiamo il fatto che Lua è nato come linguaggio ’embedded’, perciò qualora ci fosse veramente bisogno dei thread si sfrutteranno le capacità del linguaggio ospitante.\nLe funzionalità per gestire le coroutine in Lua sono raggruppate nel package ‘coroutine’. La prima funzione che serve è la create, che riceve come unico argomento una funzione e ritorna un valore di tipo thread:\n\u003eco=coroutine.create(function () print “ciao” end) \u003eprint(co) thread: 0x8408068 una coroutine può avere tre stati: suspended, running, dead. Una coroutine appena creata è in stato suspended:\n\u003eprint(coroutine.status(co)) suspended quindi per avviarla chiamiamo .resume :\n\u003ecoroutine.resume(co) ciao ora la routine è terminata:\n\u003eprint(coroutine.status(co)) dead ogni coroutine può volontariamente ‘mettersi in pausa’ e passare alcuni valori tramite la funzione yield ; vediamo un semplice esempio:\nNTHREADS=20 function ping() print \"ping\" coroutine.yield() end function pong() print \"pong\" coroutine.yield() end threads={} for j=1,NTHREADS do if j%2==0 then threads[j]=coroutine.create(pong) else threads[j]=coroutine.create(ping) end end running=true while running do for j=1,NTHREADS do running=coroutine.resume(threads[j]) end end se volessimo invece sfruttare i thread del sistema operativo, si possono utilizzare librerie come Lanes oppure llthreads2 .\n","wordCount":"356","inLanguage":"en","datePublished":"2019-02-15T00:00:00Z","dateModified":"2019-02-15T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/il-linguaggio-lua-14/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">il linguaggio Lua: parte 14</h1><div class=post-description>introduzione al linguaggio Lua</div><div class=post-meta><span title='2019-02-15 00:00:00 +0000 UTC'>February 15, 2019</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><p>segue dalla <a href=https://ilmanzo.github.io/post/il-linguaggio-lua-13/>parte 13</a></p><h1 id=coroutine>Coroutine<a hidden class=anchor aria-hidden=true href=#coroutine>#</a></h1><p>Come approccio alla programmazione concorrente, il linguaggio Lua non ha meccanismi interni per gestire nativamente i thread, ma si può appoggiare a ciò che offre il sistema operativo sottostante. Lua invece internamente offre il supporto alle <strong>coroutine</strong>: un programma Lua può avere diversi percorsi di esecuzione &lsquo;parallela&rsquo; ognuno col proprio stack e variabili locali ma che condividono risorse e variabili globali con le altre coroutine.</p><p>La prima differenza sostanziale col modello classico dei thread è che in un determinato istante &lsquo;gira&rsquo; una e una sola coroutine, mentre in un sistema multiprocessore ci possono essere più thread in esecuzione in contemporanea.</p><p>La seconda grande differenza è che nei thread c&rsquo;è una entità esterna (di solito lo scheduler del il sistema operativo) che sovrintende all&rsquo;ordine e assegna la &lsquo;fetta&rsquo; di processore a disposizione di ciascun thread, mentre in Lua ciascuna coroutine decide quando è il momento di “sospendersi” per lasciare la CPU alle altre.</p><p>In questo caso, si parla infatti di <strong>cooperative multitasking</strong>. Le ragioni di questa scelta degli autori sono molteplici: anzitutto la semplicità di implementazione, poi ricordiamo il fatto che Lua è nato come linguaggio &rsquo;embedded&rsquo;, perciò qualora ci fosse veramente bisogno dei thread si sfrutteranno le capacità del linguaggio ospitante.</p><p>Le funzionalità per gestire le coroutine in Lua sono raggruppate nel package <em>&lsquo;coroutine&rsquo;</em>. La prima funzione che serve è la create, che riceve come unico argomento una funzione e ritorna un valore di tipo thread:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#f92672>&gt;</span>co<span style=color:#f92672>=</span>coroutine.create(<span style=color:#66d9ef>function</span> () print <span style=color:#960050;background-color:#1e0010>“</span>ciao<span style=color:#960050;background-color:#1e0010>”</span> <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span>print(co)
</span></span><span style=display:flex><span>thread: <span style=color:#ae81ff>0x8408068</span></span></span></code></pre></div><p>una coroutine può avere tre stati: suspended, running, dead. Una coroutine appena creata è in stato <em>suspended</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#f92672>&gt;</span>print(coroutine.status(co))
</span></span><span style=display:flex><span>suspended</span></span></code></pre></div><p>quindi per avviarla chiamiamo <em>.resume</em> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#f92672>&gt;</span>coroutine.resume(co)
</span></span><span style=display:flex><span>ciao</span></span></code></pre></div><p>ora la routine è terminata:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#f92672>&gt;</span>print(coroutine.status(co))
</span></span><span style=display:flex><span>dead</span></span></code></pre></div><p>ogni coroutine può volontariamente <em>&lsquo;mettersi in pausa&rsquo;</em> e passare alcuni valori tramite la funzione <strong>yield</strong> ; vediamo un semplice esempio:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>NTHREADS<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ping</span>()
</span></span><span style=display:flex><span> print <span style=color:#e6db74>&#34;ping&#34;</span>
</span></span><span style=display:flex><span> coroutine.yield()
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>pong</span>()
</span></span><span style=display:flex><span>  print <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span>  coroutine.yield()
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>threads<span style=color:#f92672>=</span>{}
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> j<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,NTHREADS <span style=color:#66d9ef>do</span> 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> j<span style=color:#f92672>%</span><span style=color:#ae81ff>2</span><span style=color:#f92672>==</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    threads[j]<span style=color:#f92672>=</span>coroutine.create(pong)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    threads[j]<span style=color:#f92672>=</span>coroutine.create(ping)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>running<span style=color:#f92672>=</span><span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> running <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> j<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,NTHREADS <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    running<span style=color:#f92672>=</span>coroutine.resume(threads[j])
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></code></pre></div><p>se volessimo invece sfruttare i thread del sistema operativo, si possono utilizzare librerie come <a href=https://luarocks.org/modules/benoitgermain/lanes>Lanes</a> oppure <a href=https://luarocks.org/modules/moteus/lua-llthreads2>llthreads2</a> .</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/lua/>Lua</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>Programming</a></li><li><a href=https://ilmanzo.github.io/tags/tutorial/>Tutorial</a></li><li><a href=https://ilmanzo.github.io/tags/linux/>Linux</a></li><li><a href=https://ilmanzo.github.io/tags/italian/>Italian</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/migrating-a-repository-from-mercurial-to-git/><span class=title>« Prev</span><br><span>migrating a repository from mercurial to git</span>
</a><a class=next href=https://ilmanzo.github.io/post/il-linguaggio-lua-13/><span class=title>Next »</span><br><span>il linguaggio Lua: parte 13</span></a></nav></footer></article></main><footer class=footer><span>© 2012-2024 Andrea Manzini</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>