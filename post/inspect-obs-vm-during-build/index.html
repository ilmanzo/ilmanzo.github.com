<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Debugging a problematic build | ilManzo's blog</title>
<meta name=keywords content="linux,programming,testing,nim,building,obs"><meta name=description content="A technique to inspect Open Build Service build process"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/inspect-obs-vm-during-build/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/inspect-obs-vm-during-build/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL")}</script><meta property="og:title" content="Debugging a problematic build"><meta property="og:description" content="A technique to inspect Open Build Service build process"><meta property="og:type" content="article"><meta property="og:url" content="https://ilmanzo.github.io/post/inspect-obs-vm-during-build/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-03-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-14T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Debugging a problematic build"><meta name=twitter:description content="A technique to inspect Open Build Service build process"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"Debugging a problematic build","item":"https://ilmanzo.github.io/post/inspect-obs-vm-during-build/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Debugging a problematic build","name":"Debugging a problematic build","description":"A technique to inspect Open Build Service build process","keywords":["linux","programming","testing","nim","building","obs"],"articleBody":"The Good üòá Today I decided to submit an openSUSE package update for the nim compiler. It went almost all well but unfortunately I faced a problem: on the i586 platform it fails to build.\nIn this particolar situation, Open Build Service logs were not so useful. They only says that the vm running the build was terminated after 5400 seconds of inactivity, meaning that something got stuck and the system kindly waited a lot before terminating the process:\nThe Bad üòì [ 6748s] qemu-kvm: terminating on signal 15 from pid 14593 () [ 6748s] ### VM INTERACTION END ### [ 6748s] No buildstatus set, either the base system is broken (kernel/initrd/udev/glibc/bash/perl) [ 6748s] or the build host has a kernel or hardware problem... Job seems to be stuck here, killed. (after 5400 seconds of inactivity) So as a first move, I try to reproduce the problem on my local system:\n$ osc build openSUSE_Factory i586 (You may need to change the openSUSE_Factory parameter with one of the repositories you are building for, configured at project level)\nAfter some output, it hangs running the unit test suite; good news because means it‚Äôs a reproducible issue, but still we don‚Äôt know the reason.\nThe Ugly üò¶ Build happens inside a qemu-kvm virtual machine, which is spawned and killed on demand; can we break inside this vm ? Well, we could leverage the QEMU Monitor to send commands via an Unix Socket, but there‚Äôs another solution: osc has a cool option to start a telnet server in the build system.\n$ osc build openSUSE_Factory i586 --vm-telnet 8023 now finalizing build dir... ... running 01-add_abuild_user_to_trusted_group ... running 02-set_timezone_to_utc ... running 03-set-permissions-secure ... running 11-hack_uname_version_to_kernel_version ERROR: neither /sbin/ifconfig nor /sbin/ip is installed, please specify correct package via -x option [ 6.402979][ T1] sysrq: Power Off [ 6.414858][ T165] reboot: Power down Close enough, seems we only need to add some missing packages to the build virtual machine.\n$ osc build openSUSE_Factory i586 --clean -x procps -x psmisc -x psutils -x iproute2 -x telnet-server --shell-after-fail --vm-telnet 8023 I added the luxury of running top in the virtual machine; I mean, why not ? üò∫ After running the build command, we are free to telnet localhost 8023 and get a root shell inside our building environment.\nWe are inside! üòÅ Once here, it‚Äôs simple to make the build reach the hanging step, detect the problem from inside and solve with a simple fix in the .spec file. In this instance we need to exclude two GC test cases because they seems not running in a 32 bit networkless system, which is also worth to report upstream.\nPost Scriptum: Today it‚Äôs PI Day; Enjoy!\n","wordCount":"448","inLanguage":"en","datePublished":"2023-03-14T00:00:00Z","dateModified":"2023-03-14T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/inspect-obs-vm-during-build/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Debugging a problematic build</h1><div class=post-description>A technique to inspect Open Build Service build process</div><div class=post-meta><span title='2023-03-14 00:00:00 +0000 UTC'>March 14, 2023</span>&nbsp;¬∑&nbsp;Andrea Manzini</div></header><div class=post-content><h1 id=the-good--innocent>The Good &#x1f607;<a hidden class=anchor aria-hidden=true href=#the-good--innocent>#</a></h1><p>Today I decided to submit an openSUSE package update for the <a href=https://nim-lang.org/>nim compiler</a>.
It went almost all well but unfortunately I faced a problem: on the i586 platform it fails to build.</p><p>In this particolar situation, <a href=https://build.opensuse.org/>Open Build Service</a> logs were not so useful. They only says that the vm running the build was terminated after 5400 seconds of inactivity, meaning that something got stuck and the system kindly waited a lot before terminating the process:</p><h1 id=the-bad-sweat>The Bad &#x1f613;<a hidden class=anchor aria-hidden=true href=#the-bad-sweat>#</a></h1><pre><code>[ 6748s] qemu-kvm: terminating on signal 15 from pid 14593 (&lt;unknown process&gt;)
[ 6748s] ### VM INTERACTION END ###
[ 6748s] No buildstatus set, either the base system is broken (kernel/initrd/udev/glibc/bash/perl)
[ 6748s] or the build host has a kernel or hardware problem...


Job seems to be stuck here, killed. (after 5400 seconds of inactivity)
</code></pre><p>So as a first move, I try to reproduce the problem on my local system:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ osc build openSUSE_Factory i586</span></span></code></pre></div><p>(You may need to change the <code>openSUSE_Factory</code> parameter with one of the repositories you are building for, configured at project level)</p><p>After some output, it hangs running the unit test suite; good news because means it&rsquo;s a reproducible issue, but still <em>we don&rsquo;t know the reason</em>.</p><h1 id=the-ugly-frowning>The Ugly &#x1f626;<a hidden class=anchor aria-hidden=true href=#the-ugly-frowning>#</a></h1><p>Build happens inside a qemu-kvm virtual machine, which is spawned and killed on demand; can we break inside this vm ?
Well, we could leverage the <strong>QEMU Monitor</strong> to send commands via an <em>Unix Socket</em>, but there&rsquo;s another solution: <code>osc</code> has a cool option to start a telnet server in the build system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ osc build openSUSE_Factory i586 --vm-telnet <span style=color:#ae81ff>8023</span></span></span></code></pre></div><pre><code>now finalizing build dir...
... running 01-add_abuild_user_to_trusted_group
... running 02-set_timezone_to_utc
... running 03-set-permissions-secure
... running 11-hack_uname_version_to_kernel_version
ERROR: neither /sbin/ifconfig nor /sbin/ip is installed, please specify correct package via -x option
[    6.402979][    T1] sysrq: Power Off
[    6.414858][  T165] reboot: Power down
</code></pre><p>Close enough, seems we only need to add some missing packages to the build virtual machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ osc build openSUSE_Factory i586 --clean -x procps -x psmisc -x psutils -x iproute2 -x telnet-server --shell-after-fail --vm-telnet <span style=color:#ae81ff>8023</span></span></span></code></pre></div><p>I added the luxury of running <code>top</code> in the virtual machine; I mean, why not ? &#x1f63a;
After running the build command, we are free to <code>telnet localhost 8023</code> and get a root shell inside our building environment.</p><h1 id=we-are-inside-grin>We are inside! &#x1f601;<a hidden class=anchor aria-hidden=true href=#we-are-inside-grin>#</a></h1><p>Once here, it&rsquo;s simple to make the build reach the hanging step, detect the problem from inside and solve with a simple fix in the <code>.spec</code> file.
In this instance we need to exclude two GC test cases because they seems not running in a 32 bit networkless system, which is also worth to report upstream.</p><h1 id=post-scriptum>Post Scriptum:<a hidden class=anchor aria-hidden=true href=#post-scriptum>#</a></h1><p>Today it&rsquo;s <a href=https://en.wikipedia.org/wiki/Pi_Day>PI Day</a>; Enjoy!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/linux/>Linux</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>Programming</a></li><li><a href=https://ilmanzo.github.io/tags/testing/>Testing</a></li><li><a href=https://ilmanzo.github.io/tags/nim/>Nim</a></li><li><a href=https://ilmanzo.github.io/tags/building/>Building</a></li><li><a href=https://ilmanzo.github.io/tags/obs/>Obs</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/advent_of_benchmark/><span class=title>¬´ Prev</span><br><span>Benchmarking a Rust function</span>
</a><a class=next href=https://ilmanzo.github.io/post/suse-hackweek-2023-recap/><span class=title>Next ¬ª</span><br><span>a SUSE hackweek22 report</span></a></nav></footer></article></main><footer class=footer><span>¬© 2012-2024 Andrea Manzini</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>