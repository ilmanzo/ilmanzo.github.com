<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The Linux kernel ftrace | ilManzo's blog</title><meta name=keywords content="tutorial,linux,kernel,tracing,syscall,sysadmin,debug"><meta name=description content="Overview of the Linux kernel tracing feature"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/kernel_ftrace/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/kernel_ftrace/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL")}</script><meta property="og:url" content="https://ilmanzo.github.io/post/kernel_ftrace/"><meta property="og:site_name" content="ilManzo's blog"><meta property="og:title" content="The Linux kernel ftrace"><meta property="og:description" content="Overview of the Linux kernel tracing feature"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-10-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-01T00:00:00+00:00"><meta property="article:tag" content="Tutorial"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Kernel"><meta property="article:tag" content="Tracing"><meta property="article:tag" content="Syscall"><meta property="article:tag" content="Sysadmin"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Linux kernel ftrace"><meta name=twitter:description content="Overview of the Linux kernel tracing feature"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"The Linux kernel ftrace","item":"https://ilmanzo.github.io/post/kernel_ftrace/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The Linux kernel ftrace","name":"The Linux kernel ftrace","description":"Overview of the Linux kernel tracing feature","keywords":["tutorial","linux","kernel","tracing","syscall","sysadmin","debug"],"articleBody":"üë£ Intro Tracing tools are pretty popular in the Unix/Linux ecosystem; for example in the userspace we have ltrace to trace library calls of the programs and strace to dive in deeper and inspect syscall usage.\nOne of the many features that Linux kernel offers since 2008 (then evolved) is ftrace that allows many different kind of tracing at runtime. While not as flexible as eBPF technology, it can be helpful in some occasion and doesn‚Äôt require a full fledged programming language.\nPhoto by Karolina Kaboompics\nüê§ The basics First of all, let‚Äôs be sure that your kernel is compiled with the option CONFIG_FTRACE and the tracing virtual filesystem is mounted:\n# mount | grep tracefs tracefs on /sys/kernel/tracing type tracefs (rw,nosuid,nodev,noexec,relatime) so we can inspect its handy user-level interface.\n# cd /sys/kernel/tracing # cat current_tracer nop # cat README tracing mini-HOWTO: # echo 0 \u003e tracing_on : quick way to disable tracing # echo 1 \u003e tracing_on : quick way to re-enable tracing Important files: trace - The static contents of the buffer To clear the buffer write into this file: echo \u003e trace trace_pipe - A consuming read to see the contents of the buffer current_tracer - function and latency tracers available_tracers - list of configured tracers for current_tracer error_log - error log for failed commands (that support it) buffer_size_kb - view and modify size of per cpu buffer buffer_total_size_kb - view total size of all cpu buffers Lots of stuff ongoing here; we have even a cool README with some documentation but let‚Äôs do it step by step. the (virtual) file current_tracer contains nop, which means no tracer is enabled. We need to change it in order to trace something, and we have a long list of choices:\nü§î What can I do ? # cat /sys/kernel/tracing/available_tracers timerlat osnoise blk function_graph wakeup_dl wakeup_rt wakeup function nop function tracers: function, function_graph latency tracers: wakeup_dl, wakeup_rt, irqsoff, wakeup, timerlat I/O tracers: blk IRQ/NMI: osnoise, hwlat To enable a tracer, we just have to write its name to current_tracer:\n# echo function \u003e current_tracer At this point you can turn on tracing with echo 1 \u003e tracing_on and start reading from the trace virtual file (which contains the content of the trace buffer) or trace_pipe (which streams tracing datapoints while we read them).\nüîß A better tool If dealing with filesystem may be a bit cumbersome, there is an handy command-line tool created by Steven Rostedt and called trace-cmd:\n$ sudo zypper in trace-cmd Loading repository data... Reading installed packages... Resolving package dependencies... The following 3 NEW packages are going to be installed: libtraceevent1 libtracefs1 trace-cmd 3 new packages to install. Let‚Äôs see some usage examples:\n# trace-cmd start -p function starts tracing with the function tracer (displays function calls); once started, you can see the data with\n# trace-cmd show # tracer: function # # entries-in-buffer/entries-written: 51265/8953395 #P:1 # # _-----=\u003e irqs-off/BH-disabled # / _----=\u003e need-resched # | / _---=\u003e hardirq/softirq # || / _--=\u003e preempt-depth # ||| / _-=\u003e migrate-disable # |||| / delay # TASK-PID CPU# ||||| TIMESTAMP FUNCTION # | | | ||||| | | sshd-session-3242 [000] d..3. 5838.785487: finish_task_switch.isra.0 \u003c-__schedule sshd-session-3242 [000] d..3. 5838.785488: _raw_spin_unlock \u003c-finish_task_switch.isra.0 sshd-session-3242 [000] ...1. 5838.785489: __fdget \u003c-do_sys_poll sshd-session-3242 [000] ...1. 5838.785490: sock_poll \u003c-do_sys_poll sshd-session-3242 [000] ...1. 5838.785490: tcp_poll \u003c-sock_poll sshd-session-3242 [000] ...1. 5838.785491: tcp_stream_memory_free \u003c-tcp_poll sshd-session-3242 [000] ...1. 5838.785492: __fdget \u003c-do_sys_poll sshd-session-3242 [000] ...1. 5838.785492: sock_poll \u003c-do_sys_poll sshd-session-3242 [000] ...1. 5838.785493: tcp_poll \u003c-sock_poll sshd-session-3242 [000] ...1. 5838.785493: tcp_stream_memory_free \u003c-tcp_poll sshd-session-3242 [000] ...1. 5838.785494: __fdget \u003c-do_sys_poll sshd-session-3242 [000] ...1. 5838.785495: tty_poll \u003c-do_sys_poll sshd-session-3242 [000] ...1. 5838.785495: tty_ldisc_ref_wait \u003c-tty_poll sshd-session-3242 [000] ...1. 5838.785496: ldsem_down_read \u003c-tty_ldisc_ref_wait sshd-session-3242 [000] ...1. 5838.785496: __cond_resched \u003c-ldsem_down_read sshd-session-3242 [000] ...1. 5838.785497: n_tty_poll \u003c-tty_poll sshd-session-3242 [000] ...1. 5838.785500: tty_buffer_flush_work \u003c-n_tty_poll sshd-session-3242 [000] ...1. 5838.785500: flush_work \u003c-n_tty_poll sshd-session-3242 [000] ...1. 5838.785501: __cond_resched \u003c-flush_work sshd-session-3242 [000] ...1. 5838.785501: __flush_work \u003c-n_tty_poll sshd-session-3242 [000] ...1. 5838.785502: __rcu_read_lock \u003c-__flush_work sshd-session-3242 [000] ...1. 5838.785502: _raw_spin_lock_irq \u003c-__flush_work sshd-session-3242 [000] d..2. 5838.785505: _raw_spin_unlock_irq \u003c-__flush_work sshd-session-3242 [000] ...1. 5838.785506: __rcu_read_unlock \u003c-__flush_work sshd-session-3242 [000] ...1. 5838.785506: tty_hung_up_p \u003c-n_tty_poll sshd-session-3242 [000] ...1. 5838.785507: mutex_is_locked \u003c-n_tty_poll sshd-session-3242 [000] ...1. 5838.785507: tty_chars_in_buffer \u003c-n_tty_poll sshd-session-3242 [000] ...1. 5838.785508: tty_write_room \u003c-n_tty_poll sshd-session-3242 [000] ...1. 5838.785508: pty_write_room \u003c-n_tty_poll sshd-session-3242 [000] ...1. 5838.785509: tty_buffer_space_avail \u003c-n_tty_poll And stop with # trace-cmd stop ; you can also clear the buffer with # trace-cmd clear -a or perform both tasks with a simple # trace-cmd reset.\nAn example with a different tracer :\n# trace-cmd start -p function_graph --max-graph-depth 5 Starts tracing all the called function (up to 5 levels deep). Beware it may produce an huge amount of data:\n# trace-cmd show # tracer: function_graph # # CPU DURATION FUNCTION CALLS # | | | | | | | ------------------------------------------ 0) sshd-se-3242 =\u003e kworker-3680 ------------------------------------------ 0) | finish_task_switch.isra.0() { 0) 0.621 us | _raw_spin_unlock(); 0) 1.884 us | } 0) ! 200.114 us | } /* __cond_resched */ 0) 0.601 us | mutex_unlock(); 0) ! 225.651 us | } /* flush_to_ldisc */ 0) 0.591 us | __cond_resched(); 0) 0.592 us | _raw_spin_lock_irq(); 0) 0.630 us | pwq_dec_nr_in_flight(); 0) ! 233.837 us | } /* process_one_work */ 0) | process_one_work() { 0) 0.591 us | kick_pool(); 0) 0.591 us | set_work_pool_and_clear_pending(); 0) 0.591 us | _raw_spin_unlock_irq(); 0) | wq_barrier_func() { 0) | complete() { 0) 0.601 us | _raw_spin_lock_irqsave(); 0) | try_to_wake_up() { 0) 0.591 us | _raw_spin_lock_irqsave(); 0) 0.611 us | ttwu_queue_wakelist(); 0) 0.861 us | raw_spin_rq_lock_nested(); 0) 0.711 us | update_rq_clock(); 0) 6.762 us | ttwu_do_activate(); 0) 0.591 us | _raw_spin_unlock(); 0) 0.611 us | _raw_spin_unlock_irqrestore(); 0) + 15.138 us | } 0) 0.611 us | _raw_spin_unlock_irqrestore(); 0) + 18.515 us | } 0) + 19.627 us | } 0) 0.601 us | __cond_resched(); 0) 0.601 us | _raw_spin_lock_irq(); 0) 0.601 us | pwq_dec_nr_in_flight(); 0) + 27.621 us | } 0) 0.622 us | worker_enter_idle(); 0) 0.592 us | _raw_spin_unlock_irq(); 0) | schedule() { 0) | wq_worker_sleeping() { 0) 0.611 us | kthread_data(); 0) 1.763 us | } 0) 0.621 us | rcu_note_context_switch(); 0) | raw_spin_rq_lock_nested() { 0) 0.590 us | _raw_spin_lock(); 0) 1.694 us | } 0) 0.712 us | update_rq_clock(); 0) | dequeue_task() { Will display a nice view of the nested function calls that happens in the kernel, with the timing in microseconds on the side.\nüìº Recording and filtering This tool can also work by ‚Äúrecording‚Äù in a data file all the collected trace point, then we can use the same utility or also other to inspect the data. This is specially useful for rare events or if you need to debug special issues that seems to occur randomly.\n# trace-cmd record will start tracing and writing the data to a file (named by default trace.dat). After stopping the trace, you can then display the data with\n# trace-cmd report A filter on the irq_handler event and function do_IRQ will display how long the IRQ takes in the kernel:\n# trace-cmd record -p function_graph -l do_IRQ -e irq_handler_entry sleep 10 # trace-cmd report | grep irq_handler_entry -A 2 sleep-4253 [000] 7340.590340: irq_handler_entry: irq=27 name=virtio2-input.0 sleep-4253 [000] 7340.590340: funcgraph_entry: 4.438 us | vring_interrupt(); sleep-4253 [000] 7340.590345: funcgraph_exit: 6.201 us | } -- sleep-4253 [000] 7340.590767: irq_handler_entry: irq=28 name=virtio2-output.0 sleep-4253 [000] 7340.590769: funcgraph_exit: 3.136 us | } sleep-4253 [000] 7340.590769: funcgraph_entry: 0.270 us | _raw_spin_unlock(); -- -0 [000] 7340.610004: irq_handler_entry: irq=27 name=virtio2-input.0 -0 [000] 7340.610011: funcgraph_exit: 8.436 us | } -0 [000] 7340.610011: funcgraph_entry: 1.031 us | add_interrupt_randomness(); -- sshd-session-3242 [000] 7340.610566: irq_handler_entry: irq=28 name=virtio2-output.0 sshd-session-3242 [000] 7340.610571: funcgraph_exit: 8.456 us | } sshd-session-3242 [000] 7340.610572: funcgraph_entry: + 11.051 us | irq_exit_rcu(); To display all the (kernel) memory operations allocation smaller than 512 bytes, we can filter on kmalloc event and a specific field:\n# trace-cmd record -e kmem:kmalloc -f 'bytes_req \u003c 512' sshd-session-3242 [000] 8115.304880: kmalloc: call_site=virtqueue_add_split+0xa9 ptr=0xffff95c7d458d300 bytes_req=32 bytes_alloc=32 gfp_flags=0x820 node=-1 accounted=false sshd-session-3242 [000] 8115.325365: kmalloc: call_site=virtqueue_add_split+0xa9 ptr=0xffff95c7d458d1c0 bytes_req=32 bytes_alloc=32 gfp_flags=0x820 node=-1 accounted=false sshd-session-3242 [000] 8115.344938: kmalloc: call_site=virtqueue_add_split+0xa9 ptr=0xffff95c7d458d1c0 bytes_req=32 bytes_alloc=32 gfp_flags=0x820 node=-1 accounted=false sshd-session-3242 [000] 8115.364728: kmalloc: call_site=virtqueue_add_split+0xa9 ptr=0xffff95c7d458d1c0 bytes_req=32 bytes_alloc=32 gfp_flags=0x820 node=-1 accounted=false sshd-session-3242 [000] 8115.385613: kmalloc: call_site=virtqueue_add_split+0xa9 ptr=0xffff95c7d458d1c0 bytes_req=32 bytes_alloc=32 gfp_flags=0x820 node=-1 accounted=false sshd-session-3242 [000] 8115.405250: kmalloc: call_site=virtqueue_add_split+0xa9 ptr=0xffff95c7d458d1c0 bytes_req=32 bytes_alloc=32 gfp_flags=0x820 node=-1 accounted=false sshd-session-3242 [000] 8115.426718: kmalloc: call_site=virtqueue_add_split+0xa9 ptr=0xffff95c7d458d1c0 bytes_req=32 bytes_alloc=32 gfp_flags=0x820 node=-1 accounted=false To get all available functions/events/tracers and so on you can use the list options.\n# trace-cmd list -h trace-cmd version 3.2.0 (3.2.0) usage: trace-cmd list [-e [regex]][-t][-o][-f [regex]] -e list available events -F show event format --full show the print fmt with -F -R show event triggers -l show event filters -t list available tracers -o list available options -f [regex] list available functions to filter on -P list loaded plugin files (by path) -O list plugin options -B list defined buffer instances -C list the defined clocks (and active one) -c list the supported trace file compression algorithms üé© Some tricks and tips Instead of analyzing the whole system, you may want to trace kernel activities only relative to a specific process (PID); with the -P option:\n# trace-cmd record -p function -P 174 on system with very low disk space (like embedded boards), you cannot easily store big trace files to be analyzed later. trace-cmd can send the trace remotely over a network. Just start it on the host with the listen port option:\n# trace-cmd listen -p 12345 -D and then on the device you can ‚Äúsave‚Äù events and data to the remote peer:\n# trace-cmd record -N mypc.local.net:12345 [tracing options] A trick for module developers : trace only some specific kernel mod by searching for functions that ends with ] (partial output):\n# lsmod | grep thinkpad thinkpad_acpi 196608 0 platform_profile 12288 1 thinkpad_acpi sparse_keymap 12288 1 thinkpad_acpi rfkill 40960 9 bluetooth,thinkpad_acpi,cfg80211 snd 159744 57 snd_ctl_led,snd_hda_codec_generic,snd_seq,snd_seq_device,snd_hda_codec_hdmi,snd_hwdep,snd_hda_intel,snd_usb_audio,snd_usbmidi_lib,snd_hda_codec,snd_hda_codec_realtek,snd_sof,snd_timer,snd_compress,thinkpad_acpi,snd_soc_core,snd_ump,snd_pcm,snd_rawmidi video 81920 2 thinkpad_acpi,amdgpu battery 28672 1 thinkpad_acpi # trace-cmd list -f | grep 'thinkpad_acpi]$ | grep bluetooh' bluetooth_attr_is_visible [thinkpad_acpi] bluetooth_set_status [thinkpad_acpi] bluetooth_get_status [thinkpad_acpi] bluetooth_exit [thinkpad_acpi] bluetooth_shutdown [thinkpad_acpi] bluetooth_enable_store [thinkpad_acpi] bluetooth_enable_show [thinkpad_acpi] bluetooth_write [thinkpad_acpi] bluetooth_read [thinkpad_acpi] and see what useful functions we can put under our trace, or check how our newly developed module is behaving.\nüèÑ‚Äç‚ôÇÔ∏è Outro and references: If you are into kernel development or just curious about how Linux internals work, you can rely on this useful feature to get interesting insights of your system. I‚Äôll leave here some other websites and blog post that talks about ftrace:\nthe official Kernel documentation A nice Blog Post from Sergio Prado Two posts on opensource.com from Gaurav Kamathe: 1 and 2 An (old but gold) LWN article If you are interested in the topic as I am, feel free to drop me any comment or feedback and I will be happy to have a follow up üòâ\nThanks for reading and Happy hacking!\n","wordCount":"1779","inLanguage":"en","datePublished":"2024-10-01T00:00:00Z","dateModified":"2024-10-01T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/kernel_ftrace/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">The Linux kernel ftrace</h1><div class=post-description>Overview of the Linux kernel tracing feature</div><div class=post-meta><span title='2024-10-01 00:00:00 +0000 UTC'>October 1, 2024</span>&nbsp;¬∑&nbsp;Andrea Manzini</div></header><div class=post-content><h2 id=-intro>üë£ Intro<a hidden class=anchor aria-hidden=true href=#-intro>#</a></h2><p>Tracing tools are pretty popular in the Unix/Linux ecosystem; for example in the userspace we have <a href=https://man7.org/linux/man-pages/man1/ltrace.1.html>ltrace</a> to trace library calls of the programs and <a href=https://en.wikipedia.org/wiki/Strace>strace</a> to dive in deeper and inspect syscall usage.</p><p>One of the many features that Linux kernel offers since 2008 (then evolved) is <a href=https://www.kernel.org/doc/html/latest/trace/ftrace.html>ftrace</a> that allows many different kind of tracing at runtime. While not as flexible as <a href=https://ebpf.io/>eBPF</a> technology, it can be helpful in some occasion and doesn&rsquo;t require a full fledged programming language.</p><p><img alt=traces loading=lazy src=/img/pexels-karolina-grabowska-6633887.jpg>
<a href=https://www.pexels.com/photo/close-up-of-sidewalk-covered-in-snow-6633887/>Photo by Karolina Kaboompics</a></p><h2 id=-the-basics>üê§ The basics<a hidden class=anchor aria-hidden=true href=#-the-basics>#</a></h2><p>First of all, let&rsquo;s be sure that your kernel is compiled with the option CONFIG_FTRACE and the tracing virtual filesystem is mounted:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># mount | grep tracefs</span>
</span></span><span style=display:flex><span>tracefs on /sys/kernel/tracing type tracefs <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>so we can inspect its handy user-level interface.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cd /sys/kernel/tracing</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cat current_tracer </span>
</span></span><span style=display:flex><span>nop
</span></span><span style=display:flex><span><span style=color:#75715e># cat README</span>
</span></span><span style=display:flex><span>tracing mini-HOWTO:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo 0 &gt; tracing_on : quick way to disable tracing</span>
</span></span><span style=display:flex><span><span style=color:#75715e># echo 1 &gt; tracing_on : quick way to re-enable tracing</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Important files:
</span></span><span style=display:flex><span>  trace                 - The static contents of the buffer
</span></span><span style=display:flex><span>                          To clear the buffer write into this file: echo &gt; trace
</span></span><span style=display:flex><span>  trace_pipe            - A consuming read to see the contents of the buffer
</span></span><span style=display:flex><span>  current_tracer        - <span style=color:#66d9ef>function</span> and latency tracers
</span></span><span style=display:flex><span>  available_tracers     - list of configured tracers <span style=color:#66d9ef>for</span> current_tracer
</span></span><span style=display:flex><span>  error_log     - error log <span style=color:#66d9ef>for</span> failed commands <span style=color:#f92672>(</span>that support it<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  buffer_size_kb        - view and modify size of per cpu buffer
</span></span><span style=display:flex><span>  buffer_total_size_kb  - view total size of all cpu buffers
</span></span></code></pre></div><p>Lots of stuff ongoing here; we have even a cool <em>README</em> with some documentation but let&rsquo;s do it step by step.
the (virtual) file <code>current_tracer</code> contains <code>nop</code>, which means no tracer is enabled. We need to change it in order to trace something, and we have a long list of choices:</p><h2 id=-what-can-i-do->ü§î What can I do ?<a hidden class=anchor aria-hidden=true href=#-what-can-i-do->#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># cat /sys/kernel/tracing/available_tracers </span>
</span></span><span style=display:flex><span>timerlat osnoise blk function_graph wakeup_dl wakeup_rt wakeup <span style=color:#66d9ef>function</span> nop
</span></span></code></pre></div><ul><li>function tracers: <code>function</code>, <code>function_graph</code></li><li>latency tracers: <code>wakeup_dl</code>, <code>wakeup_rt</code>, <code>irqsoff</code>, <code>wakeup</code>, <code>timerlat</code></li><li>I/O tracers: <code>blk</code></li><li>IRQ/NMI: <code>osnoise</code>, <code>hwlat</code></li></ul><p>To enable a tracer, we just have to write its name to current_tracer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo function &gt; current_tracer</span>
</span></span></code></pre></div><p>At this point you can turn on tracing with <code>echo 1 > tracing_on</code> and start reading from the <code>trace</code> virtual file (which contains the content of the trace buffer) or <code>trace_pipe</code> (which streams tracing datapoints while we read them).</p><h2 id=-a-better-tool>üîß A better tool<a hidden class=anchor aria-hidden=true href=#-a-better-tool>#</a></h2><p>If dealing with filesystem may be a bit cumbersome, there is an handy command-line tool created by <a href=https://github.com/rostedt>Steven Rostedt</a> and called <code>trace-cmd</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo zypper in trace-cmd
</span></span><span style=display:flex><span>Loading repository data...
</span></span><span style=display:flex><span>Reading installed packages...
</span></span><span style=display:flex><span>Resolving package dependencies...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The following <span style=color:#ae81ff>3</span> NEW packages are going to be installed:
</span></span><span style=display:flex><span>  libtraceevent1 libtracefs1 trace-cmd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span> new packages to install.
</span></span></code></pre></div><p>Let&rsquo;s see some usage examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd start -p function</span>
</span></span></code></pre></div><p>starts tracing with the <code>function</code> tracer (displays function calls); once started, you can see the data with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd show</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># tracer: function
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span># entries-in-buffer/entries-written: 51265/8953395   #P:1
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span>#                                _-----=&gt; irqs-off/BH-disabled
</span></span><span style=display:flex><span>#                               / _----=&gt; need-resched
</span></span><span style=display:flex><span>#                              | / _---=&gt; hardirq/softirq
</span></span><span style=display:flex><span>#                              || / _--=&gt; preempt-depth
</span></span><span style=display:flex><span>#                              ||| / _-=&gt; migrate-disable
</span></span><span style=display:flex><span>#                              |||| /     delay
</span></span><span style=display:flex><span>#           TASK-PID     CPU#  |||||  TIMESTAMP  FUNCTION
</span></span><span style=display:flex><span>#              | |         |   |||||     |         |
</span></span><span style=display:flex><span>    sshd-session-3242    [000] d..3.  5838.785487: finish_task_switch.isra.0 &lt;-__schedule
</span></span><span style=display:flex><span>    sshd-session-3242    [000] d..3.  5838.785488: _raw_spin_unlock &lt;-finish_task_switch.isra.0
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785489: __fdget &lt;-do_sys_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785490: sock_poll &lt;-do_sys_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785490: tcp_poll &lt;-sock_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785491: tcp_stream_memory_free &lt;-tcp_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785492: __fdget &lt;-do_sys_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785492: sock_poll &lt;-do_sys_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785493: tcp_poll &lt;-sock_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785493: tcp_stream_memory_free &lt;-tcp_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785494: __fdget &lt;-do_sys_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785495: tty_poll &lt;-do_sys_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785495: tty_ldisc_ref_wait &lt;-tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785496: ldsem_down_read &lt;-tty_ldisc_ref_wait
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785496: __cond_resched &lt;-ldsem_down_read
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785497: n_tty_poll &lt;-tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785500: tty_buffer_flush_work &lt;-n_tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785500: flush_work &lt;-n_tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785501: __cond_resched &lt;-flush_work
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785501: __flush_work &lt;-n_tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785502: __rcu_read_lock &lt;-__flush_work
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785502: _raw_spin_lock_irq &lt;-__flush_work
</span></span><span style=display:flex><span>    sshd-session-3242    [000] d..2.  5838.785505: _raw_spin_unlock_irq &lt;-__flush_work
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785506: __rcu_read_unlock &lt;-__flush_work
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785506: tty_hung_up_p &lt;-n_tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785507: mutex_is_locked &lt;-n_tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785507: tty_chars_in_buffer &lt;-n_tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785508: tty_write_room &lt;-n_tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785508: pty_write_room &lt;-n_tty_poll
</span></span><span style=display:flex><span>    sshd-session-3242    [000] ...1.  5838.785509: tty_buffer_space_avail &lt;-n_tty_poll
</span></span></code></pre></div><p>And stop with <code># trace-cmd stop</code> ; you can also clear the buffer with <code># trace-cmd clear -a</code> or perform both tasks with a simple <code># trace-cmd reset</code>.</p><p>An example with a different tracer :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd start -p function_graph --max-graph-depth 5</span>
</span></span></code></pre></div><p>Starts tracing all the called function (up to 5 levels deep). Beware it may produce an huge amount of data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd show</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># tracer: function_graph
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span># CPU  DURATION                  FUNCTION CALLS
</span></span><span style=display:flex><span># |     |   |                     |   |   |   |
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> ------------------------------------------
</span></span><span style=display:flex><span> 0)  sshd-se-3242  =&gt;  kworker-3680 
</span></span><span style=display:flex><span> ------------------------------------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 0)               |        finish_task_switch.isra.0() {
</span></span><span style=display:flex><span> 0)   0.621 us    |          _raw_spin_unlock();
</span></span><span style=display:flex><span> 0)   1.884 us    |        }
</span></span><span style=display:flex><span> 0) ! 200.114 us  |      } /* __cond_resched */
</span></span><span style=display:flex><span> 0)   0.601 us    |      mutex_unlock();
</span></span><span style=display:flex><span> 0) ! 225.651 us  |    } /* flush_to_ldisc */
</span></span><span style=display:flex><span> 0)   0.591 us    |    __cond_resched();
</span></span><span style=display:flex><span> 0)   0.592 us    |    _raw_spin_lock_irq();
</span></span><span style=display:flex><span> 0)   0.630 us    |    pwq_dec_nr_in_flight();
</span></span><span style=display:flex><span> 0) ! 233.837 us  |  } /* process_one_work */
</span></span><span style=display:flex><span> 0)               |  process_one_work() {
</span></span><span style=display:flex><span> 0)   0.591 us    |    kick_pool();
</span></span><span style=display:flex><span> 0)   0.591 us    |    set_work_pool_and_clear_pending();
</span></span><span style=display:flex><span> 0)   0.591 us    |    _raw_spin_unlock_irq();
</span></span><span style=display:flex><span> 0)               |    wq_barrier_func() {
</span></span><span style=display:flex><span> 0)               |      complete() {
</span></span><span style=display:flex><span> 0)   0.601 us    |        _raw_spin_lock_irqsave();
</span></span><span style=display:flex><span> 0)               |        try_to_wake_up() {
</span></span><span style=display:flex><span> 0)   0.591 us    |          _raw_spin_lock_irqsave();
</span></span><span style=display:flex><span> 0)   0.611 us    |          ttwu_queue_wakelist();
</span></span><span style=display:flex><span> 0)   0.861 us    |          raw_spin_rq_lock_nested();
</span></span><span style=display:flex><span> 0)   0.711 us    |          update_rq_clock();
</span></span><span style=display:flex><span> 0)   6.762 us    |          ttwu_do_activate();
</span></span><span style=display:flex><span> 0)   0.591 us    |          _raw_spin_unlock();
</span></span><span style=display:flex><span> 0)   0.611 us    |          _raw_spin_unlock_irqrestore();
</span></span><span style=display:flex><span> 0) + 15.138 us   |        }
</span></span><span style=display:flex><span> 0)   0.611 us    |        _raw_spin_unlock_irqrestore();
</span></span><span style=display:flex><span> 0) + 18.515 us   |      }
</span></span><span style=display:flex><span> 0) + 19.627 us   |    }
</span></span><span style=display:flex><span> 0)   0.601 us    |    __cond_resched();
</span></span><span style=display:flex><span> 0)   0.601 us    |    _raw_spin_lock_irq();
</span></span><span style=display:flex><span> 0)   0.601 us    |    pwq_dec_nr_in_flight();
</span></span><span style=display:flex><span> 0) + 27.621 us   |  }
</span></span><span style=display:flex><span> 0)   0.622 us    |  worker_enter_idle();
</span></span><span style=display:flex><span> 0)   0.592 us    |  _raw_spin_unlock_irq();
</span></span><span style=display:flex><span> 0)               |  schedule() {
</span></span><span style=display:flex><span> 0)               |    wq_worker_sleeping() {
</span></span><span style=display:flex><span> 0)   0.611 us    |      kthread_data();
</span></span><span style=display:flex><span> 0)   1.763 us    |    }
</span></span><span style=display:flex><span> 0)   0.621 us    |    rcu_note_context_switch();
</span></span><span style=display:flex><span> 0)               |    raw_spin_rq_lock_nested() {
</span></span><span style=display:flex><span> 0)   0.590 us    |      _raw_spin_lock();
</span></span><span style=display:flex><span> 0)   1.694 us    |    }
</span></span><span style=display:flex><span> 0)   0.712 us    |    update_rq_clock();
</span></span><span style=display:flex><span> 0)               |    dequeue_task() {
</span></span></code></pre></div><p>Will display a nice view of the nested function calls that happens in the kernel, with the timing in microseconds on the side.</p><h2 id=-recording-and-filtering>üìº Recording and filtering<a hidden class=anchor aria-hidden=true href=#-recording-and-filtering>#</a></h2><p>This tool can also work by &ldquo;recording&rdquo; in a data file all the collected trace point, then we can use the same utility or also <a href=https://kernelshark.org/>other</a> to inspect the data.
This is specially useful for rare events or if you need to debug special issues that seems to occur randomly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd record</span>
</span></span></code></pre></div><p>will start tracing and writing the data to a file (named by default <code>trace.dat</code>). After stopping the trace, you can then display the data with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd report</span>
</span></span></code></pre></div><p>A filter on the <code>irq_handler</code> event and function <code>do_IRQ</code> will display how long the IRQ takes in the kernel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd record -p function_graph -l do_IRQ -e irq_handler_entry sleep 10</span>
</span></span><span style=display:flex><span><span style=color:#75715e># trace-cmd report | grep irq_handler_entry -A 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>           sleep-4253  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.590340: irq_handler_entry:    irq<span style=color:#f92672>=</span><span style=color:#ae81ff>27</span> name<span style=color:#f92672>=</span>virtio2-input.0
</span></span><span style=display:flex><span>           sleep-4253  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.590340: funcgraph_entry:        4.438 us   |          vring_interrupt<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>           sleep-4253  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.590345: funcgraph_exit:         6.201 us   |        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>           sleep-4253  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.590767: irq_handler_entry:    irq<span style=color:#f92672>=</span><span style=color:#ae81ff>28</span> name<span style=color:#f92672>=</span>virtio2-output.0
</span></span><span style=display:flex><span>           sleep-4253  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.590769: funcgraph_exit:         3.136 us   |          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>           sleep-4253  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.590769: funcgraph_entry:        0.270 us   |          _raw_spin_unlock<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>          &lt;idle&gt;-0     <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.610004: irq_handler_entry:    irq<span style=color:#f92672>=</span><span style=color:#ae81ff>27</span> name<span style=color:#f92672>=</span>virtio2-input.0
</span></span><span style=display:flex><span>          &lt;idle&gt;-0     <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.610011: funcgraph_exit:         8.436 us   |          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          &lt;idle&gt;-0     <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.610011: funcgraph_entry:        1.031 us   |          add_interrupt_randomness<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>--
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.610566: irq_handler_entry:    irq<span style=color:#f92672>=</span><span style=color:#ae81ff>28</span> name<span style=color:#f92672>=</span>virtio2-output.0
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.610571: funcgraph_exit:         8.456 us   |          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  7340.610572: funcgraph_entry:      + 11.051 us  |          irq_exit_rcu<span style=color:#f92672>()</span>;
</span></span></code></pre></div><p>To display all the (kernel) memory operations allocation smaller than 512 bytes, we can filter on <code>kmalloc</code> event and a specific field:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd record -e kmem:kmalloc -f &#39;bytes_req &lt; 512&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  8115.304880: kmalloc:              call_site<span style=color:#f92672>=</span>virtqueue_add_split+0xa9 ptr<span style=color:#f92672>=</span>0xffff95c7d458d300 bytes_req<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> bytes_alloc<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> gfp_flags<span style=color:#f92672>=</span>0x820 node<span style=color:#f92672>=</span>-1 accounted<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  8115.325365: kmalloc:              call_site<span style=color:#f92672>=</span>virtqueue_add_split+0xa9 ptr<span style=color:#f92672>=</span>0xffff95c7d458d1c0 bytes_req<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> bytes_alloc<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> gfp_flags<span style=color:#f92672>=</span>0x820 node<span style=color:#f92672>=</span>-1 accounted<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  8115.344938: kmalloc:              call_site<span style=color:#f92672>=</span>virtqueue_add_split+0xa9 ptr<span style=color:#f92672>=</span>0xffff95c7d458d1c0 bytes_req<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> bytes_alloc<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> gfp_flags<span style=color:#f92672>=</span>0x820 node<span style=color:#f92672>=</span>-1 accounted<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  8115.364728: kmalloc:              call_site<span style=color:#f92672>=</span>virtqueue_add_split+0xa9 ptr<span style=color:#f92672>=</span>0xffff95c7d458d1c0 bytes_req<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> bytes_alloc<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> gfp_flags<span style=color:#f92672>=</span>0x820 node<span style=color:#f92672>=</span>-1 accounted<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  8115.385613: kmalloc:              call_site<span style=color:#f92672>=</span>virtqueue_add_split+0xa9 ptr<span style=color:#f92672>=</span>0xffff95c7d458d1c0 bytes_req<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> bytes_alloc<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> gfp_flags<span style=color:#f92672>=</span>0x820 node<span style=color:#f92672>=</span>-1 accounted<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  8115.405250: kmalloc:              call_site<span style=color:#f92672>=</span>virtqueue_add_split+0xa9 ptr<span style=color:#f92672>=</span>0xffff95c7d458d1c0 bytes_req<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> bytes_alloc<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> gfp_flags<span style=color:#f92672>=</span>0x820 node<span style=color:#f92672>=</span>-1 accounted<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>    sshd-session-3242  <span style=color:#f92672>[</span>000<span style=color:#f92672>]</span>  8115.426718: kmalloc:              call_site<span style=color:#f92672>=</span>virtqueue_add_split+0xa9 ptr<span style=color:#f92672>=</span>0xffff95c7d458d1c0 bytes_req<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> bytes_alloc<span style=color:#f92672>=</span><span style=color:#ae81ff>32</span> gfp_flags<span style=color:#f92672>=</span>0x820 node<span style=color:#f92672>=</span>-1 accounted<span style=color:#f92672>=</span>false
</span></span></code></pre></div><p>To get all available functions/events/tracers and so on you can use the <code>list</code> <a href=https://www.man7.org/linux/man-pages/man1/trace-cmd-list.1.html>options</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd list -h</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trace-cmd version 3.2.0 <span style=color:#f92672>(</span>3.2.0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>usage:
</span></span><span style=display:flex><span> trace-cmd list <span style=color:#f92672>[</span>-e <span style=color:#f92672>[</span>regex<span style=color:#f92672>]][</span>-t<span style=color:#f92672>][</span>-o<span style=color:#f92672>][</span>-f <span style=color:#f92672>[</span>regex<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>          -e list available events
</span></span><span style=display:flex><span>            -F show event format
</span></span><span style=display:flex><span>            --full show the print fmt with -F
</span></span><span style=display:flex><span>            -R show event triggers
</span></span><span style=display:flex><span>            -l show event filters
</span></span><span style=display:flex><span>          -t list available tracers
</span></span><span style=display:flex><span>          -o list available options
</span></span><span style=display:flex><span>          -f <span style=color:#f92672>[</span>regex<span style=color:#f92672>]</span> list available functions to filter on
</span></span><span style=display:flex><span>          -P list loaded plugin files <span style=color:#f92672>(</span>by path<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          -O list plugin options
</span></span><span style=display:flex><span>          -B list defined buffer instances
</span></span><span style=display:flex><span>          -C list the defined clocks <span style=color:#f92672>(</span>and active one<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          -c list the supported trace file compression algorithms
</span></span></code></pre></div><h2 id=-some-tricks-and-tips>üé© Some tricks and tips<a hidden class=anchor aria-hidden=true href=#-some-tricks-and-tips>#</a></h2><p>Instead of analyzing the whole system, you may want to trace kernel activities only relative to a specific process (PID); with the <code>-P</code> option:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd record -p function -P 174</span>
</span></span></code></pre></div><p>on system with very low disk space (like embedded boards), you cannot easily store big trace files to be analyzed later. <code>trace-cmd</code> can send the trace remotely over a network. Just start it on the host with the <em>listen port</em> option:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd listen -p 12345 -D </span>
</span></span></code></pre></div><p>and then on the device you can &ldquo;save&rdquo; events and data to the remote peer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># trace-cmd record -N mypc.local.net:12345 [tracing options]</span>
</span></span></code></pre></div><p>A trick for module developers : trace only some specific kernel mod by searching for functions that ends with <code>]</code> (partial output):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># lsmod | grep thinkpad</span>
</span></span><span style=display:flex><span>thinkpad_acpi         <span style=color:#ae81ff>196608</span>  <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>platform_profile       <span style=color:#ae81ff>12288</span>  <span style=color:#ae81ff>1</span> thinkpad_acpi
</span></span><span style=display:flex><span>sparse_keymap          <span style=color:#ae81ff>12288</span>  <span style=color:#ae81ff>1</span> thinkpad_acpi
</span></span><span style=display:flex><span>rfkill                 <span style=color:#ae81ff>40960</span>  <span style=color:#ae81ff>9</span> bluetooth,thinkpad_acpi,cfg80211
</span></span><span style=display:flex><span>snd                   <span style=color:#ae81ff>159744</span>  <span style=color:#ae81ff>57</span> snd_ctl_led,snd_hda_codec_generic,snd_seq,snd_seq_device,snd_hda_codec_hdmi,snd_hwdep,snd_hda_intel,snd_usb_audio,snd_usbmidi_lib,snd_hda_codec,snd_hda_codec_realtek,snd_sof,snd_timer,snd_compress,thinkpad_acpi,snd_soc_core,snd_ump,snd_pcm,snd_rawmidi
</span></span><span style=display:flex><span>video                  <span style=color:#ae81ff>81920</span>  <span style=color:#ae81ff>2</span> thinkpad_acpi,amdgpu
</span></span><span style=display:flex><span>battery                <span style=color:#ae81ff>28672</span>  <span style=color:#ae81ff>1</span> thinkpad_acpi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># trace-cmd list -f  | grep &#39;thinkpad_acpi]$ | grep bluetooh&#39;</span>
</span></span><span style=display:flex><span>bluetooth_attr_is_visible <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>bluetooth_set_status <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>bluetooth_get_status <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>bluetooth_exit <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>bluetooth_shutdown <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>bluetooth_enable_store <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>bluetooth_enable_show <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>bluetooth_write <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>bluetooth_read <span style=color:#f92672>[</span>thinkpad_acpi<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>and see what useful functions we can put under our trace, or check how our newly developed module is behaving.</p><h2 id=-outro-and-references>üèÑ‚Äç‚ôÇÔ∏è Outro and references:<a hidden class=anchor aria-hidden=true href=#-outro-and-references>#</a></h2><p>If you are into kernel development or just curious about how Linux internals work, you can rely on this useful feature to get interesting insights of your system.
I&rsquo;ll leave here some other websites and blog post that talks about ftrace:</p><ul><li><a href=https://www.kernel.org/doc/html/latest/trace/ftrace.html>the official Kernel documentation</a></li><li>A nice <a href=https://sergioprado.blog/tracing-the-linux-kernel-with-ftrace/>Blog Post</a> from Sergio Prado</li><li>Two posts on opensource.com from Gaurav Kamathe: <a href=https://opensource.com/article/21/7/linux-kernel-ftrace>1</a> and <a href=https://opensource.com/article/21/7/linux-kernel-trace-cmd>2</a></li><li>An (old but gold) <a href=https://lwn.net/Articles/410200/>LWN article</a></li></ul><p>If you are interested in the topic as I am, feel free to drop me any comment or feedback and I will be happy to have a follow up üòâ</p><p>Thanks for reading and Happy hacking!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/tutorial/>Tutorial</a></li><li><a href=https://ilmanzo.github.io/tags/linux/>Linux</a></li><li><a href=https://ilmanzo.github.io/tags/kernel/>Kernel</a></li><li><a href=https://ilmanzo.github.io/tags/tracing/>Tracing</a></li><li><a href=https://ilmanzo.github.io/tags/syscall/>Syscall</a></li><li><a href=https://ilmanzo.github.io/tags/sysadmin/>Sysadmin</a></li><li><a href=https://ilmanzo.github.io/tags/debug/>Debug</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/containerday2024/><span class=title>¬´ Prev</span><br><span>Wrapping up ContainerDay 2024</span>
</a><a class=next href=https://ilmanzo.github.io/post/testing_a_microsd_card/><span class=title>Next ¬ª</span><br><span>Testing a cheap MicroSD card quality</span></a></nav></footer></article></main><footer class=footer><span>¬© 2012-2024 Andrea Manzini</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>