<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>linux resource control with cgroups | ilManzo's blog</title>
<meta name=keywords content="linux,systemd,performance,monitoring"><meta name=description content="using systemd slices to manage resources"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/linux-resource-control-with-cgroups/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/linux-resource-control-with-cgroups/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL",{anonymize_ip:!1})}</script><meta property="og:title" content="linux resource control with cgroups"><meta property="og:description" content="using systemd slices to manage resources"><meta property="og:type" content="article"><meta property="og:url" content="https://ilmanzo.github.io/post/linux-resource-control-with-cgroups/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-05-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-03T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="linux resource control with cgroups"><meta name=twitter:description content="using systemd slices to manage resources"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"linux resource control with cgroups","item":"https://ilmanzo.github.io/post/linux-resource-control-with-cgroups/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"linux resource control with cgroups","name":"linux resource control with cgroups","description":"using systemd slices to manage resources","keywords":["linux","systemd","performance","monitoring"],"articleBody":"intro Resource isolation is an hot topic these days, and it’s a problem excellently solved by containerization. However, we can achieve isolation between internal tasks of an operating system by leveraging a technology exposed by the kernel: cgroups. This component is also used by Docker, and other Linux container technologies.\nCgroups are the Linux way of organizing groups of processes: roughly speaking a cgroup is to a process what a process is to a thread: one can have many threads belonging to the same process, and in the same way one can join many processes inside the same cgroup.\nthe problem Suppose we have an already busy server, maybe a database; and we want to run on the same machine a periodical job which is short but quite intensive. Of course we don’t want an huge impact on the service performance. Let’s say our cpu-bound process is represented by this script:\n#!/bin/bash #dosomework.sh { sleep 30 kill $$ } \u0026 while true; do true; done we can define a slice to control the resource sharing of our services and model the relative weight that the system should assign:\n#mydatabase-extrajob.slice [Unit] Description=Slice used to run companion programs. Memory, CPU and IO restricted Before=slices.target [Slice] MemoryAccounting=true IOAccounting=true CPUAccounting=true CPUWeight=10 IOWeight=10 MemoryHigh=4% MemoryLimit=5% CPUShares=10 BlockIOWeight=10 while the db service will have another resource definition:\n#mydatabase-server.slice [Unit] Description=Slice used to run DB. Maximum priority for IO and CPU Before=slices.target [Slice] MemoryAccounting=true IOAccounting=true CPUAccounting=true MemorySwapMax=1 CPUShares=1000 CPUWeight=1000 and we need to apply this slice to the .service\n[Service] ... Slice=mydatabase-server.slice By saying that the DB service has weight=1000 and the other program has weight=10, we tell the operating system that DB is 100 times more important when any CPU contention occurs.\nad hoc commands Systemd slices are a powerful way to protect services that are managed by systemd from each other. But what if I just want to run some command, and am too worried that it may use up precious resources from the main service?\nThankfully, systemd provides a way to run ad-hoc commands inside an existing slice. So the cautious admin can use that too:\nsudo systemd-run --uid=$(id -u dbuser) --gid=$(id -g dbgroup) -t --slice=mydatabase-extrajob.slice /path/to/my/tool Conclusion Systemd slices exposes the cgroups interface — which underpins the isolation infrastructure used by Docker and other Linux container technologies — in an elegant and powerful way. Services managed by Systemd, like databases, can use this infrastructure to isolate their main components from other auxiliary helper tools that may use too much resources. For other reference, SystemD documentation is quite extensive.\ncredits Glauber Costa’s Isolating workloads with Systemd slices\n","wordCount":"433","inLanguage":"en","datePublished":"2022-05-03T00:00:00Z","dateModified":"2022-05-03T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/linux-resource-control-with-cgroups/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/archives/ title><span></span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">linux resource control with cgroups</h1><div class=post-description>using systemd slices to manage resources</div><div class=post-meta><span title='2022-05-03 00:00:00 +0000 UTC'>May 3, 2022</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><h2 id=intro>intro<a hidden class=anchor aria-hidden=true href=#intro>#</a></h2><p>Resource isolation is an hot topic these days, and it&rsquo;s a problem excellently solved by containerization. However, we can achieve isolation between internal tasks of an operating system by leveraging a technology exposed by the kernel: cgroups. This component is also used by Docker, and other Linux container technologies.</p><p>Cgroups are the Linux way of organizing groups of processes: roughly speaking a cgroup is to a process what a process is to a thread: one can have many threads belonging to the same process, and in the same way one can join many processes inside the same cgroup.</p><h2 id=the-problem>the problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h2><p>Suppose we have an already busy server, maybe a database; and we want to run on the same machine a periodical job which is short but quite intensive. Of course we don&rsquo;t want an huge impact on the service performance. Let&rsquo;s say our cpu-bound process is represented by this script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#dosomework.sh</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>  sleep <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>  kill $$
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> &amp;
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span> true; <span style=color:#66d9ef>done</span> </span></span></code></pre></div><p>we can define a <strong>slice</strong> to control the resource sharing of our services and model the relative weight that the system should assign:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#mydatabase-extrajob.slice</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Unit<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Description<span style=color:#f92672>=</span>Slice used to run companion programs. Memory, CPU and IO restricted
</span></span><span style=display:flex><span>Before<span style=color:#f92672>=</span>slices.target
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Slice<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>MemoryAccounting<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>IOAccounting<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>CPUAccounting<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CPUWeight<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>IOWeight<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MemoryHigh<span style=color:#f92672>=</span>4%
</span></span><span style=display:flex><span>MemoryLimit<span style=color:#f92672>=</span>5%
</span></span><span style=display:flex><span>CPUShares<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>BlockIOWeight<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span></span></span></code></pre></div><p>while the db service will have another resource definition:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#mydatabase-server.slice</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Unit<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Description<span style=color:#f92672>=</span>Slice used to run DB. Maximum priority <span style=color:#66d9ef>for</span> IO and CPU
</span></span><span style=display:flex><span>Before<span style=color:#f92672>=</span>slices.target
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Slice<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>MemoryAccounting<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>IOAccounting<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>CPUAccounting<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>MemorySwapMax<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>CPUShares<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>CPUWeight<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span></span></span></code></pre></div><p>and we need to apply this slice to the .service</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Slice<span style=color:#f92672>=</span>mydatabase-server.slice</span></span></code></pre></div><p>By saying that the DB service has weight=1000 and the other program has weight=10, we tell the operating system that DB is 100 times more important when any CPU contention occurs.</p><h2 id=ad-hoc-commands>ad hoc commands<a hidden class=anchor aria-hidden=true href=#ad-hoc-commands>#</a></h2><p>Systemd slices are a powerful way to protect services that are managed by systemd from each other. But what if I just want to run some command, and am too worried that it may use up precious resources from the main service?</p><p>Thankfully, systemd provides a way to run ad-hoc commands inside an existing slice. So the cautious admin can use that too:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemd-run --uid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>id -u dbuser<span style=color:#66d9ef>)</span> --gid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>id -g dbgroup<span style=color:#66d9ef>)</span> -t --slice<span style=color:#f92672>=</span>mydatabase-extrajob.slice /path/to/my/tool</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Systemd slices exposes the cgroups interface — which underpins the isolation infrastructure used by Docker and other Linux container technologies — in an elegant and powerful way. Services managed by Systemd, like databases, can use this infrastructure to isolate their main components from other auxiliary helper tools that may use too much resources. For other reference, <a href=https://www.freedesktop.org/software/systemd/man/systemd.resource-control.html#>SystemD documentation</a> is quite extensive.</p><h2 id=credits>credits<a hidden class=anchor aria-hidden=true href=#credits>#</a></h2><p>Glauber Costa&rsquo;s <a href=https://www.scylladb.com/2019/09/25/isolating-workloads-with-systemd-slices/>Isolating workloads with Systemd slices</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/linux/>Linux</a></li><li><a href=https://ilmanzo.github.io/tags/systemd/>Systemd</a></li><li><a href=https://ilmanzo.github.io/tags/performance/>Performance</a></li><li><a href=https://ilmanzo.github.io/tags/monitoring/>Monitoring</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/otp-generation-from-command-line/><span class=title>« Prev</span><br><span>automate OTP credentials for multi-factor authentication</span>
</a><a class=next href=https://ilmanzo.github.io/post/writing-python-modules-in-rust-2/><span class=title>Next »</span><br><span>integration between Python and Rust - Part 2</span></a></nav></footer></article></main><footer class=footer><span>© 2012-2024 Andrea Manzini</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>