<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Measure your program's power consumption | ilManzo's blog</title><meta name=keywords content="linux,tutorial,system,hardware,power,energy,optimization"><meta name=description content="Understand how much power you are using"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/measure_your_power_consumption/><link crossorigin=anonymous href=/assets/css/stylesheet.a090830a421002426baafbd314e38f149d77b4c48a12ee9312700d770b27fb26.css integrity="sha256-oJCDCkIQAkJrqvvTFOOPFJ13tMSKEu6TEnANdwsn+yY=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/measure_your_power_consumption/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL")}</script><meta property="og:url" content="https://ilmanzo.github.io/post/measure_your_power_consumption/"><meta property="og:site_name" content="ilManzo's blog"><meta property="og:title" content="Measure your program's power consumption"><meta property="og:description" content="Understand how much power you are using"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-06-30T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-30T00:00:00+00:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Tutorial"><meta property="article:tag" content="System"><meta property="article:tag" content="Hardware"><meta property="article:tag" content="Power"><meta property="article:tag" content="Energy"><meta name=twitter:card content="summary"><meta name=twitter:title content="Measure your program's power consumption"><meta name=twitter:description content="Understand how much power you are using"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"Measure your program's power consumption","item":"https://ilmanzo.github.io/post/measure_your_power_consumption/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Measure your program's power consumption","name":"Measure your program\u0027s power consumption","description":"Understand how much power you are using","keywords":["linux","tutorial","system","hardware","power","energy","optimization"],"articleBody":"üå°Ô∏è Intro For those running a datacenter, or just a simple homelab server, the arrival of summer heat means an increase in air conditioning use. On this post I asked myself how a Linux engineer can measure how much energy is the system consuming so we can start to reason about workload optimization for better power consumption patterns.\nüîã Idle power drain As a starting point, let‚Äôs measure how much power my PC is consuming when idle, doing absolutely nothing; or better: nothing useful for computation or service but just running usual, default operating system tasks.\nThere are many way to do it; the most reliable probably is using a proper external power meter device like this one.\npublic domain image from Flickr; credits to Emilian Robert Vicol\nSince I‚Äôm a software engineer, I don‚Äôt want to mess much with cables; and on many occasion it‚Äôs not practical to disconnect the servers in a remote datacenter just to do some quick power measure. As a pure software solution, some rough measurements can be obtained with the help of powerstat utility, which uses many methods (like battery stats or the Intel RAPL interface, which stands for Running Average Power Limit) to estimate the power consumption of a running computer.\n# powerstat -zR [...] -------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ Average 0.1 0.0 0.2 99.4 0.2 1.1 916.3 479.6 0.2 0.0 0.4 29.98 GeoMean 0.1 0.0 0.2 99.4 0.2 1.1 882.5 463.9 0.0 0.0 0.0 29.89 StdDev 0.1 0.0 0.1 0.3 0.2 0.3 408.7 169.7 0.7 0.0 2.1 2.64 -------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ Minimum 0.1 0.0 0.1 96.9 0.1 1.0 730.0 377.0 0.0 0.0 0.0 28.74 Maximum 0.8 0.0 0.6 99.6 1.6 2.0 3987.0 1589.0 5.0 0.0 16.0 44.31 -------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ Summary: CPU: 29.98 Watts on average with standard deviation 2.64 Note: power read from RAPL domains: uncore, pkg-0, core, psys. These readings do not cover all the hardware in this device. ‚ö° Put it to work So my computer, a ThinkPad P15 Gen 2i, uses ~30 Watts (or ~30 Joule / sec) to do nothing, which if you ask me, I‚Äôd rate pretty bad. Let‚Äôs make some experiments with different workloads, like what every computer should be good at: calculating prime numbers!\nThe experiment idea is to see how much energy it costs to get the first million prime numbers; accordingly to prime numbers wiki the 1,000,000th prime number should be 15,485,863.\nI started with a rather dumb Python program that‚Äôs on purpose absolutely not optimized:\nfrom math import sqrt def isPrime(n): for j in range(3,int(sqrt(n)+1),2): if n % j == 0: return False return True n,i = 2,3 while n \u003c 1_000_000: i += 2 if isPrime(i): n += 1 print(\"Prime number =\", i) And run it with powerstat measurement in background:\n# (powerstat -zR 1 60 \u0026) ; /usr/bin/time python3 /tmp/prime.py -------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ Average 6.3 0.0 0.2 93.4 0.1 2.0 1003.4 1168.7 0.1 0.0 0.5 56.65 GeoMean 6.3 0.0 0.1 93.4 0.0 2.0 872.7 964.3 0.0 0.0 0.0 56.26 StdDev 0.1 0.0 0.1 0.1 0.0 0.1 750.7 1184.1 0.4 0.1 1.7 7.55 -------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ Minimum 6.3 0.0 0.1 92.7 0.0 2.0 561.0 697.0 0.0 0.0 0.0 53.39 Maximum 7.1 0.0 0.4 93.6 0.1 3.0 4135.0 6576.0 2.0 1.0 10.0 90.93 -------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ Summary: CPU: 56.65 Watts on average with standard deviation 7.55 Note: power read from RAPL domains: uncore, pkg-0, core, psys. These readings do not cover all the hardware in this device. Prime = 15485863 61.68user 0.00system 1:01.71elapsed 99%CPU (0avgtext+0avgdata 8064maxresident)k 0inputs+0outputs (0major+879minor)pagefaults 0swaps Notice how variable the numbers are over time! So, when doing calculations, my pc almost doubles the power consumption. I keep it safe and say that ~27W is the extra power required to run my poor Python prime number calculator.\nSince the program runs for ~61.5 seconds, running it requires ~3490 Joule of energy or 0.0009694444 kWh; of course this is only about the CPU and does not include graphic card, disk subsystem, display, network and so on.\nüìè An alternative measure Another way to read the RAPL metrics is by using the powerful perf utility. This tool can read many probes exposed from the kernel so maybe in the future we should dedicate it a whole post.\n# perf list --details power* List of pre-defined events (to be used in -e or -M): power/energy-cores/ [Kernel PMU event] power/energy-pkg/ [Kernel PMU event] power/energy-psys/ [Kernel PMU event] [output omitted] The power/energy-cores/ perf counter is part of the Intel RAPL interfaced, based on an CPU MSR register called MSR_PP0_ENERGY_STATUS. The other two are power measurements relative to the package (cores and uncore components) and the entire System on Chip; the latter one is available from Skylake architecture.\nLets‚Äô run our Python program asking perf to collect the metrics during the execution:\n# perf stat -ae power/energy-cores/,power/energy-pkg/,power/energy-psys/ python3 /tmp/prime.py Prime = 15485863 Performance counter stats for 'system wide': 695.00 Joules power/energy-cores/ 930.12 Joules power/energy-pkg/ 1855.48 Joules power/energy-psys/ 61.362063830 seconds time elapsed üöÄ We can do better for a performance comparison, let‚Äôs check the same algorithm written in Rust:\nfn is_prime(n: u64) -\u003e bool { let sqrt_n = (n as f64).sqrt() as u64; for j in (3..=sqrt_n).step_by(2) { if n % j == 0 { return false; } } true } fn main() { let mut n = 2; let mut i = 3; while n \u003c 1_000_000 { i += 2; if is_prime(i) { n += 1; } } println!(\"Prime = {}\", i); } Note: we simply translated the Python code, without any attention to optimization.\n$ cargo build --release Compiling prime1m v0.1.0 (/home/andrea/projects/prove/prime1m) Finished `release` profile [optimized] target(s) in 0.12s # perf stat -ae power/energy-cores/,power/energy-pkg/,power/energy-psys/ ./target/release/prime1m Prime = 15485863 Performance counter stats for 'system wide': 24.46 Joules power/energy-cores/ 36.17 Joules power/energy-pkg/ 82.12 Joules power/energy-psys/ 2.987509303 seconds time elapsed As expected, to give the same output, the compiled program is ~20x faster, and uses less resources and energy. Sounds interesting!\nüìö Further insights RAPL (Running Average Power Limit) is a hardware feature introduced by Intel to facilitate power management; the RAPL interface is discussed in Section 14.9 of the Intel Manual Volume 3. If you want to know more about this framework, I can recommend also this research article.\nThe perf tool can do much more than reading power metrics from the kernel. If you want to see some examples, check out the ubiquitous Brendan Gregg website.\nEnjoy and happy green computing!\n","wordCount":"1125","inLanguage":"en","datePublished":"2024-06-30T00:00:00Z","dateModified":"2024-06-30T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/measure_your_power_consumption/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Measure your program's power consumption</h1><div class=post-description>Understand how much power you are using</div><div class=post-meta><span title='2024-06-30 00:00:00 +0000 UTC'>June 30, 2024</span>&nbsp;¬∑&nbsp;<span>Andrea Manzini</span></div></header><div class=post-content><h2 id=-intro>üå°Ô∏è Intro<a hidden class=anchor aria-hidden=true href=#-intro>#</a></h2><p>For those running a datacenter, or just a simple homelab server, the arrival of summer heat means an increase in air conditioning use. On this post I asked myself how a Linux engineer can measure how much energy is the system consuming so we can start to reason about workload optimization for better power consumption patterns.</p><h2 id=-idle-power-drain>üîã Idle power drain<a hidden class=anchor aria-hidden=true href=#-idle-power-drain>#</a></h2><p>As a starting point, let&rsquo;s measure how much power my PC is consuming when idle, doing absolutely nothing; or better: nothing useful for computation or service but just running usual, default operating system tasks.</p><p>There are many way to do it; the most reliable probably is using a proper external power meter device like this one.</p><p><img alt=powermeter loading=lazy src=/img/powermeter.jpg></p><p><a href=https://www.flickr.com/photos/free-stock/5000495108/>public domain image from Flickr; credits to Emilian Robert Vicol</a></p><p>Since I&rsquo;m a software engineer, I don&rsquo;t want to mess much with cables; and on many occasion it&rsquo;s not practical to disconnect the servers in a remote datacenter just to do some quick power measure. As a pure software solution, some rough measurements can be obtained with the help of <a href=https://github.com/ColinIanKing/powerstat>powerstat</a> utility, which uses many methods (like battery stats or the <em>Intel RAPL interface</em>, which stands for Running Average Power Limit) to estimate the power consumption of a running computer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># powerstat -zR
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ 
</span></span><span style=display:flex><span> Average   0.1   0.0   0.2  99.4   0.2  1.1  916.3  479.6  0.2  0.0  0.4  29.98 
</span></span><span style=display:flex><span> GeoMean   0.1   0.0   0.2  99.4   0.2  1.1  882.5  463.9  0.0  0.0  0.0  29.89 
</span></span><span style=display:flex><span>  StdDev   0.1   0.0   0.1   0.3   0.2  0.3  408.7  169.7  0.7  0.0  2.1   2.64 
</span></span><span style=display:flex><span>-------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ 
</span></span><span style=display:flex><span> Minimum   0.1   0.0   0.1  96.9   0.1  1.0  730.0  377.0  0.0  0.0  0.0  28.74 
</span></span><span style=display:flex><span> Maximum   0.8   0.0   0.6  99.6   1.6  2.0 3987.0 1589.0  5.0  0.0 16.0  44.31 
</span></span><span style=display:flex><span>-------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ 
</span></span><span style=display:flex><span>Summary:
</span></span><span style=display:flex><span>CPU:  29.98 Watts on average with standard deviation 2.64  
</span></span><span style=display:flex><span>Note: power read from RAPL domains: uncore, pkg-0, core, psys.
</span></span><span style=display:flex><span>These readings do not cover all the hardware in this device.
</span></span></code></pre></div><h2 id=-put-it-to-work>‚ö° Put it to work<a hidden class=anchor aria-hidden=true href=#-put-it-to-work>#</a></h2><p>So my computer, a ThinkPad P15 Gen 2i, uses ~30 Watts (or ~30 Joule / sec) to do nothing, which if you ask me, I&rsquo;d rate pretty bad. Let&rsquo;s make some experiments with different workloads, like what every computer should be good at: calculating prime numbers!</p><p>The experiment idea is to see how much energy it costs to get the first million prime numbers; accordingly to <a href=https://prime-numbers.fandom.com/>prime numbers wiki</a> the 1,000,000th prime number should be 15,485,863.</p><p>I started with a rather dumb Python program that&rsquo;s on purpose absolutely not optimized:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> math <span style=color:#f92672>import</span> sqrt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>isPrime</span>(n):
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>3</span>,int(sqrt(n)<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>),<span style=color:#ae81ff>2</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> n <span style=color:#f92672>%</span> j <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>n,i <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> n <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1_000_000</span>:
</span></span><span style=display:flex><span>    i <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> isPrime(i):
</span></span><span style=display:flex><span>        n <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Prime number =&#34;</span>, i)
</span></span></code></pre></div><p>And run it with <code>powerstat</code> measurement in background:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># (powerstat -zR 1 60 &amp;) ; /usr/bin/time python3 /tmp/prime.py
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>-------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ 
</span></span><span style=display:flex><span> Average   6.3   0.0   0.2  93.4   0.1  2.0 1003.4 1168.7  0.1  0.0  0.5  56.65 
</span></span><span style=display:flex><span> GeoMean   6.3   0.0   0.1  93.4   0.0  2.0  872.7  964.3  0.0  0.0  0.0  56.26 
</span></span><span style=display:flex><span>  StdDev   0.1   0.0   0.1   0.1   0.0  0.1  750.7 1184.1  0.4  0.1  1.7   7.55 
</span></span><span style=display:flex><span>-------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ 
</span></span><span style=display:flex><span> Minimum   6.3   0.0   0.1  92.7   0.0  2.0  561.0  697.0  0.0  0.0  0.0  53.39 
</span></span><span style=display:flex><span> Maximum   7.1   0.0   0.4  93.6   0.1  3.0 4135.0 6576.0  2.0  1.0 10.0  90.93 
</span></span><span style=display:flex><span>-------- ----- ----- ----- ----- ----- ---- ------ ------ ---- ---- ---- ------ 
</span></span><span style=display:flex><span>Summary:
</span></span><span style=display:flex><span>CPU:  56.65 Watts on average with standard deviation 7.55  
</span></span><span style=display:flex><span>Note: power read from RAPL domains: uncore, pkg-0, core, psys.
</span></span><span style=display:flex><span>These readings do not cover all the hardware in this device.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Prime = 15485863
</span></span><span style=display:flex><span>61.68user 0.00system 1:01.71elapsed 99%CPU (0avgtext+0avgdata 8064maxresident)k
</span></span><span style=display:flex><span>0inputs+0outputs (0major+879minor)pagefaults 0swaps
</span></span></code></pre></div><p>Notice how variable the numbers are over time! So, when doing calculations, my pc almost doubles the power consumption. I keep it safe and say that ~27W is the extra power required to run my poor Python prime number calculator.</p><p>Since the program runs for ~61.5 seconds, running it requires ~3490 Joule of energy or 0.0009694444 kWh; of course this is only about the CPU and does not include graphic card, disk subsystem, display, network and so on.</p><h2 id=-an-alternative-measure>üìè An alternative measure<a hidden class=anchor aria-hidden=true href=#-an-alternative-measure>#</a></h2><p>Another way to read the RAPL metrics is by using the powerful <a href=https://perf.wiki.kernel.org/index.php/Main_Page>perf</a> utility. This tool can read many probes exposed from the kernel so maybe in the future we should dedicate it a whole post.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># perf list --details power*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>List of pre-defined events <span style=color:#f92672>(</span>to be used in -e or -M<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  power/energy-cores/                                <span style=color:#f92672>[</span>Kernel PMU event<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  power/energy-pkg/                                  <span style=color:#f92672>[</span>Kernel PMU event<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  power/energy-psys/                                 <span style=color:#f92672>[</span>Kernel PMU event<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>output omitted<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>The <code>power/energy-cores/</code> perf counter is part of the Intel RAPL interfaced, based on an CPU MSR register called <code>MSR_PP0_ENERGY_STATUS</code>.
The other two are power measurements relative to the package (cores and uncore components) and the entire System on Chip; the latter one is available from Skylake architecture.</p><p>Lets&rsquo; run our Python program asking perf to collect the metrics during the execution:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># perf stat -ae power/energy-cores/,power/energy-pkg/,power/energy-psys/ python3 /tmp/prime.py</span>
</span></span><span style=display:flex><span>Prime <span style=color:#f92672>=</span> <span style=color:#ae81ff>15485863</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Performance counter stats <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;system wide&#39;</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            695.00 Joules power/energy-cores/                                                   
</span></span><span style=display:flex><span>            930.12 Joules power/energy-pkg/                                                     
</span></span><span style=display:flex><span>           1855.48 Joules power/energy-psys/                                                    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      61.362063830 seconds time elapsed
</span></span></code></pre></div><h2 id=-we-can-do-better>üöÄ We can do better<a hidden class=anchor aria-hidden=true href=#-we-can-do-better>#</a></h2><p>for a performance comparison, let&rsquo;s check the same algorithm written in Rust:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Rust data-lang=Rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>is_prime</span>(n: <span style=color:#66d9ef>u64</span>) -&gt; <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> sqrt_n <span style=color:#f92672>=</span> (n <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span>).sqrt() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> j <span style=color:#66d9ef>in</span> (<span style=color:#ae81ff>3</span><span style=color:#f92672>..=</span>sqrt_n).step_by(<span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> n <span style=color:#f92672>%</span> j <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> n <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> n <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1_000_000</span> {
</span></span><span style=display:flex><span>        i <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> is_prime(i) {
</span></span><span style=display:flex><span>            n <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;Prime = </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, i);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note: we simply translated the Python code, without any attention to optimization.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo build --release
</span></span><span style=display:flex><span>   Compiling prime1m v0.1.0 <span style=color:#f92672>(</span>/home/andrea/projects/prove/prime1m<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Finished <span style=color:#e6db74>`</span>release<span style=color:#e6db74>`</span> profile <span style=color:#f92672>[</span>optimized<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.12s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># perf stat -ae power/energy-cores/,power/energy-pkg/,power/energy-psys/ ./target/release/prime1m</span>
</span></span><span style=display:flex><span>Prime <span style=color:#f92672>=</span> <span style=color:#ae81ff>15485863</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Performance counter stats <span style=color:#66d9ef>for</span> <span style=color:#e6db74>&#39;system wide&#39;</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             24.46 Joules power/energy-cores/                                                   
</span></span><span style=display:flex><span>             36.17 Joules power/energy-pkg/                                                     
</span></span><span style=display:flex><span>             82.12 Joules power/energy-psys/                                                    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       2.987509303 seconds time elapsed
</span></span></code></pre></div><p>As expected, to give the same output, the compiled program is ~20x faster, and uses less resources and energy. Sounds interesting!</p><h2 id=-further-insights>üìö Further insights<a hidden class=anchor aria-hidden=true href=#-further-insights>#</a></h2><p>RAPL (Running Average Power Limit) is a hardware feature introduced by Intel to facilitate power management; the RAPL interface is discussed in Section 14.9 of the Intel Manual Volume 3.
If you want to know more about this framework, I can recommend also <a href=https://dl.acm.org/doi/10.1145/3177754>this research article</a>.</p><p>The <code>perf</code> tool can do much more than reading power metrics from the kernel. If you want to see some examples, check out the ubiquitous <a href=https://www.brendangregg.com/perf.html>Brendan Gregg</a> website.</p><p>Enjoy and happy green computing!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/linux/>Linux</a></li><li><a href=https://ilmanzo.github.io/tags/tutorial/>Tutorial</a></li><li><a href=https://ilmanzo.github.io/tags/system/>System</a></li><li><a href=https://ilmanzo.github.io/tags/hardware/>Hardware</a></li><li><a href=https://ilmanzo.github.io/tags/power/>Power</a></li><li><a href=https://ilmanzo.github.io/tags/energy/>Energy</a></li><li><a href=https://ilmanzo.github.io/tags/optimization/>Optimization</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/playing_with_linux_capabilities/><span class=title>¬´ Prev</span><br><span>Playing with Linux kernel capabilities</span>
</a><a class=next href=https://ilmanzo.github.io/post/testing_pyside_gui_applications/><span class=title>Next ¬ª</span><br><span>Headless Testing of PySide/PyQt GUI Applications with pytest-qt</span></a></nav></footer></article></main><footer class=footer><span>¬© 2012-2025 Andrea Manzini</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>