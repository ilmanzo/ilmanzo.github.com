<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How much code are you testing ? (1) | ilManzo's blog</title>
<meta name=keywords content="testing,tutorial,coverage,go,golang,qa"><meta name=description content="Measuring coverage of integration tests"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/measuring-coverage-of-integration-tests/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/measuring-coverage-of-integration-tests/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL")}</script><meta property="og:url" content="https://ilmanzo.github.io/post/measuring-coverage-of-integration-tests/"><meta property="og:site_name" content="ilManzo's blog"><meta property="og:title" content="How much code are you testing ? (1)"><meta property="og:description" content="Measuring coverage of integration tests"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-02-23T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-23T00:00:00+00:00"><meta property="article:tag" content="Testing"><meta property="article:tag" content="Tutorial"><meta property="article:tag" content="Coverage"><meta property="article:tag" content="Go"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Qa"><meta name=twitter:card content="summary"><meta name=twitter:title content="How much code are you testing ? (1)"><meta name=twitter:description content="Measuring coverage of integration tests"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"How much code are you testing ? (1)","item":"https://ilmanzo.github.io/post/measuring-coverage-of-integration-tests/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How much code are you testing ? (1)","name":"How much code are you testing ? (1)","description":"Measuring coverage of integration tests","keywords":["testing","tutorial","coverage","go","golang","qa"],"articleBody":"‚òÇÔ∏è Intro When your code includes a suite of unit tests, code coverage is an important metric to measure the test effectiveness and it‚Äôs rather easy to obtain; there are plenty of tools around.\nImage credits to: Nataliya Vaitkevich\nOn the other hand, often we also need to do integration or E2E testing, as in our QA journey we are mostly running real world programs instead of single well-chosen functions.\nLet‚Äôs start with a basic use case, and prepare a simple program tailored for this purpose.\nSuppose we want to test a simple program that prints \"Hello, World!\" with some optional command line arguments (you can find source code at the bottom üëá):\n$ ./hello --help Usage of ./hello: -count int number of times to repeat (default 1) -header print also a fancy header -name string your name for greeting (default \"World\") -upper convert to uppercase üö¶ Red, Green, Refactor We are going to use the pytest framework, but any other would work. As a first step, let‚Äôs write a failing test:\n# test_hello.py from subprocess import run def smoke(capfd): run([\"./hello\"]) out, err = capfd.readouterr() assert out == \"\" simple run:\n$ pytest ============================ test session starts ============================= platform linux -- Python 3.11.11, pytest-8.3.4, pluggy-1.5.0 rootdir: /home/andrea/projects/test collected 1 item test_hello.py F [100%] ================================== FAILURES ================================== _________________________________ test_hello _________________________________ capfd = \u003c_pytest.capture.CaptureFixture object at 0x7f3824e41650\u003e def test_smoke(capfd): run([\"./hello\"]) out, err = capfd.readouterr() \u003e assert out == \"\" E AssertionError: assert 'Hello, World!\\n' == '' E E + Hello, World! test_hello.py:6: AssertionError ========================== short test summary info =========================== FAILED test_hello.py::test_smoke - AssertionError: assert 'Hello, World!\\n' == '' ============================= 1 failed in 0.02s ============================== oh well‚Ä¶ We need to assert the right output. Easy peasy:\n# test_hello.py from subprocess import run def test_smoke(capfd): run([\"./hello\"]) out, err = capfd.readouterr() assert out == \"Hello, World!\\n\" $ pytest ============================ test session starts ============================= platform linux -- Python 3.11.11, pytest-8.3.4, pluggy-1.5.0 rootdir: /home/andrea/projects/test collected 1 item test_hello.py . [100%] ============================= 1 passed in 0.01s ============================== üì£ Say it louder We are awesome and cool QA Engineers, aren‚Äôt we ? üòé So observing the program command line help, we decide to write a second test, to try out the uppercase feature of our program:\n# test_hello.py from subprocess import run def test_smoke(capfd): run([\"./hello\"]) out, err = capfd.readouterr() assert out == \"Hello, World!\\n\" def test_uppercase(capfd): run([\"./hello\", \"-upper\"]) out, err = capfd.readouterr() assert out == \"HELLO, WORLD!\\n\" $ pytest ============================== test session starts =============================== platform linux -- Python 3.11.11, pytest-8.3.4, pluggy-1.5.0 rootdir: /home/andrea/projects/test collected 2 items test_hello.py .. [100%] =============================== 2 passed in 0.02s ================================ üéâ üéâ We doubled the test coverage, celebrate! üéâ üéâ Our job seems done ‚Ä¶\nWait ‚Ä¶ Actually, how can you say when our tests are good enough ? How much of the program code are you actually running ? Do our tests avoid or miss some key feature ?\nüå°Ô∏è Bring in the meter For each test run, we need to measure the ratio between the code executed and the total code in the program. This is a tricky subject and mostly it depends on how the program is built, but as a first step we can use a feature that Go has introduced a couple of years ago, starting from version 1.20.\nSo, let‚Äôs rebuild the program with coverage informations in the binary:\n$ go build -cover hello.go Once compiled, the program gives us an hint on something changed:\n$ ./hello warning: GOCOVERDIR not set, no coverage data emitted Hello, World! The Go compiler instrumented the program, and now we need to give it a path where to store the collected coverage data. So, lets‚Äô prepare a simple script that will setup the environment and also run our test suite:\n$ cat cov_test.sh #!/bin/sh rm -rf covdatafiles mkdir covdatafiles rm hello \u0026\u0026 go build -cover hello.go GOCOVERDIR=covdatafiles pytest The run is apparently not changed:\n$ ./cov_test.sh ============================== test session starts =============================== platform linux -- Python 3.11.11, pytest-8.3.4, pluggy-1.5.0 rootdir: /home/andrea/projects/test collected 2 items test_hello.py .. [100%] =============================== 2 passed in 0.02s ================================ but now we have some data in a new subfolder:\n$ ls covdatafiles covcounters.6d07efc23254e1696fe8a1428981e28e.13877.1740324625565161919 covcounters.6d07efc23254e1696fe8a1428981e28e.13882.1740324625569223562 covmeta.6d07efc23254e1696fe8a1428981e28e these files are intended to be processed by another tool:\n$ go tool covdata percent -i covdatafiles command-line-arguments\tcoverage: 85.7% of statements üê§ Another baby step let‚Äôs add another test and see if our coverage increases:\nfrom subprocess import run def test_smoke(capfd): run([\"./hello\"]) out, err = capfd.readouterr() assert out == \"Hello, World!\\n\" def test_uppercase(capfd): run([\"./hello\", \"-upper\"]) out, err = capfd.readouterr() assert out == \"HELLO, WORLD!\\n\" def test_header(capfd): run([\"./hello\", \"-header\"]) out, err = capfd.readouterr() assert out == \"-------------\\nHello, World!\\n\" üöÄ Hooray ! $ go tool covdata percent -i covdatafiles command-line-arguments\tcoverage: 92.9% of statements We did a step forward, and we can safely claim our tests are better than before.\nSince we are at it, let‚Äôs integrate the coverage output into our test script:\n$ cat cov_test.sh #!/bin/sh rm -rf covdatafiles mkdir covdatafiles rm hello \u0026\u0026 go build -cover hello.go GOCOVERDIR=covdatafiles pytest go tool covdata percent -i covdatafiles üîé Use the source, Luke Now a question for the reader; looking at the source code of the program:\npackage main import ( \"flag\" \"fmt\" \"strings\" ) func main() { name := flag.String(\"name\", \"World\", \"your name for greeting\") count := flag.Int(\"count\", 1, \"number of times to repeat\") isUpper := flag.Bool(\"upper\", false, \"convert to uppercase\") addHeader := flag.Bool(\"header\", false, \"print also a fancy header\") flag.Parse() message := fmt.Sprintf(\"Hello, %s!\", *name) if *name == \"Andrea\" { message += \" Welcome back!\" } if *isUpper { message = strings.ToUpper(message) } if *addHeader { fmt.Println(strings.Repeat(\"-\", len(message))) } for i := 0; i \u003c *count; i++ { fmt.Println(message) } } can you think of one last test we can write to reach 100% coverage ? üòâ\nGood news: we can have a visual hint by producing an html output! We just need to add a couple more lines of post-processing:\n$ go tool covdata textfmt -i=covdatafiles -o=coverage.txt $ go tool cover -html coverage.txt Oh yes, now it‚Äôs very clear what we are missing üòÑ\ndef test_andrea(capfd): run([\"./hello\",\"-name\",\"Andrea\"]) out, err = capfd.readouterr() assert out == \"Hello, Andrea! Welcome back!\\n\" üß™ Final words Thanks to the excellent Go tooling, adding coverage information to compiled binaries is straightforward and we can finally have an idea on how much code our tests are probing.\nI‚Äôm sure it‚Äôs a very important metric to have, so we can think about some ways to expand this concept to other languages and technologies.\nupdate: there is a follow up post, you can read it here\nFeel free to leave me comments and feedback, happy hacking! üëã\n","wordCount":"1096","inLanguage":"en","datePublished":"2025-02-23T00:00:00Z","dateModified":"2025-02-23T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/measuring-coverage-of-integration-tests/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">How much code are you testing ? (1)</h1><div class=post-description>Measuring coverage of integration tests</div><div class=post-meta><span title='2025-02-23 00:00:00 +0000 UTC'>February 23, 2025</span>&nbsp;¬∑&nbsp;Andrea Manzini</div></header><div class=post-content><h2 id=-intro>‚òÇÔ∏è Intro<a hidden class=anchor aria-hidden=true href=#-intro>#</a></h2><p>When your code includes a suite of unit tests, <a href=https://en.wikipedia.org/wiki/Code_coverage>code coverage</a> is an important metric to measure the test effectiveness and it&rsquo;s rather easy to obtain; there are <a href=https://www.browserstack.com/guide/code-coverage-tools>plenty of tools around</a>.</p><p><img alt=metrics loading=lazy src=/img/pexels-n-voitkevich-6120217.jpg>
Image credits to: <a href=https://www.pexels.com/it-it/@n-voitkevich/>Nataliya Vaitkevich</a></p><p>On the other hand, often we also need to do integration or E2E testing, as in our QA journey we are mostly running real world programs instead of single well-chosen functions.</p><p>Let&rsquo;s start with a basic use case, and prepare a simple program tailored for this purpose.</p><p>Suppose we want to test a simple program that prints <code>"Hello, World!"</code> with some optional command line arguments (you can find source code at the bottom üëá):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ ./hello --help   
</span></span><span style=display:flex><span>Usage of ./hello:
</span></span><span style=display:flex><span>  -count int
</span></span><span style=display:flex><span>    	number of times to repeat (default 1)
</span></span><span style=display:flex><span>  -header
</span></span><span style=display:flex><span>    	print also a fancy header
</span></span><span style=display:flex><span>  -name string
</span></span><span style=display:flex><span>    	your name for greeting (default &#34;World&#34;)
</span></span><span style=display:flex><span>  -upper
</span></span><span style=display:flex><span>    	convert to uppercase
</span></span></code></pre></div><h2 id=-red-green-refactor>üö¶ Red, Green, Refactor<a hidden class=anchor aria-hidden=true href=#-red-green-refactor>#</a></h2><p>We are going to use the <code>pytest</code> framework, but <a href=https://open.qa/>any other</a> would work. As a first step, let&rsquo;s write a <em>failing</em> test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># test_hello.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> subprocess <span style=color:#f92672>import</span> run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>smoke</span>(capfd):
</span></span><span style=display:flex><span>    run([<span style=color:#e6db74>&#34;./hello&#34;</span>])
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capfd<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span></code></pre></div><p>simple run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pytest           
</span></span><span style=display:flex><span><span style=color:#f92672>============================</span> test session starts <span style=color:#f92672>=============================</span>
</span></span><span style=display:flex><span>platform linux -- Python 3.11.11, pytest-8.3.4, pluggy-1.5.0
</span></span><span style=display:flex><span>rootdir: /home/andrea/projects/test
</span></span><span style=display:flex><span>collected <span style=color:#ae81ff>1</span> item                                                                     
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_hello.py F                                                        <span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>==================================</span> FAILURES <span style=color:#f92672>==================================</span>
</span></span><span style=display:flex><span>_________________________________ test_hello _________________________________
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>capfd <span style=color:#f92672>=</span> &lt;_pytest.capture.CaptureFixture object at 0x7f3824e41650&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    def test_smoke<span style=color:#f92672>(</span>capfd<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>        run<span style=color:#f92672>([</span><span style=color:#e6db74>&#34;./hello&#34;</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>        out, err <span style=color:#f92672>=</span> capfd.readouterr<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>&gt;       assert out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>E       AssertionError: assert <span style=color:#e6db74>&#39;Hello, World!\n&#39;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>E         
</span></span><span style=display:flex><span>E         + Hello, World!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_hello.py:6: AssertionError
</span></span><span style=display:flex><span><span style=color:#f92672>==========================</span> short test summary info <span style=color:#f92672>===========================</span>
</span></span><span style=display:flex><span>FAILED test_hello.py::test_smoke - AssertionError: assert <span style=color:#e6db74>&#39;Hello, World!\n&#39;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>=============================</span> <span style=color:#ae81ff>1</span> failed in 0.02s <span style=color:#f92672>==============================</span>
</span></span></code></pre></div><p>oh well&mldr; We need to assert the right output. Easy peasy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># test_hello.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> subprocess <span style=color:#f92672>import</span> run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_smoke</span>(capfd):
</span></span><span style=display:flex><span>    run([<span style=color:#e6db74>&#34;./hello&#34;</span>])
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capfd<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Hello, World!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pytest
</span></span><span style=display:flex><span><span style=color:#f92672>============================</span> test session starts <span style=color:#f92672>=============================</span>
</span></span><span style=display:flex><span>platform linux -- Python 3.11.11, pytest-8.3.4, pluggy-1.5.0
</span></span><span style=display:flex><span>rootdir: /home/andrea/projects/test
</span></span><span style=display:flex><span>collected <span style=color:#ae81ff>1</span> item                                                                     
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_hello.py .                                                        <span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>=============================</span> <span style=color:#ae81ff>1</span> passed in 0.01s <span style=color:#f92672>==============================</span>
</span></span></code></pre></div><h2 id=-say-it-louder>üì£ Say it louder<a hidden class=anchor aria-hidden=true href=#-say-it-louder>#</a></h2><p>We are awesome and cool QA Engineers, aren&rsquo;t we ? üòé So observing the program command line help, we decide to write a second test, to try out the <em>uppercase</em> feature of our program:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># test_hello.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> subprocess <span style=color:#f92672>import</span> run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_smoke</span>(capfd):
</span></span><span style=display:flex><span>    run([<span style=color:#e6db74>&#34;./hello&#34;</span>])
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capfd<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Hello, World!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_uppercase</span>(capfd):
</span></span><span style=display:flex><span>    run([<span style=color:#e6db74>&#34;./hello&#34;</span>, <span style=color:#e6db74>&#34;-upper&#34;</span>])
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capfd<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;HELLO, WORLD!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pytest            
</span></span><span style=display:flex><span><span style=color:#f92672>==============================</span> test session starts <span style=color:#f92672>===============================</span>
</span></span><span style=display:flex><span>platform linux -- Python 3.11.11, pytest-8.3.4, pluggy-1.5.0
</span></span><span style=display:flex><span>rootdir: /home/andrea/projects/test
</span></span><span style=display:flex><span>collected <span style=color:#ae81ff>2</span> items                                                                    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_hello.py ..                                                           <span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>===============================</span> <span style=color:#ae81ff>2</span> passed in 0.02s <span style=color:#f92672>================================</span>
</span></span></code></pre></div><p>üéâ üéâ We doubled the test coverage, celebrate! üéâ üéâ Our job seems done &mldr;</p><p>Wait &mldr; Actually, how can you say when our tests are <strong>good enough</strong> ? <em>How much</em> of the program code are you actually running ? Do our tests avoid or miss some key feature ?</p><h2 id=-bring-in-the-meter>üå°Ô∏è Bring in the meter<a hidden class=anchor aria-hidden=true href=#-bring-in-the-meter>#</a></h2><p>For each test run, we need to measure the ratio between the code executed and the total code in the program. This is a tricky subject and mostly it depends on how the program is built, but as a first step we can use a feature that Go has introduced a couple of years ago, starting from <a href=https://go.dev/blog/integration-test-coverage>version 1.20</a>.</p><p>So, let&rsquo;s rebuild the program with coverage informations in the binary:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go build -cover hello.go
</span></span></code></pre></div><p>Once compiled, the program gives us an hint on something changed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./hello 
</span></span><span style=display:flex><span>warning: GOCOVERDIR not set, no coverage data emitted
</span></span><span style=display:flex><span>Hello, World!
</span></span></code></pre></div><p>The Go compiler <em>instrumented</em> the program, and now we need to give it a path where to store the collected coverage data.
So, lets&rsquo; prepare a simple script that will setup the environment and also run our test suite:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat cov_test.sh 
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>rm -rf covdatafiles
</span></span><span style=display:flex><span>mkdir covdatafiles
</span></span><span style=display:flex><span>rm hello <span style=color:#f92672>&amp;&amp;</span> go build -cover hello.go
</span></span><span style=display:flex><span>GOCOVERDIR<span style=color:#f92672>=</span>covdatafiles pytest
</span></span></code></pre></div><p>The run is apparently not changed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./cov_test.sh 
</span></span><span style=display:flex><span><span style=color:#f92672>==============================</span> test session starts <span style=color:#f92672>===============================</span>
</span></span><span style=display:flex><span>platform linux -- Python 3.11.11, pytest-8.3.4, pluggy-1.5.0
</span></span><span style=display:flex><span>rootdir: /home/andrea/projects/test
</span></span><span style=display:flex><span>collected <span style=color:#ae81ff>2</span> items                                                                    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_hello.py ..                                                           <span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>===============================</span> <span style=color:#ae81ff>2</span> passed in 0.02s <span style=color:#f92672>================================</span>
</span></span></code></pre></div><p>but now we have some data in a new subfolder:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls covdatafiles 
</span></span><span style=display:flex><span>covcounters.6d07efc23254e1696fe8a1428981e28e.13877.1740324625565161919
</span></span><span style=display:flex><span>covcounters.6d07efc23254e1696fe8a1428981e28e.13882.1740324625569223562
</span></span><span style=display:flex><span>covmeta.6d07efc23254e1696fe8a1428981e28e
</span></span></code></pre></div><p>these files are intended to be processed by another tool:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go tool covdata percent -i covdatafiles 
</span></span><span style=display:flex><span>	command-line-arguments		coverage: 85.7% of statements
</span></span></code></pre></div><h2 id=-another-baby-step>üê§ Another baby step<a hidden class=anchor aria-hidden=true href=#-another-baby-step>#</a></h2><p>let&rsquo;s add another test and see if our coverage increases:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> subprocess <span style=color:#f92672>import</span> run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_smoke</span>(capfd):
</span></span><span style=display:flex><span>    run([<span style=color:#e6db74>&#34;./hello&#34;</span>])
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capfd<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Hello, World!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_uppercase</span>(capfd):
</span></span><span style=display:flex><span>    run([<span style=color:#e6db74>&#34;./hello&#34;</span>, <span style=color:#e6db74>&#34;-upper&#34;</span>])
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capfd<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;HELLO, WORLD!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_header</span>(capfd):
</span></span><span style=display:flex><span>    run([<span style=color:#e6db74>&#34;./hello&#34;</span>, <span style=color:#e6db74>&#34;-header&#34;</span>])
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capfd<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;-------------</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Hello, World!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h2 id=-hooray->üöÄ Hooray !<a hidden class=anchor aria-hidden=true href=#-hooray->#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go tool covdata percent -i covdatafiles 
</span></span><span style=display:flex><span>	command-line-arguments		coverage: 92.9% of statements
</span></span></code></pre></div><p>We did a step forward, and we can safely claim <strong>our tests are better than before</strong>.</p><p>Since we are at it, let&rsquo;s integrate the <a href=https://pkg.go.dev/cmd/covdata>coverage output</a> into our test script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat cov_test.sh 
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>rm -rf covdatafiles
</span></span><span style=display:flex><span>mkdir covdatafiles
</span></span><span style=display:flex><span>rm hello <span style=color:#f92672>&amp;&amp;</span> go build -cover hello.go
</span></span><span style=display:flex><span>GOCOVERDIR<span style=color:#f92672>=</span>covdatafiles pytest
</span></span><span style=display:flex><span>go tool covdata percent -i covdatafiles
</span></span></code></pre></div><h2 id=-use-the-source-luke>üîé Use the source, Luke<a hidden class=anchor aria-hidden=true href=#-use-the-source-luke>#</a></h2><p>Now a question for the reader; looking at the source code of the program:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;World&#34;</span>, <span style=color:#e6db74>&#34;your name for greeting&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>count</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#e6db74>&#34;count&#34;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;number of times to repeat&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>isUpper</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;upper&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#e6db74>&#34;convert to uppercase&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>addHeader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Bool</span>(<span style=color:#e6db74>&#34;header&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#e6db74>&#34;print also a fancy header&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Hello, %s!&#34;</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Andrea&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>message</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34; Welcome back!&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>isUpper</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>message</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToUpper</span>(<span style=color:#a6e22e>message</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>addHeader</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Repeat</span>(<span style=color:#e6db74>&#34;-&#34;</span>, len(<span style=color:#a6e22e>message</span>)))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#f92672>*</span><span style=color:#a6e22e>count</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>message</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>can you think of one last test we can write to reach 100% coverage ? üòâ</p><p>Good news: we can have a visual hint by producing an html output!
We just need to add a couple more lines of post-processing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go tool covdata textfmt -i<span style=color:#f92672>=</span>covdatafiles -o<span style=color:#f92672>=</span>coverage.txt
</span></span><span style=display:flex><span>$ go tool cover -html coverage.txt
</span></span></code></pre></div><p><img alt="html coverage" loading=lazy src=/img/integration-coverage-html-screenshot.png></p><p>Oh yes, now it&rsquo;s very clear what we are missing &#x1f604;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_andrea</span>(capfd):
</span></span><span style=display:flex><span>    run([<span style=color:#e6db74>&#34;./hello&#34;</span>,<span style=color:#e6db74>&#34;-name&#34;</span>,<span style=color:#e6db74>&#34;Andrea&#34;</span>])
</span></span><span style=display:flex><span>    out, err <span style=color:#f92672>=</span> capfd<span style=color:#f92672>.</span>readouterr()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> out <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Hello, Andrea! Welcome back!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h2 id=-final-words>üß™ Final words<a hidden class=anchor aria-hidden=true href=#-final-words>#</a></h2><p>Thanks to the excellent <a href=https://go.dev/doc/build-cover>Go tooling</a>, adding coverage information to compiled binaries is straightforward and we can finally have an idea on how much code our tests are probing.</p><p>I&rsquo;m sure it&rsquo;s a very important metric to have, so we can think about some ways to expand this concept to other languages and technologies.</p><p>update: there is a follow up post, you can read it <a href=https://ilmanzo.github.io/post/measuring-test-coverage-on-binaries/>here</a></p><p>Feel free to leave me comments and feedback, happy hacking! &#x1f44b;</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/testing/>Testing</a></li><li><a href=https://ilmanzo.github.io/tags/tutorial/>Tutorial</a></li><li><a href=https://ilmanzo.github.io/tags/coverage/>Coverage</a></li><li><a href=https://ilmanzo.github.io/tags/go/>Go</a></li><li><a href=https://ilmanzo.github.io/tags/golang/>Golang</a></li><li><a href=https://ilmanzo.github.io/tags/qa/>Qa</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/measuring-test-coverage-on-binaries/><span class=title>¬´ Prev</span><br><span>How much code are you testing ? (2)</span>
</a><a class=next href=https://ilmanzo.github.io/post/systemd-socket-activated-services/><span class=title>Next ¬ª</span><br><span>Systemd Socket Activation Explained</span></a></nav></footer></article></main><footer class=footer><span>¬© 2012-2024 Andrea Manzini</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>