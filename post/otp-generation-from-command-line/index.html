<!doctype html><html lang=en><head><title>automate OTP credentials for multi-factor authentication &ndash; ilManzo's blog</title><meta name=description content="A minimalist, pragmatic website and personal blog"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://ilmanzo.github.io/css/palettes/gruvbox-dark.css><link rel=stylesheet href=https://ilmanzo.github.io/css/risotto.css><link rel=stylesheet href=https://ilmanzo.github.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://ilmanzo.github.io/ class=page__logo-inner>ilManzo's blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/curriculum title>Curriculum</a></li><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/categories title>Categories</a></li><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/tags title>Tags</a></li><li class=main-nav__item><a class="nav-main-item active" href=https://ilmanzo.github.io/post/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>automate OTP credentials for multi-factor authentication</h1></header><div class=content__body><h2 id=background>Background:</h2><p>I work with one or more terminal command-line always opened and having to pick up my phone to generate an OTP breaks my flow; also it&rsquo;s always nice to have an alternate source of multi-factor authentication if something bad happens, one day you could lose or break your trusty mobile device.</p><p>Therefore I was looking for a way to login through <a href=https://www.okta.com/>Okta</a> portals <em>without</em> a phone.
You may argument that this defeats the whole meaning of MFA, but let&rsquo;s say <em>it&rsquo;s only an hack for research and fun purpose</em> &mldr;</p><h2 id=disclaimer>DISCLAIMER:</h2><p>This setup should be used only on ANOTHER trusted device, so use it at your own risk, and be sure to always properly protect your credentials: security is a very serious topic.</p><h2 id=tldr>TLDR:</h2><p>With this setup, every time you write <code>:okta</code> in any text entry field, it will be replaced with a properly generated OTP!</p><p><img src=/img/okta_otp.gif alt=okta_otp></p><h2 id=requirements>Requirements:</h2><p>Install <a href=https://github.com/tadfisher/pass-otp#installation>pass-otp</a>.</p><p>for openSUSE Tumbleweed users like me, it&rsquo;s just a matter of</p><pre><code># zypper install pass-otp
</code></pre><h2 id=steps>Steps:</h2><p>If you already have multifactor authentication set up, start with step 1.</p><p>Otherwise, login up to the point where it asks you to &ldquo;Set up
(two-|multi)factor authentication&rdquo;, and go to step 4.</p><ol><li>Login to your organisation&rsquo;s Okta settings. The url is typically of the
form <code>https://OKTA_HOME_PAGE/enduser/settings</code>.</li></ol><p>For example,</p><ul><li>The University of Sydney: <a href=https://sso.sydney.edu.au/enduser/settings>https://sso.sydney.edu.au/enduser/settings</a></li><li>Garvan: <a href=https://garvan.okta.com/enduser/settings>https://garvan.okta.com/enduser/settings</a></li><li>Linkedin: <a href=https://linkedin.okta.com/enduser/settings>https://linkedin.okta.com/enduser/settings</a></li><li>Docusign: <a href=https://docusign.okta.com/enduser/settings>https://docusign.okta.com/enduser/settings</a></li><li>Groupon: <a href=https://groupon.okta.com//enduser/settings>https://groupon.okta.com//enduser/settings</a></li></ul><ol start=2><li><p>Scroll to &ldquo;Extra Verification&rdquo;. This is typically at the bottom on the
right.</p></li><li><p>If you already have Okta Verify or Google Authenticator set up with your
organisation, remove it.</p></li><li><p>Now you need to retrieve the secret one-time password (OTP) key.</p><ol><li><p>Click &ldquo;Set up&rdquo; next to &ldquo;Okta Verify&rdquo;.</p></li><li><p>If a button appears, click it. It may say &ldquo;Configure factor&rdquo; or &ldquo;Set
up&rdquo;.</p></li><li><p>Click &ldquo;iPhone&rdquo; or &ldquo;Android&rdquo;. It doesn&rsquo;t matter which one you pick, you
won&rsquo;t be needing a phone.</p></li><li><p>Click &ldquo;Next&rdquo;.</p></li><li><p>Click &ldquo;Can&rsquo;t scan?&rdquo;.</p></li><li><p>Click the first dropdown menu and select &ldquo;Setup manually without push
notification&rdquo;.</p></li><li><p>Copy the secret key to your clipboard.</p></li></ol></li><li><p>Create the OTP generator by running the following command, replacing
<code>OTP_NAME</code> with a name of your choosing. Paste the secret key when prompted.</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ pass otp insert -esi byebyeokta OTP_NAME
</span></span></code></pre></div><ol start=6><li>Generate the OTP by running the following command.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ pass otp OTP_NAME
</span></span></code></pre></div><p>Copy the output. Alternatively, use the <code>-c</code> option to copy it directly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ pass otp -c OTP_NAME
</span></span></code></pre></div><ol start=7><li><p>Enter the OTP.</p><ol><li><p>Click &ldquo;Next&rdquo;.</p></li><li><p>Paste the number in the &ldquo;Enter Code&rdquo; text box.</p></li><li><p>Click &ldquo;Verify&rdquo; to finish the setup.</p></li><li><p>You may have to click &ldquo;Finish&rdquo; as well.</p></li></ol></li><li><p>Now, whenever you are required to enter the OTP code in the future, simply
generate it by following step 6.</p></li></ol><h2 id=authenticator-app>Authenticator App</h2><p>Add the secret key to a OTP authenticator app. This is useful if you need to
use a different computer and don&rsquo;t have access to one which you set up
<code>pass-otp</code> with.</p><ol><li><p>Find a way to add a new account by entering the secret key manually into the
app. For the Okta Verify app, do the following. The steps are similar for
the Google Authenticator app.</p><ol><li><p>Press the &ldquo;+&rdquo; button in the top-right corner.</p></li><li><p>Press &ldquo;Other&rdquo;.</p></li><li><p>Press &ldquo;Enter Key Manually&rdquo;.</p></li><li><p>Type an Account Name of your choosing.</p></li><li><p>Type in the secret key. If you have lost the key, run the following
command to retrieve it.</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ pass OTP_NAME | awk -F <span style=color:#e6db74>&#39;[=&amp;]&#39;</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span>
</span></span></code></pre></div><ol start=6><li>Press &ldquo;Done&rdquo;.</li></ol></li><li><p>Confirm you get the same codes on your phone as when following step 6. If
not, you may have misspelled the secret key, in which case try again.</p></li><li><p>If you have an old account on a OTP authenticator app which you removed in
step 3 you can remove it from the app.</p></li></ol><h2 id=automating>Automating</h2><p>The goal is to auto fill and submit once prompted to enter the OTP code.</p><p>The <a href=https://github.com/sashajenner>original author</a> used <a href=https://github.com/qutebrowser/qutebrowser>qutebrowser</a>, binding a key chain to a <code>submit_otp_qute.sh</code>
userscript; so you can follow that</p><p>For other purposes, and many reasons, personally I&rsquo;m already using a tool like <a href=https://espanso.org/>Espanso</a>, but also <a href=https://github.com/autokey/autokey>AutoKey</a> and any other &ldquo;text-expander&rdquo; that is able run external commands can meet the requirements.</p><p>You can use an Espanso configuration snippet like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>trigger</span>: <span style=color:#e6db74>&#34;:okta&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replace</span>: <span style=color:#e6db74>&#34;{{output}}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>output</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>cmd</span>: <span style=color:#ae81ff>/usr/local/bin/submit_otp.sh OTP_NAME</span></span></span></code></pre></div><p>be sure to replace <code>OTP_NAME</code> with the one you chose before.</p><p>The script executed is quite easy, simply retrieve the code and echoes to stdout:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># user script that enters the otp code </span>
</span></span><span style=display:flex><span><span style=color:#75715e># designed to be used when prompted with the Okta Verify &#34;Enter Code&#34; form</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$#<span style=color:#e6db74>&#34;</span> -ne <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>	echo <span style=color:#e6db74>&#34;usage: </span>$0<span style=color:#e6db74> OTP_NAME&#34;</span>
</span></span><span style=display:flex><span>	exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>OTP_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># retrieve the otp</span>
</span></span><span style=display:flex><span>otp<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pass otp <span style=color:#e6db74>&#34;</span>$OTP_NAME<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$otp<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>	echo <span style=color:#e6db74>&#34;Unknown OTP_NAME &#39;</span>$OTP_NAME<span style=color:#e6db74>&#39;&#34;</span>
</span></span><span style=display:flex><span>	exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># insert the otp at the focussed text box and submit it</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$otp<span style=color:#e6db74>&#34;</span></span></span></code></pre></div><p><img src=/img/okta_otp.gif alt=okta_otp></p><p>have fun,</p><h2 id=credits>Credits</h2><p>Kudos to <a href=https://github.com/sashajenner>Sasha</a> for most of detailed instructions</p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://ilmanzo.github.io/images/rice.svg alt=Logo><h1 class=about__title>Andrea Manzini</h1><p class=about__description>A minimalist, pragmatic website and personal blog</p></div><ul class=aside__social-links><li><a href=https://github.com/ilmanzo rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:ilmanzo@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://www.linkedin.com/in/andreamanzini rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://twitter.com/ilmanzo rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://ilmanzo.github.io/index.xml rel=me aria-label="RSS Feed" title="RSS Feed"><i class="fas fa-rss-square" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>automate generation of OTP for multi-factor authentication</p><p>By Andrea Manzini,
2022-06-14</p></div></section><footer class=page__footer><p></p><br><br><p class=copyright>Â© 2022 Andrea Manzini</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>