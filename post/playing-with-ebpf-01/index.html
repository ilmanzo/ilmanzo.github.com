<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>playing with eBPF interface - 1 | ilManzo's blog</title>
<meta name=keywords content="python,C,linux,programming,learning,kernel,ebpf"><meta name=description content="some fun experiments with tracing and snooping linux kernel"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/playing-with-ebpf-01/><link crossorigin=anonymous href=/assets/css/stylesheet.e087fd1dc76e73a35ae6d7028ddc1ba41e0131e7f9b3a6e2d019a208e6d6c4b5.css integrity="sha256-4If9Hcduc6Na5tcCjdwbpB4BMef5s6bi0BmiCObWxLU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL",{anonymize_ip:!1})}</script><meta property="og:title" content="playing with eBPF interface - 1"><meta property="og:description" content="some fun experiments with tracing and snooping linux kernel"><meta property="og:type" content="article"><meta property="og:url" content="https://ilmanzo.github.io/post/playing-with-ebpf-01/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-05-11T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-11T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="playing with eBPF interface - 1"><meta name=twitter:description content="some fun experiments with tracing and snooping linux kernel"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"playing with eBPF interface - 1","item":"https://ilmanzo.github.io/post/playing-with-ebpf-01/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"playing with eBPF interface - 1","name":"playing with eBPF interface - 1","description":"some fun experiments with tracing and snooping linux kernel","keywords":["python","C","linux","programming","learning","kernel","ebpf"],"articleBody":"eBPF is a revolutionary technology that can run sandboxed programs in the Linux kernel without changing kernel source code or loading kernel modules. Basically any user can write code for a virtual machine that can interact with the kernel data structure and functions.\nbcc is an high-level helper interface to eBPF (another is bpftrace). To use it, start by following installation guide , but if you have a recent Debian system, it’s just a matter of installing some packages:\nsudo apt install bpfcc-tools python3-bpfcc libbpfcc libbpfcc-dev Now let’s test our installation with the classical ‘Hello, world’\n#!/usr/bin/python3 # run with: # sudo ./hello_world.py import bcc my_probe_src = r\"\"\" int hello(void *ctx) { bpf_trace_printk(\"Hello world!\\n\"); return 0; } \"\"\" bpf = bcc.BPF(text=my_probe_src) bpf.attach_kprobe(event=bpf.get_syscall_fnname(\"clone\"), fn_name=\"hello\") bpf.trace_print() What does this program do ? It uses the BCC framework to attach a simple “probe” to the linux kernel sys_clone() function, so each time the function is called, our hook gets executed. So when you run this simple program, you’ll see on your terminal the message every time the syscall clone() function gets called.\nb' \u003c...\u003e-82733 [002] d... 11828.394029: bpf_trace_printk: Hello world!' b'' b' \u003c...\u003e-82225 [004] d... 11828.394071: bpf_trace_printk: Hello world!' b'' b' DedicatedWorker-6802 [005] d... 11842.465428: bpf_trace_printk: Hello world!' b'' b' \u003c...\u003e-82723 [004] d... 11842.465491: bpf_trace_printk: Hello world!' b'' b' \u003c...\u003e-82956 [000] d... 11842.466093: bpf_trace_printk: Hello world!' b'' b' ThreadPoolForeg-6590 [001] d... 11842.815580: bpf_trace_printk: Hello world!' There is a lot to know about eBPF; What’s the meaning of all the data displayed ? How to decode arguments ? How to obtain data values from probe ? What can we do in our function ? We have of course barely scratched the surface; we’ll see in the next post!\n","wordCount":"284","inLanguage":"en","datePublished":"2021-05-11T00:00:00Z","dateModified":"2021-05-11T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/playing-with-ebpf-01/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">playing with eBPF interface - 1</h1><div class=post-description>some fun experiments with tracing and snooping linux kernel</div><div class=post-meta><span title='2021-05-11 00:00:00 +0000 UTC'>May 11, 2021</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><p><a href=https://ebpf.io/>eBPF</a> is a revolutionary technology that can run sandboxed programs in the Linux kernel without changing kernel source code or loading kernel modules. Basically any user can write code for a virtual machine that can interact with the kernel data structure and functions.</p><p><a href=https://github.com/iovisor/bcc>bcc</a> is an high-level helper interface to eBPF (another is <a href=https://github.com/iovisor/bpftrace>bpftrace</a>). To use it, start by <a href=https://github.com/iovisor/bcc/blob/master/INSTALL.md>following installation guide</a> , but if you have a recent Debian system, it&rsquo;s just a matter of installing some packages:</p><pre><code>sudo apt install bpfcc-tools python3-bpfcc libbpfcc libbpfcc-dev
</code></pre><p>Now let&rsquo;s test our installation with the classical &lsquo;Hello, world&rsquo;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># run with:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo ./hello_world.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> bcc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>my_probe_src <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>int hello(void *ctx) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  bpf_trace_printk(&#34;Hello world!\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  return 0;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bpf <span style=color:#f92672>=</span> bcc<span style=color:#f92672>.</span>BPF(text<span style=color:#f92672>=</span>my_probe_src)
</span></span><span style=display:flex><span>bpf<span style=color:#f92672>.</span>attach_kprobe(event<span style=color:#f92672>=</span>bpf<span style=color:#f92672>.</span>get_syscall_fnname(<span style=color:#e6db74>&#34;clone&#34;</span>), fn_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hello&#34;</span>)
</span></span><span style=display:flex><span>bpf<span style=color:#f92672>.</span>trace_print()</span></span></code></pre></div><p>What does this program do ? It uses the <a href=https://github.com/iovisor/bcc>BCC framework</a> to attach a simple &ldquo;probe&rdquo; to the linux kernel <em>sys_clone()</em> function, so each time the function is called, our hook gets executed.
So when you run this simple program, you&rsquo;ll see on your terminal the message every time the syscall <em>clone()</em> function gets called.</p><pre><code>b'           &lt;...&gt;-82733   [002] d... 11828.394029: bpf_trace_printk: Hello world!'
b''
b'           &lt;...&gt;-82225   [004] d... 11828.394071: bpf_trace_printk: Hello world!'
b''
b' DedicatedWorker-6802    [005] d... 11842.465428: bpf_trace_printk: Hello world!'
b''
b'           &lt;...&gt;-82723   [004] d... 11842.465491: bpf_trace_printk: Hello world!'
b''
b'           &lt;...&gt;-82956   [000] d... 11842.466093: bpf_trace_printk: Hello world!'
b''
b' ThreadPoolForeg-6590    [001] d... 11842.815580: bpf_trace_printk: Hello world!'
</code></pre><p>There is a lot to know about eBPF; What&rsquo;s the meaning of all the data displayed ? How to decode arguments ? How to obtain data values from probe ? What can we do in our function ? We have of course barely scratched the surface; we&rsquo;ll see in the next post!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/python/>python</a></li><li><a href=https://ilmanzo.github.io/tags/c/>C</a></li><li><a href=https://ilmanzo.github.io/tags/linux/>linux</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>programming</a></li><li><a href=https://ilmanzo.github.io/tags/learning/>learning</a></li><li><a href=https://ilmanzo.github.io/tags/kernel/>kernel</a></li><li><a href=https://ilmanzo.github.io/tags/ebpf/>ebpf</a></li></ul></footer></article></main><footer class=footer><span>© 2012-2023 Andrea Manzini</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>