<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Refactoring the D Koans with metaprogramming | ilManzo's blog</title><meta name=keywords content="D,dlang,programming,learning,metaprogramming,test,koans"><meta name=description content="How metaprogramming helped create a cleaner testing experience for D Koans"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/refactoring-d-koans-with-metaprogramming/><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/refactoring-d-koans-with-metaprogramming/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL")}</script><meta property="og:url" content="https://ilmanzo.github.io/post/refactoring-d-koans-with-metaprogramming/"><meta property="og:site_name" content="ilManzo's blog"><meta property="og:title" content="Refactoring the D Koans with metaprogramming"><meta property="og:description" content="How metaprogramming helped create a cleaner testing experience for D Koans"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-05-21T00:00:00+00:00"><meta property="article:modified_time" content="2025-05-21T00:00:00+00:00"><meta property="article:tag" content="D"><meta property="article:tag" content="Dlang"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Learning"><meta property="article:tag" content="Metaprogramming"><meta property="article:tag" content="Test"><meta name=twitter:card content="summary"><meta name=twitter:title content="Refactoring the D Koans with metaprogramming"><meta name=twitter:description content="How metaprogramming helped create a cleaner testing experience for D Koans"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"Refactoring the D Koans with metaprogramming","item":"https://ilmanzo.github.io/post/refactoring-d-koans-with-metaprogramming/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Refactoring the D Koans with metaprogramming","name":"Refactoring the D Koans with metaprogramming","description":"How metaprogramming helped create a cleaner testing experience for D Koans","keywords":["D","dlang","programming","learning","metaprogramming","test","koans"],"articleBody":"💡 The problem Welcome back, it’s been quite a long time since my last ramblings on the D Programming Language!\nThis post is born from a necessity. An old project of mine, the D Koans, was using an external library to simplify unit testing, which is more or less the core of the whole project. Unfortunately, the library started giving some deprecation warnings when compiled with recent D versions.\nSince the D Language already has an internal unit testing framework, I thought it would be nice to remove the single dependency and rely only on the standard library. Initially, with some global search/replace, I managed to convert all the tests to unittest blocks.\n😫 Stack traces are ugly Running these tests presented another challenge. Using the standard unit testing directly would confront users with dense error messages, such as:\ncore.exception.AssertError@koans/alias_this.d(39): unittest failure ---------------- ??:? _d_unittestp [0x4bb84d] koans/alias_this.d:39 void koans.alias_this.__unittest_L34_C1() [0x48b731] ??:? void koans.alias_this.__modtest() [0x48b788] ??:? int core.runtime.runModuleUnitTests().__foreachbody_L603_C5(object.ModuleInfo*) [0x4ccdb2] ??:? int object.ModuleInfo.opApply(scope int delegate(object.ModuleInfo*)).__lambda_L2467_C13(immutable(object.ModuleInfo*)) [0x4b2867] ??:? int rt.minfo.moduleinfos_apply(scope int delegate(immutable(object.ModuleInfo*))).__foreachbody_L582_C5(ref rt.sections_elf_shared.DSO) [0x4c1dc7] ??:? int rt.sections_elf_shared.DSO.opApply(scope int delegate(ref rt.sections_elf_shared.DSO)) [0x4c2149] ??:? int rt.minfo.moduleinfos_apply(scope int delegate(immutable(object.ModuleInfo*))) [0x4c1d55] ??:? int object.ModuleInfo.opApply(scope int delegate(object.ModuleInfo*)) [0x4b2839] ??:? runModuleUnitTests [0x4ccbe7] ??:? void rt.dmain2._d_run_main2(char[][], ulong, extern (C) int function(char[][])*).runAll() [0x4c00dc] ??:? void rt.dmain2._d_run_main2(char[][], ulong, extern (C) int function(char[][])*).tryExec(scope void delegate()) [0x4c0069] ??:? _d_run_main2 [0x4bffd2] ??:? _d_run_main [0x4bfdbb] /usr/include/dlang/dmd/core/internal/entrypoint.d:29 main [0x484a69] ??:? [0x7f94bda2b12d] ??:? __libc_start_main [0x7f94bda2b1f8] /:115 _start [0x484884] core.exception.AssertError@koans/arrays.d(8): unittest failure which is less than ideal for a newbie; also all the unit tests run in parallel so you’d get a wall of weird text.\n🦸 Metaprogramming to the rescue The solution is to collect all the unit tests and run them manually in a foreach loop! This leads to another problem: the project is composed of many modules, similar to progressive “exercises” that the student must complete to learn. How do we enumerate all the modules, in a somewhat defined order, and make sure the main program imports them, and ensure the main program can import and call their functions? Let me introduce metaprogramming :)\nSince all the exercises are in a directory, it’s easy to group them in a single package module\n$ tree . ├── dscanner.ini ├── dub.json ├── koans │ ├── alias_this.d │ ├── arrays.d │ ├── associative_arrays.d │ ├── basics.d │ ├── bitwise_operators.d │ ├── chars.d │ ├── c_interop.d │ ├── classes.d │ ├── concurrency.d │ ├── ctfe.d │ ├── delegates.d │ ├── enums.d │ ├── exceptions.d │ ├── files.d │ ├── foreach_loop.d │ ├── function_parameters.d │ ├── helpers.d │ ├── lambda_syntax.d │ ├── mixins.d │ ├── numbers.d │ ├── operator_overloading.d │ ├── package.d \u003c--------------- THIS │ ├── pointers.d │ ├── properties.d │ ├── strings.d │ ├── structs.d │ ├── templates.d │ ├── traits.d │ ├── tuples.d │ └── unions.d ├── learn.d ├── README.md └── scripts ├── runner_linux.sh └── runner_osx.sh our package.d is simple:\n1 2 3 4 5 6 7 8 9 10 // koans/package.d module koans; static immutable koansModules = [ \"basics\", \"numbers\", \"chars\", \"strings\", // ... enumerate all the exercises modules ]; static foreach (m; koansModules) mixin(\"public static import koans.\" ~ m ~ \";\"); instead of importing all the modules, we use a loop to create at compile time the import statements. In this way, the main program only needs to import koans as a whole package.\nnote: we will reuse the same list of modules in the main program:\n⚙️ A custom test runner 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // learn.d module learn; import core.runtime; import std.stdio; import koans; static import core.exception; shared static this() { // Override the default unit test runner to do nothing. // After that, \"main\" will be called. Runtime.moduleUnitTester = { return true; }; } void main() { writeln(\"Starting your journey to enlightenment...\"); writeln(\"You will be asked to fill in the blanks in the koans.\"); writeln(\"Ensure to run 'dub --build=unittest' to run the tests.\"); static foreach (m; koans.koansModules) { mixin(\"static import koans.\" ~ m ~ \";\"); foreach (t; __traits(getUnitTests, mixin(\"koans.\" ~ m))) { try t(); catch (core.exception.AssertError e) { writeln(\"Meditate more on \", e.file, \" at line \", e.line); return; } } } writeln(\"You have reached the end of your journey\"); } The important parts are:\nline 9-14 : need to override the default Runtime.moduleUnitTester function. This will let our main run even when the program is compiled with --unittest flag. line 21: iterate on each module, reusing the same array of strings previously defined in package.d line 23: build a scoped import statement with the module name, prefixed by package name (e.g. koans.basics) line 24: use traits to iterate over all unit tests of that module, calling the unit test (which is wrapped as a function) inside a try-catch block in order to capture the AssertError line 29: if the unit test fails, give the user instructions on which line of which file needs to change and the program terminates (mandatory AI-generated catchy image)\n✅ Conclusions My project now does not depend on any other library, and it will be very simple to add new tests: just follow the language conventions and create a new file with unit tests, then write its name in the proper position of the array.\nI hope this practical example of D’s capabilities was insightful. More importantly, has it made you curious to learn more about the D programming language itself?\nHave you used D’s metaprogramming for similar tasks? Feedbacks are welcome!\n","wordCount":"926","inLanguage":"en","datePublished":"2025-05-21T00:00:00Z","dateModified":"2025-05-21T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/refactoring-d-koans-with-metaprogramming/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Refactoring the D Koans with metaprogramming</h1><div class=post-description>How metaprogramming helped create a cleaner testing experience for D Koans</div><div class=post-meta><span title='2025-05-21 00:00:00 +0000 UTC'>May 21, 2025</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><h2 id=-the-problem>💡 The problem<a hidden class=anchor aria-hidden=true href=#-the-problem>#</a></h2><p>Welcome back, it&rsquo;s been quite a long time since my <a href=https://ilmanzo.github.io/post/fileinput-for-d-programming-language/>last ramblings</a> on the <a href=https://dlang.org/>D Programming Language</a>!</p><p>This post is born from a necessity. An old project of mine, the <a href=https://github.com/ilmanzo/DLangKoans>D Koans</a>, was using an external library to simplify unit testing, which is more or less the core of the whole project. Unfortunately, the library started giving <a href=https://github.com/linkrope/dunit/issues/36>some deprecation warnings</a> when compiled with recent D versions.</p><p>Since the D Language already has an internal <a href=https://dlang.org/spec/unittest.html>unit testing framework</a>, I thought it would be nice to remove the single dependency and rely only on the standard library. Initially, with some global search/replace, I managed to convert all the tests to <code>unittest</code> blocks.</p><p><img alt=dlang_meme loading=lazy src=/img/dlang_explain_meme.jpg></p><h2 id=-stack-traces-are-ugly>😫 Stack traces are ugly<a hidden class=anchor aria-hidden=true href=#-stack-traces-are-ugly>#</a></h2><p>Running these tests presented another challenge. Using the standard unit testing directly would confront users with dense error messages, such as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>core.exception.AssertError@koans/alias_this.d(39): unittest failure
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span>??:? _d_unittestp [0x4bb84d]
</span></span><span style=display:flex><span>koans/alias_this.d:39 void koans.alias_this.__unittest_L34_C1() [0x48b731]
</span></span><span style=display:flex><span>??:? void koans.alias_this.__modtest() [0x48b788]
</span></span><span style=display:flex><span>??:? int core.runtime.runModuleUnitTests().__foreachbody_L603_C5(object.ModuleInfo*) [0x4ccdb2]
</span></span><span style=display:flex><span>??:? int object.ModuleInfo.opApply(scope int delegate(object.ModuleInfo*)).__lambda_L2467_C13(immutable(object.ModuleInfo*)) [0x4b2867]
</span></span><span style=display:flex><span>??:? int rt.minfo.moduleinfos_apply(scope int delegate(immutable(object.ModuleInfo*))).__foreachbody_L582_C5(ref rt.sections_elf_shared.DSO) [0x4c1dc7]
</span></span><span style=display:flex><span>??:? int rt.sections_elf_shared.DSO.opApply(scope int delegate(ref rt.sections_elf_shared.DSO)) [0x4c2149]
</span></span><span style=display:flex><span>??:? int rt.minfo.moduleinfos_apply(scope int delegate(immutable(object.ModuleInfo*))) [0x4c1d55]
</span></span><span style=display:flex><span>??:? int object.ModuleInfo.opApply(scope int delegate(object.ModuleInfo*)) [0x4b2839]
</span></span><span style=display:flex><span>??:? runModuleUnitTests [0x4ccbe7]
</span></span><span style=display:flex><span>??:? void rt.dmain2._d_run_main2(char[][], ulong, extern (C) int function(char[][])*).runAll() [0x4c00dc]
</span></span><span style=display:flex><span>??:? void rt.dmain2._d_run_main2(char[][], ulong, extern (C) int function(char[][])*).tryExec(scope void delegate()) [0x4c0069]
</span></span><span style=display:flex><span>??:? _d_run_main2 [0x4bffd2]
</span></span><span style=display:flex><span>??:? _d_run_main [0x4bfdbb]
</span></span><span style=display:flex><span>/usr/include/dlang/dmd/core/internal/entrypoint.d:29 main [0x484a69]
</span></span><span style=display:flex><span>??:? [0x7f94bda2b12d]
</span></span><span style=display:flex><span>??:? __libc_start_main [0x7f94bda2b1f8]
</span></span><span style=display:flex><span>&lt;unknown dir&gt;/&lt;unknown file&gt;:115 _start [0x484884]
</span></span><span style=display:flex><span>core.exception.AssertError@koans/arrays.d(8): unittest failure
</span></span></code></pre></div><p>which is less than ideal for a newbie; also all the unit tests run in parallel so you&rsquo;d get a wall of weird text.</p><h2 id=-metaprogramming-to-the-rescue>🦸 Metaprogramming to the rescue<a hidden class=anchor aria-hidden=true href=#-metaprogramming-to-the-rescue>#</a></h2><p>The solution is to <em>collect</em> all the unit tests and run them manually in a <code>foreach</code> loop!
This leads to another problem: the project is composed of many modules, similar to progressive <em>&ldquo;exercises&rdquo;</em> that the student must complete to learn. How do we enumerate all the modules, in a somewhat defined order, and make sure the main program imports them, and ensure the main program can import and call their functions? Let me introduce <strong>metaprogramming</strong> :)</p><p>Since all the exercises are in a directory, it&rsquo;s easy to group them in a single <a href=https://dlang.org/spec/module.html#package-module><code>package module</code></a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tree   
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── dscanner.ini
</span></span><span style=display:flex><span>├── dub.json
</span></span><span style=display:flex><span>├── koans
</span></span><span style=display:flex><span>│   ├── alias_this.d
</span></span><span style=display:flex><span>│   ├── arrays.d
</span></span><span style=display:flex><span>│   ├── associative_arrays.d
</span></span><span style=display:flex><span>│   ├── basics.d
</span></span><span style=display:flex><span>│   ├── bitwise_operators.d
</span></span><span style=display:flex><span>│   ├── chars.d
</span></span><span style=display:flex><span>│   ├── c_interop.d
</span></span><span style=display:flex><span>│   ├── classes.d
</span></span><span style=display:flex><span>│   ├── concurrency.d
</span></span><span style=display:flex><span>│   ├── ctfe.d
</span></span><span style=display:flex><span>│   ├── delegates.d
</span></span><span style=display:flex><span>│   ├── enums.d
</span></span><span style=display:flex><span>│   ├── exceptions.d
</span></span><span style=display:flex><span>│   ├── files.d
</span></span><span style=display:flex><span>│   ├── foreach_loop.d
</span></span><span style=display:flex><span>│   ├── function_parameters.d
</span></span><span style=display:flex><span>│   ├── helpers.d
</span></span><span style=display:flex><span>│   ├── lambda_syntax.d
</span></span><span style=display:flex><span>│   ├── mixins.d
</span></span><span style=display:flex><span>│   ├── numbers.d
</span></span><span style=display:flex><span>│   ├── operator_overloading.d
</span></span><span style=display:flex><span>│   ├── package.d  &lt;--------------- THIS
</span></span><span style=display:flex><span>│   ├── pointers.d
</span></span><span style=display:flex><span>│   ├── properties.d
</span></span><span style=display:flex><span>│   ├── strings.d
</span></span><span style=display:flex><span>│   ├── structs.d
</span></span><span style=display:flex><span>│   ├── templates.d
</span></span><span style=display:flex><span>│   ├── traits.d
</span></span><span style=display:flex><span>│   ├── tuples.d
</span></span><span style=display:flex><span>│   └── unions.d
</span></span><span style=display:flex><span>├── learn.d
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>└── scripts
</span></span><span style=display:flex><span>    ├── runner_linux.sh
</span></span><span style=display:flex><span>    └── runner_osx.sh
</span></span></code></pre></div><p>our <code>package.d</code> is simple:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-D data-lang=D><span style=display:flex><span><span style=color:#75715e>// koans/package.d 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>module</span> koans<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>immutable</span> koansModules <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;basics&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;numbers&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;chars&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;strings&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... enumerate all the exercises modules
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#a6e22e>foreach</span> <span style=color:#f92672>(</span>m<span style=color:#f92672>;</span> koansModules<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>mixin</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;public static import koans.&#34;</span> <span style=color:#f92672>~</span> m <span style=color:#f92672>~</span> <span style=color:#e6db74>&#34;;&#34;</span><span style=color:#f92672>);</span></span></span></code></pre></td></tr></table></div></div><p>instead of importing all the modules, we use a loop to create <em>at compile time</em> the import statements. In this way, the main program only needs to <code>import koans</code> as a whole package.</p><p>note: we will reuse the same list of modules in the <code>main</code> program:</p><h2 id=-a-custom-test-runner>⚙️ A custom test runner<a hidden class=anchor aria-hidden=true href=#-a-custom-test-runner>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-D data-lang=D><span style=display:flex><span><span style=color:#75715e>// learn.d
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>module</span> learn<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> core.runtime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> std.stdio<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> koans<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#f92672>import</span> core.exception<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>shared</span> <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>this</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Override the default unit test runner to do nothing. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// After that, &#34;main&#34; will be called.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Runtime<span style=color:#f92672>.</span><span style=color:#a6e22e>moduleUnitTester</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span> <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    writeln<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Starting your journey to enlightenment...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    writeln<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;You will be asked to fill in the blanks in the koans.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    writeln<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Ensure to run &#39;dub --build=unittest&#39; to run the tests.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>foreach</span> <span style=color:#f92672>(</span>m<span style=color:#f92672>;</span> koans<span style=color:#f92672>.</span><span style=color:#a6e22e>koansModules</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>mixin</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;static import koans.&#34;</span> <span style=color:#f92672>~</span> m <span style=color:#f92672>~</span> <span style=color:#e6db74>&#34;;&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> <span style=color:#f92672>(</span>t<span style=color:#f92672>;</span> __traits<span style=color:#f92672>(</span>getUnitTests<span style=color:#f92672>,</span> <span style=color:#66d9ef>mixin</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;koans.&#34;</span> <span style=color:#f92672>~</span> m<span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> t<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>core<span style=color:#f92672>.</span><span style=color:#a6e22e>exception</span><span style=color:#f92672>.</span><span style=color:#a6e22e>AssertError</span> e<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                writeln<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Meditate more on &#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>file</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34; at line &#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>line</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    writeln<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;You have reached the end of your journey&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></td></tr></table></div></div><p>The important parts are:</p><ul><li>line 9-14 : need to override the default Runtime.moduleUnitTester function. This will let our <code>main</code> run even when the program is compiled with <code>--unittest</code> flag.</li><li>line 21: iterate on each module, reusing the same array of strings previously defined in <code>package.d</code></li><li>line 23: build a scoped import statement with the module name, prefixed by package name (e.g. <code>koans.basics</code>)</li><li>line 24: use <a href=https://dlang.org/spec/traits.html>traits</a> to iterate over all unit tests of that module, calling the unit test (which is wrapped as a function) inside a <code>try-catch</code> block in order to capture the AssertError</li><li>line 29: if the unit test fails, give the user instructions on which line of which file needs to change and the program terminates</li></ul><p><img alt=dlang loading=lazy src=/img/DLang.jpg>
(mandatory AI-generated catchy image)</p><h2 id=-conclusions>✅ Conclusions<a hidden class=anchor aria-hidden=true href=#-conclusions>#</a></h2><p>My project now does not depend on any other library, and it will be very simple to add new tests: just follow the language conventions and create a new file with unit tests, then write its name in the proper position of the array.</p><p>I hope this practical example of D&rsquo;s capabilities was insightful. More importantly, has it made you curious to learn more about the D programming language itself?</p><p>Have you used D&rsquo;s metaprogramming for similar tasks? Feedbacks are welcome!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/d/>D</a></li><li><a href=https://ilmanzo.github.io/tags/dlang/>Dlang</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>Programming</a></li><li><a href=https://ilmanzo.github.io/tags/learning/>Learning</a></li><li><a href=https://ilmanzo.github.io/tags/metaprogramming/>Metaprogramming</a></li><li><a href=https://ilmanzo.github.io/tags/test/>Test</a></li><li><a href=https://ilmanzo.github.io/tags/koans/>Koans</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/pintool-function-tracing/><span class=title>« Prev</span><br><span>How much code are you testing ? (3)</span>
</a><a class=next href=https://ilmanzo.github.io/post/measuring-test-coverage-on-binaries/><span class=title>Next »</span><br><span>How much code are you testing ? (2)</span></a></nav></footer></article></main><footer class=footer><span>© 2012-2025 Andrea Manzini</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>