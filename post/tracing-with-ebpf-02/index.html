<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>playing with eBPF interface - 2 | ilManzo's blog</title>
<meta name=keywords content="python,C,linux,programming,learning,kernel,ebpf"><meta name=description content="some fun experiments with tracing and snooping linux kernel"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/tracing-with-ebpf-02/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL",{anonymize_ip:!1})}</script><meta property="og:title" content="playing with eBPF interface - 2"><meta property="og:description" content="some fun experiments with tracing and snooping linux kernel"><meta property="og:type" content="article"><meta property="og:url" content="https://ilmanzo.github.io/post/tracing-with-ebpf-02/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-05-19T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-19T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="playing with eBPF interface - 2"><meta name=twitter:description content="some fun experiments with tracing and snooping linux kernel"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"playing with eBPF interface - 2","item":"https://ilmanzo.github.io/post/tracing-with-ebpf-02/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"playing with eBPF interface - 2","name":"playing with eBPF interface - 2","description":"some fun experiments with tracing and snooping linux kernel","keywords":["python","C","linux","programming","learning","kernel","ebpf"],"articleBody":"In the last post we introduced the BCC framework to interface Python code with eBPF facility. Now we are ready to make one step further!\n#!/usr/bin/python3 import bcc bpf = bcc.BPF(text=\"\"\" #include int trace_malloc(struct pt_regs *ctx, size_t size) { bpf_trace_printk(\"size=%d\\\\n\",size); return 0; };\"\"\") bpf.attach_uprobe(name=\"c\",sym=\"malloc\",fn_name=\"trace_malloc\") while 1: (task, pid, cpu, flags, ts, msg) = bpf.trace_fields() print(f\"task={task}\\tmsg={msg}\") This code is a little more complex, but still quite easy: first of all we use bcc to attach an “user space probe” instead of a kernel probe, and the function being observed will be libc’s malloc.\nIn the tracing code itself, we simply report the parameter given to malloc function to the outside world, so with an infinite loop we print the tracing messages. Just to make it more explicit, we extract all the fields one by one and print only two of them.\nIt works like this: eBPF probe writes to a shared pipe named /sys/kernel/debug/tracing/trace_pipe , and python code reads from that pipe. The result is a fast scrolling stream of all the malloc invocations from all running programs, followed by the size requested.\n| Field | Field | |Number | Name | Meaning | ---- | ----- | ------- | 0 | task | The name of the application running when the probe fired | | 1 | pid | process id (PID) of the application | | 2 | cpu | The CPU it was running on | | 3 | flags | Various process context flags | | 4 | ts | A timestamp | | 5 | msg | The string that we passed to bpf_trace_printk() | task=b'Xorg'\tmsg=b'size=24' task=b'Xorg'\tmsg=b'size=24' task=b'gnome-terminal-'\tmsg=b'size=36' task=b'gnome-terminal-'\tmsg=b'size=16' task=b'Xorg'\tmsg=b'size=24' task=b'gnome-terminal-'\tmsg=b'size=24' task=b'gnome-terminal-'\tmsg=b'size=124' task=b'Xorg'\tmsg=b'size=24' task=b'gnome-terminal-'\tmsg=b'size=16' task=b'gnome-terminal-'\tmsg=b'size=312' task=b'Xorg'\tmsg=b'size=24' task=b'gnome-terminal-'\tmsg=b'size=72' ","wordCount":"294","inLanguage":"en","datePublished":"2021-05-19T00:00:00Z","dateModified":"2021-05-19T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/tracing-with-ebpf-02/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">playing with eBPF interface - 2</h1><div class=post-description>some fun experiments with tracing and snooping linux kernel</div><div class=post-meta><span title='2021-05-19 00:00:00 +0000 UTC'>May 19, 2021</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><p>In the <a href=https://ilmanzo.github.io/post/playing-with-ebpf-01/>last post</a> we introduced the <a href=https://github.com/iovisor/bcc>BCC framework</a> to interface Python code with eBPF facility. Now we are ready to make one step further!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> bcc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bpf <span style=color:#f92672>=</span> bcc<span style=color:#f92672>.</span>BPF(text<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#include &lt;uapi/linux/ptrace.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>int trace_malloc(struct pt_regs *ctx, size_t size) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    bpf_trace_printk(&#34;size=</span><span style=color:#e6db74>%d</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>n&#34;,size);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return 0;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>};&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bpf<span style=color:#f92672>.</span>attach_uprobe(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;c&#34;</span>,sym<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;malloc&#34;</span>,fn_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;trace_malloc&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>    (task, pid, cpu, flags, ts, msg) <span style=color:#f92672>=</span> bpf<span style=color:#f92672>.</span>trace_fields()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;task=</span><span style=color:#e6db74>{</span>task<span style=color:#e6db74>}</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>msg=</span><span style=color:#e6db74>{</span>msg<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)</span></span></code></pre></div><p>This code is a little more complex, but still quite easy: first of all we use <em>bcc</em> to attach an &ldquo;user space probe&rdquo; instead of a kernel probe, and the function being observed will be libc&rsquo;s <strong>malloc</strong>.</p><p>In the tracing code itself, we simply report the parameter given to malloc function to the outside world, so with an infinite loop we print the tracing messages. Just to make it more explicit, we extract all the fields one by one and print only two of them.</p><p>It works like this: eBPF probe writes to a shared pipe named <code>/sys/kernel/debug/tracing/trace_pipe</code> , and python code reads from that pipe. The result is a fast scrolling stream of all the malloc invocations from all running programs, followed by the size requested.</p><pre><code>| Field | Field |                  
|Number | Name  | Meaning 
| ----  | ----- | -------    
| 0     | task  | The name of the application running when the probe fired  |
| 1     | pid   | process id (PID) of the application |
| 2     | cpu   | The CPU it was running on |
| 3     | flags | Various process context flags |
| 4     | ts    | A timestamp |
| 5     | msg   | The string that we passed to bpf_trace_printk() |

task=b'Xorg'	msg=b'size=24'
task=b'Xorg'	msg=b'size=24'
task=b'gnome-terminal-'	msg=b'size=36'
task=b'gnome-terminal-'	msg=b'size=16'
task=b'Xorg'	msg=b'size=24'
task=b'gnome-terminal-'	msg=b'size=24'
task=b'gnome-terminal-'	msg=b'size=124'
task=b'Xorg'	msg=b'size=24'
task=b'gnome-terminal-'	msg=b'size=16'
task=b'gnome-terminal-'	msg=b'size=312'
task=b'Xorg'	msg=b'size=24'
task=b'gnome-terminal-'	msg=b'size=72'
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/python/>python</a></li><li><a href=https://ilmanzo.github.io/tags/c/>C</a></li><li><a href=https://ilmanzo.github.io/tags/linux/>linux</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>programming</a></li><li><a href=https://ilmanzo.github.io/tags/learning/>learning</a></li><li><a href=https://ilmanzo.github.io/tags/kernel/>kernel</a></li><li><a href=https://ilmanzo.github.io/tags/ebpf/>ebpf</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/writing-python-modules-in-rust-1/><span class=title>« Prev</span><br><span>integration between Python and Rust - Part 1</span>
</a><a class=next href=https://ilmanzo.github.io/post/playing-with-ebpf-01/><span class=title>Next »</span><br><span>playing with eBPF interface - 1</span></a></nav></footer></article></main><footer class=footer><span>© 2012-2023 Andrea Manzini</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>