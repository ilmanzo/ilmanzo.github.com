<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using containers for unit testing of bash functions | ilManzo's blog</title>
<meta name=keywords content="programming,bash,testing,test,container,podman,unit testing"><meta name=description content="How to create an isolate environment to safely test your bash scripts"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/unit_testing_bash_functions/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ilmanzo.github.io/post/unit_testing_bash_functions/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL",{anonymize_ip:!1})}</script><meta property="og:title" content="Using containers for unit testing of bash functions"><meta property="og:description" content="How to create an isolate environment to safely test your bash scripts"><meta property="og:type" content="article"><meta property="og:url" content="https://ilmanzo.github.io/post/unit_testing_bash_functions/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-08-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using containers for unit testing of bash functions"><meta name=twitter:description content="How to create an isolate environment to safely test your bash scripts"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"Using containers for unit testing of bash functions","item":"https://ilmanzo.github.io/post/unit_testing_bash_functions/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using containers for unit testing of bash functions","name":"Using containers for unit testing of bash functions","description":"How to create an isolate environment to safely test your bash scripts","keywords":["programming","bash","testing","test","container","podman","unit testing"],"articleBody":"Intro Unit testing of Bash functions involves the process of systematically verifying the correctness and reliability of individual functions within a Bash script. While Bash is primarily used for scripting and automation, it’s important to ensure that the functions within your scripts work as expected, especially as scripts become more complex. Unit testing in Bash can help catch bugs and prevent unexpected behavior.\nFixing bugs Working on a bugfix for an internal shell script, I wanted to add some unit tests to ensure correctness. After a quick search, I found this single-file “framework” (thanks, Ryan) that provides xUnit-style assertions. So we can use it as a starting point.\nThe main problem with the script under test is that it contains functions that directly manipulates the host filesystem, so it can be hard to extract and mock those interactions for proper testing.\nSo I decided to use a simple container to run the script in an isolated environment. While we are at, no need for daemons, just use rootless podman. This is the main script, the only to be executed and which runs all the testsuites:\n#!/bin/bash # This script will run unit test for functions in file \"mylib\". # the tests are run in a container to ensure isolation from host system if [ \"$EUID\" -eq 0 ] then echo \"Please don't run this script as root\" exit fi # optionally, you can use different distro images here podman run -v ..:/mnt registry.opensuse.org/opensuse/leap:latest bash /mnt/unit_tests/test_mylib.ut Run your test without damaging your system Inside the test_mylib.ut itself, which is not executable, I added another safety check, so the user is aware that test script is safe to be run only inside a container:\n#!/bin/bash source \"/mnt/unit_tests/bunit.shl\" source \"/mnt/mylib.sh\" function testSetup() { [...] } function test_single() { [...] assertEquals 0 $? } function test_duplicate() { [...] local output=$( ... ) assertNull \"$output\" } ## safety check if [ \"$container\" != \"podman\" ]; then echo \"ERROR: this is script is not intended to be run directly.\" echo \"Don't run this script standalone/outside a container, it will break your system\" exit 0 else echo \"Starting test...\" runUnitTests fi Outro In conclusion, unit testing of Bash functions is an essential practice to ensure the reliability, correctness, and maintainability of your scripts. By creating comprehensive test suites and employing testing frameworks, developers can catch bugs early, improve code quality, and confidently make changes to their scripts. While testing Bash scripts might require additional considerations due to their interactions with external resources, the benefits of unit testing far outweigh the challenges, leading to more robust and predictable scripting solutions.\n","wordCount":"432","inLanguage":"en","datePublished":"2023-08-17T00:00:00Z","dateModified":"2023-08-17T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/unit_testing_bash_functions/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ilmanzo.github.io/archives/ title><span></span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ilmanzo.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ilmanzo.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">Using containers for unit testing of bash functions</h1><div class=post-description>How to create an isolate environment to safely test your bash scripts</div><div class=post-meta><span title='2023-08-17 00:00:00 +0000 UTC'>August 17, 2023</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><h2 id=intro>Intro<a hidden class=anchor aria-hidden=true href=#intro>#</a></h2><p>Unit testing of Bash functions involves the process of systematically verifying the correctness and reliability of individual functions within a Bash script. While Bash is primarily used for scripting and automation, it&rsquo;s important to ensure that the functions within your scripts work as expected, especially as scripts become more complex. Unit testing in Bash can help catch bugs and prevent unexpected behavior.</p><h2 id=fixing-bugs>Fixing bugs<a hidden class=anchor aria-hidden=true href=#fixing-bugs>#</a></h2><p>Working on a bugfix for an internal shell script, I wanted to add some unit tests to ensure correctness. After a quick search, I found this <a href=https://github.com/rafritts/bunit>single-file &ldquo;framework&rdquo;</a> (thanks, Ryan) that provides <em>xUnit</em>-style assertions. So we can use it as a starting point.</p><p>The main problem with the script under test is that it contains functions that directly manipulates the host filesystem, so it can be hard to extract and <em>mock</em> those interactions for proper testing.</p><p>So I decided to use a simple container to run the script in an isolated environment. While we are at, no need for daemons, just use rootless podman. This is the main script, the only to be executed and which runs all the testsuites:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># This script will run unit test for functions in file &#34;mylib&#34;.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># the tests are run in a container to ensure isolation from host system</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$EUID<span style=color:#e6db74>&#34;</span> -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>then</span> echo <span style=color:#e6db74>&#34;Please don&#39;t run this script as root&#34;</span>
</span></span><span style=display:flex><span>  exit
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#75715e># optionally, you can use different distro images here</span>
</span></span><span style=display:flex><span>podman run -v ..:/mnt registry.opensuse.org/opensuse/leap:latest bash /mnt/unit_tests/test_mylib.ut</span></span></code></pre></div><h2 id=run-your-test-without-damaging-your-system>Run your test without damaging your system<a hidden class=anchor aria-hidden=true href=#run-your-test-without-damaging-your-system>#</a></h2><p>Inside the <code>test_mylib.ut</code> itself, which is not executable, I added another safety check, so the user is aware that test script is safe to be run only inside a container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>source <span style=color:#e6db74>&#34;/mnt/unit_tests/bunit.shl&#34;</span>
</span></span><span style=display:flex><span>source <span style=color:#e6db74>&#34;/mnt/mylib.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> testSetup<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> test_single<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    assertEquals <span style=color:#ae81ff>0</span> $?
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> test_duplicate<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    local output<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span> ... <span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    assertNull <span style=color:#e6db74>&#34;</span>$output<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## safety check</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$container<span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;podman&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;ERROR: this is script is not intended to be run directly.&#34;</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;Don&#39;t run this script standalone/outside a container, it will break your system&#34;</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;Starting test...&#34;</span>
</span></span><span style=display:flex><span>  runUnitTests
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span></span></span></code></pre></div><h2 id=outro>Outro<a hidden class=anchor aria-hidden=true href=#outro>#</a></h2><p>In conclusion, unit testing of Bash functions is an essential practice to ensure the reliability, correctness, and maintainability of your scripts. By creating comprehensive test suites and employing testing frameworks, developers can catch bugs early, improve code quality, and confidently make changes to their scripts. While testing Bash scripts might require additional considerations due to their interactions with external resources, the benefits of unit testing far outweigh the challenges, leading to more robust and predictable scripting solutions.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/programming/>Programming</a></li><li><a href=https://ilmanzo.github.io/tags/bash/>Bash</a></li><li><a href=https://ilmanzo.github.io/tags/testing/>Testing</a></li><li><a href=https://ilmanzo.github.io/tags/test/>Test</a></li><li><a href=https://ilmanzo.github.io/tags/container/>Container</a></li><li><a href=https://ilmanzo.github.io/tags/podman/>Podman</a></li><li><a href=https://ilmanzo.github.io/tags/unit-testing/>Unit Testing</a></li></ul><nav class=paginav><a class=prev href=https://ilmanzo.github.io/post/quiet_thinkpad_fans/><span class=title>« Prev</span><br><span>Quiet fans on Thinkpad P15</span>
</a><a class=next href=https://ilmanzo.github.io/post/embed_git_commit_hash_in_build/><span class=title>Next »</span><br><span>Embed git commit hash into an executable</span></a></nav></footer></article></main><footer class=footer><span>© 2012-2024 Andrea Manzini</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>