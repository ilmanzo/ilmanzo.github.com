<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>integration between Python and Rust - Part 2 | ilManzo's blog</title><meta name=keywords content="python,Rust,linux,programming,learning"><meta name=description content="some experiments with language FFI"><meta name=author content="Andrea Manzini"><link rel=canonical href=https://ilmanzo.github.io/post/writing-python-modules-in-rust-2/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ilmanzo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ilmanzo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ilmanzo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ilmanzo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ilmanzo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PN4FTRLNL"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PN4FTRLNL",{anonymize_ip:!1})}</script><meta property="og:title" content="integration between Python and Rust - Part 2"><meta property="og:description" content="some experiments with language FFI"><meta property="og:type" content="article"><meta property="og:url" content="https://ilmanzo.github.io/post/writing-python-modules-in-rust-2/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-01-07T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="integration between Python and Rust - Part 2"><meta name=twitter:description content="some experiments with language FFI"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ilmanzo.github.io/post/"},{"@type":"ListItem","position":2,"name":"integration between Python and Rust - Part 2","item":"https://ilmanzo.github.io/post/writing-python-modules-in-rust-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"integration between Python and Rust - Part 2","name":"integration between Python and Rust - Part 2","description":"some experiments with language FFI","keywords":["python","Rust","linux","programming","learning"],"articleBody":"In this post we are going to write a new module for python: a very simple function exported from Rust that we can consume in the Python interpreter. We’ll leverage the PyO3 Rust bindings for the Python interpreter.\nLet’s start with a new Cargo project:\n$ cargo init --lib demo_rust_lib and insert the required settings in Cargo.toml:\n[package] name = \"rusty\" version = \"0.1.0\" edition = \"2021\" [lib] name=\"rusty\" crate-type = [\"cdylib\"] [dependencies.pyo3] version = \"*\" [features] extension-module = [\"pyo3/extension-module\"] default = [\"extension-module\"] now it’s a matter to write our library; luckily the PyO3 library exposes a lot of useful types for python interop; the only thing we need to add is an extra fn named as our module that “exports” the functions we want to make available in the Python layer:\n// this file is: src/lib.rs use pyo3::prelude::*; #[allow(dead_code)] #[pymodule] fn librusty(_py: Python, m: \u0026PyModule) -\u003e PyResult\u003c()\u003e { m.add_wrapped(wrap_pyfunction!(list_prod))?; Ok(()) } /// calc the product of N numbers in a list. #[pyfunction] fn list_prod(a: Vec\u003cisize\u003e) -\u003e PyResult\u003cisize\u003e { let mut prod: isize = 1; for i in a { prod *= i; } Ok(prod) } #[cfg(test)] mod tests { use super::*; #[test] fn test_list_product() { let input=vec![1,2,3,4]; let result=list_prod(input).unwrap_or(0); assert_eq!(result, 24); } } now compile the library with cargo build and also unit test are working, so you can run them with cargo test --no-default-features\nnow we need a trivial python program to test our library:\nimport sys,os # for development we include the rust build path to the path # that python looks for modules for p in (\"release\",\"debug\"): sys.path.append(os.path.join(\"target\",p)) # now this import can be resolved from librusty import list_prod result=list_prod([10,3,6]) print(result) The initial part requires a bit of setup because Python must be aware of Rust’s target folder to load the external module. For development is fine, but in the future we can skip this and publish the module as a real python package, installable from pip using the maturin tool from PyO3.\nRunning the sample program, we get the expected result:\n$ python3 use_rust_lib.py 180 we are starting to make interesting interactions between Python and Rust. The main purpose of this kind of project can be performance improvements, so next time we will do some benchmarks on the same function implemented in both and see the results.\nAll of the source code for this post is available on github\n","wordCount":"394","inLanguage":"en","datePublished":"2022-01-07T00:00:00Z","dateModified":"2022-01-07T00:00:00Z","author":{"@type":"Person","name":"Andrea Manzini"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ilmanzo.github.io/post/writing-python-modules-in-rust-2/"},"publisher":{"@type":"Organization","name":"ilManzo's blog","logo":{"@type":"ImageObject","url":"https://ilmanzo.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ilmanzo.github.io/ accesskey=h title="ilManzo's blog (Alt + H)">ilManzo's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ilmanzo.github.io/curriculum title=Curriculum><span>Curriculum</span></a></li><li><a href=https://ilmanzo.github.io/categories title=Categories><span>Categories</span></a></li><li><a href=https://ilmanzo.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://ilmanzo.github.io/post/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>integration between Python and Rust - Part 2</h1><div class=post-description>some experiments with language FFI</div><div class=post-meta><span title='2022-01-07 00:00:00 +0000 UTC'>January 7, 2022</span>&nbsp;·&nbsp;Andrea Manzini</div></header><div class=post-content><p>In this post we are going to write a new module for python: a very simple function exported from Rust that we can consume in the Python interpreter. We&rsquo;ll leverage the <a href=https://github.com/PyO3>PyO3</a> Rust bindings for the Python interpreter.</p><p>Let&rsquo;s start with a new Cargo project:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo init --lib demo_rust_lib</span></span></code></pre></div><p>and insert the required settings in <code>Cargo.toml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>package</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;rusty&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;0.1.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>edition</span> = <span style=color:#e6db74>&#34;2021&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>lib</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span>=<span style=color:#e6db74>&#34;rusty&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>crate-type</span> = [<span style=color:#e6db74>&#34;cdylib&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>dependencies</span>.<span style=color:#a6e22e>pyo3</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>features</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>extension-module</span> = [<span style=color:#e6db74>&#34;pyo3/extension-module&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>default</span> = [<span style=color:#e6db74>&#34;extension-module&#34;</span>]</span></span></code></pre></div><p>now it&rsquo;s a matter to write our library; luckily the PyO3 library exposes a lot of useful types for python interop; the only thing we need to add is an extra fn named as our module that &ldquo;exports&rdquo; the functions we want to make available in the Python layer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// this file is: src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> pyo3::prelude::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[pymodule]</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>librusty</span>(_py: <span style=color:#a6e22e>Python</span>, m: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>PyModule</span>) -&gt; <span style=color:#a6e22e>PyResult</span><span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>     m.add_wrapped(wrap_pyfunction!(list_prod))<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>     Ok(())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// calc the product of N numbers in a list.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[pyfunction]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>list_prod</span>(a: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>isize</span><span style=color:#f92672>&gt;</span>) -&gt; <span style=color:#a6e22e>PyResult</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>isize</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> prod: <span style=color:#66d9ef>isize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> a {
</span></span><span style=display:flex><span>        prod <span style=color:#f92672>*=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Ok(prod)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> tests {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>test_list_product</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> input<span style=color:#f92672>=</span>vec![<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> result<span style=color:#f92672>=</span>list_prod(input).unwrap_or(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        assert_eq!(result, <span style=color:#ae81ff>24</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>now compile the library with <code>cargo build</code> and also unit test are working, so you can run them with <code>cargo test --no-default-features</code></p><p>now we need a trivial python program to test our library:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys<span style=color:#f92672>,</span>os 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># for development we include the rust build path to the path</span>
</span></span><span style=display:flex><span><span style=color:#75715e># that python looks for modules</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> (<span style=color:#e6db74>&#34;release&#34;</span>,<span style=color:#e6db74>&#34;debug&#34;</span>):
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>append(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;target&#34;</span>,p))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># now this import can be resolved</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> librusty <span style=color:#f92672>import</span> list_prod
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>result<span style=color:#f92672>=</span>list_prod([<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>6</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(result)</span></span></code></pre></div><p>The initial part requires a bit of setup because Python must be aware of Rust&rsquo;s target folder to load the external module. For development is fine, but in the future we can skip this and publish the module as a real python package, installable from <strong>pip</strong> using the <a href=https://github.com/PyO3/maturin>maturin</a> tool from PyO3.</p><p>Running the sample program, we get the expected result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 use_rust_lib.py 
</span></span><span style=display:flex><span><span style=color:#ae81ff>180</span></span></span></code></pre></div><p>we are starting to make interesting interactions between Python and Rust. The main purpose of this kind of project can be performance improvements, so next time we will do some benchmarks on the same function implemented in both and see the results.</p><p>All of the source code for this post is available on <a href=https://github.com/ilmanzo/python-modules-in-rust>github</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ilmanzo.github.io/tags/python/>python</a></li><li><a href=https://ilmanzo.github.io/tags/rust/>Rust</a></li><li><a href=https://ilmanzo.github.io/tags/linux/>linux</a></li><li><a href=https://ilmanzo.github.io/tags/programming/>programming</a></li><li><a href=https://ilmanzo.github.io/tags/learning/>learning</a></li></ul></footer></article></main><footer class=footer><span>© 2012-2023 Andrea Manzini</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>