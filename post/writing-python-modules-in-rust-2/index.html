<!doctype html><html lang=en><head><title>integration between Python and Rust - Part 2 &ndash; ilManzo's blog</title><meta name=description content="A minimalist, pragmatic website and personal blog"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://ilmanzo.github.io/css/palettes/base16-dark.css><link rel=stylesheet href=https://ilmanzo.github.io/css/risotto.css><link rel=stylesheet href=https://ilmanzo.github.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://ilmanzo.github.io/ class=page__logo-inner>ilManzo's blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/curriculum title>Curriculum</a></li><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/categories title>Categories</a></li><li class=main-nav__item><a class=nav-main-item href=https://ilmanzo.github.io/tags title>Tags</a></li><li class=main-nav__item><a class="nav-main-item active" href=https://ilmanzo.github.io/post/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>integration between Python and Rust - Part 2</h1></header><div class=content__body><p>In this post we are going to write a new module for python: a very simple function exported from Rust that we can consume in the Python interpreter. We&rsquo;ll leverage the <a href=https://github.com/PyO3>PyO3</a> Rust bindings for the Python interpreter.</p><p>Let&rsquo;s start with a new Cargo project:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo init --lib demo_rust_lib</span></span></code></pre></div><p>and insert the required settings in <code>Cargo.toml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>package</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;rusty&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;0.1.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>edition</span> = <span style=color:#e6db74>&#34;2021&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>lib</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span>=<span style=color:#e6db74>&#34;rusty&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>crate-type</span> = [<span style=color:#e6db74>&#34;cdylib&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>dependencies</span>.<span style=color:#a6e22e>pyo3</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>features</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>extension-module</span> = [<span style=color:#e6db74>&#34;pyo3/extension-module&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>default</span> = [<span style=color:#e6db74>&#34;extension-module&#34;</span>]</span></span></code></pre></div><p>now it&rsquo;s a matter to write our library; luckily the PyO3 library exposes a lot of useful types for python interop; the only thing we need to add is an extra fn named as our module that &ldquo;exports&rdquo; the functions we want to make available in the Python layer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// this file is: src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> pyo3::prelude::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[pymodule]</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>librusty</span>(_py: <span style=color:#a6e22e>Python</span>, m: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>PyModule</span>) -&gt; <span style=color:#a6e22e>PyResult</span><span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>     m.add_wrapped(wrap_pyfunction<span style=color:#f92672>!</span>(list_prod))<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>     Ok(())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/// calc the product of N numbers in a list.
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[pyfunction]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>list_prod</span>(a: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>isize</span><span style=color:#f92672>&gt;</span>) -&gt; <span style=color:#a6e22e>PyResult</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>isize</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> prod: <span style=color:#66d9ef>isize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> a {
</span></span><span style=display:flex><span>        prod <span style=color:#f92672>*=</span> i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Ok(prod)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[cfg(test)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> tests {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[test]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>test_list_product</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> input<span style=color:#f92672>=</span>vec![<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> result<span style=color:#f92672>=</span>list_prod(input).unwrap_or(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        assert_eq!(result, <span style=color:#ae81ff>24</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>now compile the library with <code>cargo build</code> and also unit test are working, so you can run them with <code>cargo test --no-default-features</code></p><p>now we need a trivial python program to test our library:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys<span style=color:#f92672>,</span>os 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># for development we include the rust build path to the path</span>
</span></span><span style=display:flex><span><span style=color:#75715e># that python looks for modules</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> (<span style=color:#e6db74>&#34;release&#34;</span>,<span style=color:#e6db74>&#34;debug&#34;</span>):
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>append(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;target&#34;</span>,p))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># now this import can be resolved</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> librusty <span style=color:#f92672>import</span> list_prod
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>result<span style=color:#f92672>=</span>list_prod([<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>6</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(result)</span></span></code></pre></div><p>The initial part requires a bit of setup because Python must be aware of Rust&rsquo;s target folder to load the external module. For development is fine, but in the future we can skip this and publish the module as a real python package, installable from <strong>pip</strong> using the <a href=https://github.com/PyO3/maturin>maturin</a> tool from PyO3.</p><p>Running the sample program, we get the expected result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 use_rust_lib.py 
</span></span><span style=display:flex><span><span style=color:#ae81ff>180</span></span></span></code></pre></div><p>we are starting to make interesting interactions between Python and Rust. The main purpose of this kind of project can be performance improvements, so next time we will do some benchmarks on the same function implemented in both and see the results.</p><p>All of the source code for this post is available on <a href=https://github.com/ilmanzo/python-modules-in-rust>github</a></p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://ilmanzo.github.io/images/rice.svg alt=Logo><h1 class=about__title>Andrea Manzini</h1><p class=about__description>A minimalist, pragmatic website and personal blog</p></div><ul class=aside__social-links><li><a href=https://github.com/ilmanzo rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:ilmanzo@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://www.linkedin.com/in/andreamanzini rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://twitter.com/ilmanzo rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a>&nbsp;</li><li><a href=https://ilmanzo.github.io/index.xml rel=me aria-label="RSS Feed" title="RSS Feed"><i class="fas fa-rss-square" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>some experiments with language FFI</p><p>By Andrea Manzini,
2022-01-07</p></div></section><footer class=page__footer><p></p><br><br><p class=copyright>Â© 2022 Andrea Manzini</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>